<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#000000">
    <title>HAz Construction PM System | Saudi Arabia</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #000000;
            --primary-dark: #1a1a1a;
            --secondary: #333333;
            --accent: #555555;
            --background: #f5f5f5;
            --card: #ffffff;
            --text: #000000;
            --text-light: #666666;
            --success: #2d2d2d;
            --warning: #4a4a4a;
            --danger: #8b0000;
            --border: #e0e0e0;
            --gradient-start: #000000;
            --gradient-end: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
            -webkit-tap-highlight-color: transparent;
        }

        body.crew-mode {
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 300;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            filter: invert(1);
        }

        /* Language Toggle */
        .lang-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.95);
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lang-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }

        .lang-toggle .lang-icon {
            font-size: 1.2rem;
        }

        .lang-toggle .lang-text {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }

        .lang-toggle .lang-switch {
            width: 50px;
            height: 26px;
            background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);
            border-radius: 13px;
            position: relative;
            transition: all 0.3s ease;
        }

        .lang-toggle .lang-switch::before {
            content: 'EN';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .lang-toggle.arabic .lang-switch {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .lang-toggle.arabic .lang-switch::before {
            content: 'Ø¹';
            left: calc(100% - 26px);
            font-size: 0.7rem;
        }

        /* RTL Support */
        html[dir="rtl"] {
            direction: rtl;
        }

        html[dir="rtl"] body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, 'Arial', sans-serif;
        }

        html[dir="rtl"] .lang-toggle {
            right: auto;
            left: 20px;
        }

        html[dir="rtl"] .form-section {
            border-left: none;
            border-right: 4px solid var(--primary);
        }

        html[dir="rtl"] .evm-info {
            border-left: none;
            border-right: 4px solid var(--primary);
        }

        html[dir="rtl"] .work-item-card {
            border-left: none;
            border-right: 5px solid #1e40af;
        }

        html[dir="rtl"] .progress-item-card {
            border-left: none;
            border-right: 2px solid #0ea5e9;
        }

        html[dir="rtl"] .crew-info-banner {
            text-align: right;
        }

        html[dir="rtl"] .item-header,
        html[dir="rtl"] .work-item-header,
        html[dir="rtl"] .progress-item-header {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .tab-btn {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .submit-btn {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .add-btn {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .summary-card {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .legend-item {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .gps-option {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .settings-toggle {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .subcontractor-toggle {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .progress-subcontractor-toggle {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] input,
        html[dir="rtl"] select,
        html[dir="rtl"] textarea {
            text-align: right;
        }

        html[dir="rtl"] input[type="number"] {
            text-align: left;
            direction: ltr;
        }

        html[dir="rtl"] input[type="date"],
        html[dir="rtl"] input[type="time"],
        html[dir="rtl"] input[type="tel"] {
            text-align: left;
            direction: ltr;
        }

        html[dir="rtl"] .histogram-legend {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .link-info {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .section-header-row {
            flex-direction: row-reverse;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 15px 30px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-card {
            background: var(--card);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            border: 1px solid var(--border);
        }

        .form-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        .form-group label span {
            color: var(--danger);
            font-weight: 400;
            font-size: 0.85rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--background);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-section {
            grid-column: 1 / -1;
            background: var(--background);
            padding: 20px;
            border-radius: 12px;
            margin: 10px 0;
            border: 1px solid var(--border);
        }

        .form-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .form-section .form-grid {
            margin-top: 15px;
        }

        .submit-btn {
            grid-column: 1 / -1;
            padding: 18px 40px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            background: var(--secondary);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .add-btn {
            padding: 12px 25px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .add-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .remove-btn {
            padding: 8px 15px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #a00000;
        }

        .dynamic-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid var(--border);
            position: relative;
        }

        .dynamic-item .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .dynamic-item .item-number {
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
        }

        /* Work Items Section Styles */
        .work-items-section .section-hint {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .work-item-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .work-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .work-item-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .remove-work-item-btn {
            padding: 8px 15px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-work-item-btn:hover {
            background: #a00000;
        }

        .work-item-info {
            margin-bottom: 20px;
        }

        .work-item-manpower,
        .work-item-equipment {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .work-item-manpower h4,
        .work-item-equipment h4 {
            font-size: 1rem;
            color: var(--secondary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border);
        }

        .work-item-manpower .dynamic-item,
        .work-item-equipment .dynamic-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 10px;
        }

        .add-resource-btn {
            padding: 10px 20px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .work-item-subtotal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            margin-top: 15px;
        }

        .item-subtotal-value {
            font-size: 1.2rem;
        }

        .add-work-item-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
            font-size: 1rem;
        }

        .add-work-item-btn:hover {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
        }

        /* Weekly Progress Report Styles */
        .progress-items-section .section-header-row,
        .histogram-section .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        .import-daily-btn,
        .refresh-chart-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .import-daily-btn:hover,
        .refresh-chart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .progress-item-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.1);
        }

        .progress-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #0ea5e9;
        }

        .progress-item-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0369a1;
        }

        .remove-progress-item-btn {
            padding: 8px 15px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-subcontractor-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 15px 0;
        }

        .progress-subcontractor-fields {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px dashed #cbd5e1;
        }

        .progress-quantities,
        .progress-costs {
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .progress-quantities h4,
        .progress-costs h4 {
            font-size: 1rem;
            color: #0369a1;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #e0e7ff;
        }

        .daily-qty-input {
            background: #ecfdf5 !important;
        }

        .adjust-qty-input {
            background: #fef3c7 !important;
        }

        .final-qty-input {
            background: #dbeafe !important;
            font-weight: 600;
        }

        .ev-input {
            background: #dcfce7 !important;
            font-weight: 600;
            color: #166534;
        }

        .ac-daily-input {
            background: #ecfdf5 !important;
            font-weight: 600;
            color: #166534;
        }

        .ac-adjust-input {
            background: #fef3c7 !important;
        }

        .ac-final-input {
            background: #fce7f3 !important;
            font-weight: 600;
            color: #9d174d;
        }

        .cv-input {
            font-weight: 600;
        }

        .cv-input.positive {
            background: #dcfce7 !important;
            color: #166534;
        }

        .cv-input.negative {
            background: #fee2e2 !important;
            color: #dc2626;
        }

        .completion-pct-input {
            background: #f3e8ff !important;
            font-weight: 600;
            color: #7c3aed;
        }

        .progress-item-summary {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #0369a1 0%, #0284c7 100%);
            border-radius: 10px;
            color: white;
        }

        .progress-item-summary .summary-item {
            flex: 1;
            text-align: center;
        }

        .progress-item-summary .summary-label {
            font-size: 0.85rem;
            opacity: 0.9;
            display: block;
            margin-bottom: 5px;
        }

        .progress-item-summary .summary-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .progress-item-summary .cv-value.positive {
            color: #86efac;
        }

        .progress-item-summary .cv-value.negative {
            color: #fca5a5;
        }

        .add-progress-item-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            font-size: 1rem;
        }

        /* Weekly Summary Cards */
        .weekly-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .summary-card .summary-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
        }

        .summary-card .summary-content {
            flex: 1;
        }

        .summary-card .summary-title {
            font-size: 0.85rem;
            color: var(--text-light);
            display: block;
            margin-bottom: 5px;
        }

        .summary-card .summary-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .summary-card.variance-card .summary-amount.positive {
            color: #16a34a;
        }

        .summary-card.variance-card .summary-amount.negative {
            color: #dc2626;
        }

        /* Histogram Styles */
        .histogram-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
            border: 1px solid var(--border);
            margin-top: 15px;
        }

        .histogram-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 250px;
            color: var(--text-light);
        }

        .histogram-placeholder span {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 15px;
        }

        .histogram-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 250px;
            padding: 20px 10px;
            gap: 10px;
        }

        .histogram-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 100px;
        }

        .histogram-bar {
            width: 100%;
            max-width: 60px;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
            min-height: 20px;
        }

        .histogram-bar.positive {
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);
        }

        .histogram-bar.negative {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        }

        .histogram-bar:hover {
            transform: scaleX(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .histogram-bar-value {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 5px;
            text-align: center;
        }

        .histogram-bar-label {
            font-size: 0.7rem;
            color: var(--text-light);
            text-align: center;
            margin-top: 8px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .histogram-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.positive {
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);
        }

        .legend-color.negative {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        }

        .evm-info {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }

        .evm-info h4 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .evm-info ul {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .evm-info li {
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
        }

        .evm-info li strong {
            color: var(--primary);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            display: none;
            animation: slideDown 0.5s ease;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .notification.success {
            background: var(--primary);
        }

        .notification.error {
            background: var(--danger);
        }

        .calculated-fields {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f0f0f0 0%, #e8e8e8 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            display: none;
        }

        .calculated-fields.show {
            display: block;
        }

        .calculated-fields h4 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .calc-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .calc-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .calc-item .label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 5px;
        }

        .calc-item.good { border-bottom: 3px solid #2d5016; }
        .calc-item.warning { border-bottom: 3px solid #8b6914; }
        .calc-item.bad { border-bottom: 3px solid var(--danger); }

        .config-section {
            background: var(--card);
            border-radius: 16px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid var(--border);
        }

        .config-section h3 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        .config-group {
            margin-bottom: 20px;
        }

        .config-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .config-group input {
            width: 100%;
            max-width: 500px;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .total-display {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        .total-display .total-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .total-display .total-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .footer {
            text-align: center;
            color: rgba(255,255,255,0.7);
            padding: 30px 0;
            font-size: 0.9rem;
        }

        .footer img {
            width: 40px;
            height: 40px;
            filter: invert(1);
            margin-bottom: 10px;
        }

        .sub-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .sub-section h4 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }

        /* Location Type Toggle */
        .location-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .location-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .location-toggle input[type="radio"] {
            width: auto;
            accent-color: var(--primary);
        }

        .location-toggle label:has(input:checked) {
            border-color: var(--primary);
            background: rgba(0,0,0,0.05);
        }

        .station-fields, .mh-fields {
            display: none;
        }

        .station-fields.active, .mh-fields.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* KMZ Section Styles */
        .kmz-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
        }

        .kmz-section h4 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }

        .kmz-input-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .kmz-input-group .form-group {
            flex: 1;
            min-width: 250px;
        }

        .kmz-buttons {
            display: flex;
            gap: 10px;
        }

        .upload-kmz-btn {
            padding: 14px 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .upload-kmz-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .upload-kmz-btn input[type="file"] {
            display: none;
        }

        .open-kmz-btn {
            padding: 14px 20px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .open-kmz-btn:hover {
            background: #1557b0;
            transform: translateY(-2px);
        }

        .kmz-hint {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .kmz-file-name {
            display: none;
            margin-top: 10px;
            padding: 10px 15px;
            background: #e8f5e9;
            border-radius: 8px;
            color: #2e7d32;
            font-size: 0.9rem;
            align-items: center;
            gap: 10px;
        }

        .kmz-file-name.show {
            display: flex;
        }

        .kmz-file-name .remove-file {
            margin-left: auto;
            background: none;
            border: none;
            color: #c62828;
            cursor: pointer;
            font-size: 1.1rem;
        }

        /* GPS Location Section */
        .gps-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border);
        }

        .gps-section h4 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 600;
        }

        .gps-capture-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .get-location-btn {
            padding: 14px 25px;
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .get-location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(66, 133, 244, 0.4);
        }

        .get-location-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .location-status {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .location-status.success {
            color: #2e7d32;
        }

        .location-status.error {
            color: #c62828;
        }

        .map-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .map-link-btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .map-link-btn.google {
            background: #ea4335;
            color: white;
        }

        .map-link-btn.google:hover {
            background: #c5221f;
            transform: translateY(-2px);
        }

        .map-link-btn.earth {
            background: #4285f4;
            color: white;
        }

        .map-link-btn.earth:hover {
            background: #1a73e8;
            transform: translateY(-2px);
        }

        /* GPS Options Buttons */
        .gps-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .gps-option-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .gps-option-btn:hover {
            border-color: #4285f4;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(66, 133, 244, 0.2);
        }

        .gps-option-btn:active {
            transform: translateY(0);
        }

        .gps-option-btn .gps-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .gps-option-btn .gps-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .gps-option-btn .gps-desc {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Map Picker Modal */
        .map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .map-modal.show {
            display: flex;
        }

        .map-modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .map-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
            color: white;
            flex-shrink: 0;
        }

        .map-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .map-modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .map-modal-body {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            min-height: 0;
        }

        .map-search-box {
            display: flex;
            gap: 10px;
        }

        .map-search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .map-search-box input:focus {
            outline: none;
            border-color: #4285f4;
        }

        .map-search-box button {
            padding: 12px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-search-box button:hover {
            background: #1a73e8;
        }

        .map-container {
            flex: 1;
            min-height: 400px;
            height: 400px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .map-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: #ea4335;
            text-shadow: 
                -2px -2px 0 #fff,  
                2px -2px 0 #fff,
                -2px 2px 0 #fff,
                2px 2px 0 #fff,
                0 0 10px rgba(0,0,0,0.5);
            pointer-events: none;
            z-index: 100;
            font-weight: bold;
        }

        .map-instructions {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.85rem;
            z-index: 100;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .map-coordinates {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .coord-input {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 150px;
        }

        .coord-input label {
            font-weight: 600;
            color: var(--text-light);
            min-width: 35px;
        }

        .coord-input input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .coord-input input:focus {
            outline: none;
            border-color: #4285f4;
        }

        .coord-go-btn {
            padding: 10px 20px;
            background: #34a853;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .coord-go-btn:hover {
            background: #2d8e47;
        }

        .map-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 20px;
            border-top: 1px solid var(--border);
            background: #f8f9fa;
        }

        .map-cancel-btn {
            padding: 12px 25px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-cancel-btn:hover {
            background: #5a6268;
        }

        .map-confirm-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #34a853 0%, #2d8e47 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 168, 83, 0.4);
        }

        /* Mobile adjustments for map modal */
        @media (max-width: 767px) {
            .gps-options {
                grid-template-columns: 1fr;
            }

            .gps-option-btn {
                padding: 15px;
                flex-direction: row;
                gap: 15px;
                text-align: left;
            }

            .gps-option-btn .gps-icon {
                font-size: 1.5rem;
                margin-bottom: 0;
            }

            .map-modal {
                padding: 10px;
            }

            .map-modal-content {
                max-height: 95vh;
            }

            .map-modal-header {
                padding: 15px;
            }

            .map-modal-header h3 {
                font-size: 1rem;
            }

            .map-modal-body {
                padding: 10px;
            }

            .map-search-box {
                flex-direction: column;
            }

            .map-search-box button {
                width: 100%;
            }

            .map-container {
                min-height: 300px;
                height: 300px;
            }

            .map-instructions {
                font-size: 0.75rem;
                padding: 8px 15px;
                white-space: normal;
                text-align: center;
                max-width: 90%;
            }

            .map-coordinates {
                flex-direction: column;
            }

            .coord-input {
                width: 100%;
            }

            .coord-go-btn {
                width: 100%;
            }

            .map-modal-footer {
                flex-direction: column;
                gap: 10px;
            }

            .map-cancel-btn,
            .map-confirm-btn {
                width: 100%;
            }
        }

        /* Summary & Preview Section */
        .summary-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }

        .preview-btn {
            padding: 14px 30px;
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .preview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(108, 92, 231, 0.4);
        }

        .preview-content {
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .preview-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .preview-card h4 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            font-size: 1rem;
        }

        .preview-table {
            max-height: 200px;
            overflow-y: auto;
        }

        .preview-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }

        .preview-row:last-child {
            border-bottom: none;
        }

        .preview-row .item-name {
            color: var(--text);
            flex: 1;
        }

        .preview-row .item-details {
            color: var(--text-light);
            text-align: right;
            margin: 0 10px;
        }

        .preview-row .item-cost {
            color: var(--primary);
            font-weight: 600;
            min-width: 80px;
            text-align: right;
        }

        .preview-total {
            display: flex;
            justify-content: space-between;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid var(--primary);
            font-size: 1.1rem;
        }

        .preview-total strong {
            color: var(--primary);
        }

        .manpower-card {
            border-left: 4px solid #4285f4;
        }

        .equipment-card {
            border-left: 4px solid #fbbc04;
        }

        .location-card {
            border-left: 4px solid #34a853;
        }

        .grand-total-card {
            border-left: 4px solid #ea4335;
            background: linear-gradient(135deg, #fff 0%, #ffeaea 100%);
        }

        .grand-total-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            padding: 20px 0;
        }

        .location-preview-item {
            padding: 8px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .location-preview-item .icon {
            font-size: 1.2rem;
        }

        .location-preview-map {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .location-preview-map a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1a73e8;
            text-decoration: none;
            font-weight: 600;
        }

        .location-preview-map a:hover {
            text-decoration: underline;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 25px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        /* Crew Submissions List */
        .crew-submissions-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
            max-height: 300px;
            overflow-y: auto;
        }

        .crew-submissions-list .no-submissions {
            color: var(--text-light);
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .crew-submission-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            background: #fafafa;
        }

        .crew-submission-item:last-child {
            margin-bottom: 0;
        }

        .crew-submission-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .crew-submission-header h5 {
            color: var(--primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .crew-submission-header .crew-cost {
            font-weight: 700;
            color: #2e7d32;
        }

        .crew-submission-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
        }

        .crew-submission-details span {
            color: var(--text-light);
        }

        .crew-submission-location {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
        }

        .crew-submission-location a {
            color: #1a73e8;
            text-decoration: none;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .crew-submission-location a:hover {
            text-decoration: underline;
        }

        /* Crew Link Section */
        .crew-link-section {
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0fa 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #2563eb;
            margin-top: 20px;
        }

        .crew-link-section h4 {
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .generate-link-btn {
            padding: 12px 25px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .generate-link-btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .generated-link {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .generated-link.show {
            display: block;
        }

        .link-input-group {
            display: flex;
            gap: 10px;
        }

        .link-input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--background);
        }

        .copy-btn {
            padding: 12px 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--primary);
        }

        /* Link Options Styles */
        .link-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .link-option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .link-option-group label {
            font-weight: 600;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .link-option-group select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
        }

        .link-option-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .link-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .link-info-item {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .link-info-item strong {
            color: var(--text);
        }

        /* Subcontractor Section Styles */
        .work-item-subcontractor {
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .work-item-subcontractor h4 {
            font-size: 1rem;
            color: #b45309;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #f59e0b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .optional-badge {
            font-size: 0.75rem;
            font-weight: normal;
            color: #92400e;
            background: rgba(245, 158, 11, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .subcontractor-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #f59e0b;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .work-item-subcontractor .dynamic-item {
            background: white;
            border: 1px solid #fcd34d;
        }

        .work-item-subcontractor .item-manpower-container,
        .work-item-subcontractor .item-subcontractor-container {
            margin-bottom: 10px;
        }

        .subcontractor-expenses {
            background: #ecfdf5 !important;
        }

        .subcontractor-deductions {
            background: #fee2e2 !important;
        }

        .subcontractor-amount {
            background: #fef3c7 !important;
            font-weight: 600;
            color: #92400e;
        }

        /* Crew Form Styles */
        .crew-info-banner {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .crew-info-banner h3 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .crew-info-banner p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .crew-info-banner .project-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        .crew-info-banner .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .crew-info-banner .detail-label {
            font-size: 0.8rem;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .crew-info-banner .detail-value {
            font-weight: 600;
            font-size: 1rem;
        }

        /* ========== RESPONSIVE DESIGN ========== */
        
        /* Large Desktop (1200px+) */
        @media (min-width: 1200px) {
            .container {
                max-width: 1200px;
            }
            
            .form-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .preview-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Desktop/Laptop (992px - 1199px) */
        @media (max-width: 1199px) {
            .container {
                max-width: 960px;
            }
            
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Tablet (768px - 991px) */
        @media (max-width: 991px) {
            .container {
                max-width: 720px;
                padding: 0 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }
            
            .tabs {
                gap: 8px;
            }
            
            .tab-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .form-card {
                padding: 25px;
            }
            
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .preview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .crew-info-banner .project-details {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Mobile (576px - 767px) */
        @media (max-width: 767px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
                padding: 0 10px;
            }
            
            .header {
                padding: 20px 0;
            }
            
            .header h1 {
                font-size: 1.5rem;
                letter-spacing: 1px;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .logo {
                width: 50px;
                height: 50px;
            }
            
            .tabs {
                flex-direction: column;
                gap: 8px;
            }
            
            .tab-btn {
                width: 100%;
                justify-content: center;
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .form-card {
                padding: 15px;
                border-radius: 12px;
            }
            
            .form-title {
                font-size: 1.3rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .form-group label {
                font-size: 0.85rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px 12px;
                font-size: 0.95rem;
            }
            
            .form-section {
                padding: 15px;
                margin: 15px 0;
            }
            
            .form-section h3 {
                font-size: 1.1rem;
            }
            
            .station-fields.active, 
            .mh-fields.active {
                grid-template-columns: 1fr;
            }
            
            .location-toggle {
                flex-direction: column;
                gap: 10px;
            }
            
            .location-toggle label {
                width: 100%;
                justify-content: flex-start;
            }
            
            .gps-section {
                padding: 15px;
            }
            
            .gps-capture-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .get-location-btn {
                width: 100%;
            }
            
            .map-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .map-link-btn {
                width: 100%;
                text-align: center;
            }
            
            .kmz-input-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .kmz-buttons {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .upload-kmz-btn,
            .open-kmz-btn {
                width: 100%;
                text-align: center;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
            }
            
            .preview-card {
                padding: 15px;
            }
            
            .preview-row {
                flex-direction: column;
                gap: 5px;
                padding: 8px 0;
            }
            
            .preview-row .item-cost {
                font-size: 1rem;
            }
            
            .export-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .export-btn {
                width: 100%;
            }
            
            .crew-link-section {
                padding: 15px;
            }
            
            .link-input-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .link-input-group input {
                width: 100%;
            }
            
            .copy-btn {
                width: 100%;
            }
            
            .generate-link-btn {
                width: 100%;
            }
            
            .crew-info-banner {
                padding: 15px;
            }
            
            .crew-info-banner h3 {
                font-size: 1.1rem;
            }
            
            .crew-info-banner .project-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .dynamic-item {
                padding: 12px;
            }
            
            .item-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .remove-btn {
                width: 100%;
            }
            
            .add-btn {
                width: 100%;
            }
            
            .submit-btn {
                padding: 15px 20px;
                font-size: 1rem;
            }
            
            .total-display {
                padding: 15px;
            }
            
            .total-value {
                font-size: 1.5rem;
            }
            
            .crew-submissions-list {
                padding: 10px;
            }
            
            .crew-submission-item {
                padding: 12px;
            }
            
            .crew-submission-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .crew-submission-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            /* Work Items Mobile Styles */
            .work-item-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .work-item-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .work-item-title {
                font-size: 1.1rem;
            }

            .remove-work-item-btn {
                width: 100%;
            }

            .work-item-info .form-grid {
                grid-template-columns: 1fr;
            }

            .work-item-info .form-group[style*="span 2"] {
                grid-column: 1 !important;
            }

            .work-item-manpower,
            .work-item-equipment,
            .work-item-subcontractor {
                padding: 12px;
            }

            .work-item-manpower h4,
            .work-item-equipment h4,
            .work-item-subcontractor h4 {
                font-size: 0.95rem;
                flex-wrap: wrap;
            }

            .work-item-subtotal {
                padding: 12px 15px;
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }

            .add-resource-btn {
                width: 100%;
            }

            .add-work-item-btn {
                padding: 15px;
                font-size: 0.95rem;
            }
            
            /* Link Options Mobile */
            .link-options {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .link-info {
                flex-direction: column;
                gap: 8px;
            }
            
            .link-info-item {
                font-size: 0.8rem;
            }
            
            /* Subcontractor Toggle Mobile */
            .subcontractor-toggle {
                flex-wrap: wrap;
            }
            
            .optional-badge {
                font-size: 0.65rem;
            }
            
            /* Weekly Report Mobile Styles */
            .progress-items-section .section-header-row,
            .histogram-section .section-header-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .import-daily-btn,
            .refresh-chart-btn {
                width: 100%;
                justify-content: center;
            }
            
            .progress-item-card {
                padding: 15px;
            }
            
            .progress-item-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .remove-progress-item-btn {
                width: 100%;
            }
            
            .progress-quantities,
            .progress-costs {
                padding: 12px;
            }
            
            .progress-item-summary {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
            }
            
            .weekly-summary-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .summary-card {
                padding: 15px;
            }
            
            .summary-card .summary-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .summary-card .summary-amount {
                font-size: 1.2rem;
            }
            
            .histogram-container {
                padding: 15px;
                min-height: 250px;
            }
            
            .histogram-chart {
                height: 200px;
                padding: 15px 5px;
                gap: 5px;
            }
            
            .histogram-bar-container {
                max-width: 60px;
            }
            
            .histogram-bar {
                max-width: 40px;
            }
            
            .histogram-bar-value {
                font-size: 0.65rem;
            }
            
            .histogram-bar-label {
                font-size: 0.6rem;
                max-width: 50px;
            }
            
            .histogram-legend {
                flex-direction: column;
                gap: 10px;
            }
            
            .legend-item {
                font-size: 0.8rem;
            }
            
            /* Settings Modal */
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            /* EVM Section */
            .evm-grid {
                grid-template-columns: 1fr;
            }
            
            .evm-item {
                padding: 12px;
            }
        }
        
        /* Small Mobile (<576px) */
        @media (max-width: 575px) {
            body {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .form-card {
                padding: 12px;
                border-radius: 8px;
            }
            
            .form-title {
                font-size: 1.1rem;
            }
            
            .form-section {
                padding: 12px;
                margin: 10px 0;
            }
            
            .form-section h3 {
                font-size: 1rem;
            }
            
            .tab-btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .grand-total-value {
                font-size: 1.5rem;
            }
            
            .total-value {
                font-size: 1.3rem;
            }
            
            .notification {
                font-size: 0.85rem;
                padding: 12px 15px;
                left: 10px;
                right: 10px;
                bottom: 10px;
                transform: none;
                max-width: none;
            }
        }
        
        /* Touch-friendly improvements for all mobile */
        @media (max-width: 991px) {
            /* Increase touch target sizes */
            input[type="radio"],
            input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }
            
            select {
                min-height: 44px;
            }
            
            button {
                min-height: 44px;
            }
            
            /* Prevent zoom on input focus (iOS) */
            input[type="text"],
            input[type="number"],
            input[type="date"],
            input[type="email"],
            input[type="tel"],
            select,
            textarea {
                font-size: 16px;
            }
        }
        
        /* Landscape mobile */
        @media (max-width: 767px) and (orientation: landscape) {
            .header {
                padding: 10px 0;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .tab-btn {
                width: auto;
                flex: 1;
                min-width: 120px;
            }
        }
        
        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .header,
            .tabs,
            .submit-btn,
            .add-btn,
            .remove-btn,
            .generate-link-btn,
            .crew-link-section,
            .export-buttons {
                display: none;
            }
            
            .form-card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* =============================================
           AUTHENTICATION SYSTEM STYLES
           ============================================= */
        
        /* Auth Container - Full screen overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
            animation: authSlideIn 0.5s ease;
        }

        @keyframes authSlideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-header {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .auth-header img {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            filter: invert(1);
        }

        .auth-header h1 {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .auth-header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .auth-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .auth-tab:hover {
            color: #333;
            background: rgba(0,0,0,0.05);
        }

        .auth-tab.active {
            color: #000;
            background: white;
        }

        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #000;
        }

        .auth-form-container {
            padding: 30px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .auth-input-group {
            margin-bottom: 20px;
        }

        .auth-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .auth-input-group input,
        .auth-input-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .auth-input-group input:focus,
        .auth-input-group select:focus {
            outline: none;
            border-color: #000;
            background: white;
            box-shadow: 0 0 0 4px rgba(0,0,0,0.1);
        }

        .auth-input-group .input-icon {
            position: relative;
        }

        .auth-input-group .input-icon input {
            padding-left: 45px;
        }

        .auth-input-group .input-icon span {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-btn-primary {
            background: linear-gradient(135deg, #000 0%, #333 100%);
            color: white;
        }

        .auth-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .auth-btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: #999;
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .auth-divider span {
            padding: 0 15px;
        }

        .auth-footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
            margin-top: 20px;
        }

        .auth-footer a {
            color: #000;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .auth-error.show {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .auth-success {
            background: #dcfce7;
            color: #16a34a;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .auth-success.show {
            display: block;
        }

        /* Password strength indicator */
        .password-strength {
            height: 4px;
            border-radius: 2px;
            margin-top: 8px;
            background: #e0e0e0;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
        }

        .password-strength-bar.weak { width: 33%; background: #ef4444; }
        .password-strength-bar.medium { width: 66%; background: #f59e0b; }
        .password-strength-bar.strong { width: 100%; background: #22c55e; }

        /* User Menu */
        .user-menu {
            position: fixed;
            top: 20px;
            right: 80px;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        html[dir="rtl"] .user-menu {
            right: auto;
            left: 80px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #000 0%, #333 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        .user-avatar.admin {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }

        .user-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 220px;
            display: none;
            overflow: hidden;
            z-index: 1000;
        }

        html[dir="rtl"] .user-dropdown {
            right: auto;
            left: 0;
        }

        .user-dropdown.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-dropdown-header {
            padding: 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-dropdown-header .user-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .user-dropdown-header .user-email {
            font-size: 0.8rem;
            color: #666;
        }

        .user-dropdown-header .user-role {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
        }

        .user-dropdown-header .user-role.admin {
            background: #fee2e2;
            color: #dc2626;
        }

        .user-dropdown-header .user-role.user {
            background: #dbeafe;
            color: #2563eb;
        }

        .user-dropdown-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            color: #333;
        }

        html[dir="rtl"] .user-dropdown-item {
            text-align: right;
            flex-direction: row-reverse;
        }

        .user-dropdown-item:hover {
            background: #f5f5f5;
        }

        .user-dropdown-item.danger {
            color: #dc2626;
        }

        .user-dropdown-item.danger:hover {
            background: #fee2e2;
        }

        /* Admin Panel Styles */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .admin-stat-icon.users { background: #dbeafe; }
        .admin-stat-icon.active { background: #dcfce7; }
        .admin-stat-icon.pending { background: #fef3c7; }
        .admin-stat-icon.blocked { background: #fee2e2; }

        .admin-stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        .admin-stat-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .admin-users-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .admin-table-header {
            padding: 20px 25px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-table-header h3 {
            font-size: 1.2rem;
            color: #333;
        }

        .admin-search {
            display: flex;
            gap: 10px;
        }

        .admin-search input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            min-width: 250px;
        }

        .admin-search input:focus {
            outline: none;
            border-color: #000;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        html[dir="rtl"] .users-table th,
        html[dir="rtl"] .users-table td {
            text-align: right;
        }

        .users-table th {
            background: #fafafa;
            font-weight: 600;
            color: #666;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .users-table tr:hover td {
            background: #fafafa;
        }

        .user-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .user-status.active {
            background: #dcfce7;
            color: #16a34a;
        }

        .user-status.pending {
            background: #fef3c7;
            color: #d97706;
        }

        .user-status.blocked {
            background: #fee2e2;
            color: #dc2626;
        }

        .user-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-action-btn.approve {
            background: #dcfce7;
            color: #16a34a;
        }

        .user-action-btn.approve:hover {
            background: #16a34a;
            color: white;
        }

        .user-action-btn.block {
            background: #fee2e2;
            color: #dc2626;
        }

        .user-action-btn.block:hover {
            background: #dc2626;
            color: white;
        }

        .user-action-btn.unblock {
            background: #dbeafe;
            color: #2563eb;
        }

        .user-action-btn.unblock:hover {
            background: #2563eb;
            color: white;
        }

        /* Pending Approval Screen */
        .pending-approval-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .pending-approval-screen.hidden {
            display: none;
        }

        .pending-card {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.15);
        }

        .pending-card .pending-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .pending-card h2 {
            font-size: 1.8rem;
            color: #d97706;
            margin-bottom: 15px;
        }

        .pending-card p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .pending-card .logout-btn {
            padding: 12px 30px;
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pending-card .logout-btn:hover {
            background: #000;
        }

        /* Blocked Screen */
        .blocked-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .blocked-screen.hidden {
            display: none;
        }

        .blocked-card {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.15);
        }

        .blocked-card .blocked-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .blocked-card h2 {
            font-size: 1.8rem;
            color: #dc2626;
            margin-bottom: 15px;
        }

        .blocked-card p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        /* Company field in registration */
        .company-field {
            margin-bottom: 20px;
        }

        /* Responsive Auth */
        @media (max-width: 480px) {
            .auth-container {
                border-radius: 15px;
            }
            
            .auth-header {
                padding: 25px 20px;
            }
            
            .auth-form-container {
                padding: 20px;
            }
            
            .auth-header h1 {
                font-size: 1.3rem;
            }
            
            .user-menu {
                right: 70px;
            }
            
            html[dir="rtl"] .user-menu {
                left: 70px;
            }
            
            .admin-search input {
                min-width: 150px;
            }
            
            .users-table th,
            .users-table td {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .user-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <div class="auth-header">
                <img src="data:image/webp;base64,UklGRugEAABXRUJQVlA4WAoAAAAwAAAAFAIAFAIASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIugAAAAF/oKCNJDV4d8/MrOUjIiAoWftn+2UbvGxwUmvbFBEBh8XvDcDiaACWBFgsDvsrKEACZmswCYgwZyL8eldwnoj+T0CA//E//r/F7oXVZxWTsPpgyCKt/lXxkVZf8R/+w3/4D//hP7TxP43cVWynkT9P6AIvbPEf/sN/+A//4T80FI4OjbynlA6t8B/+w3+XdPHh0MR73I3/8B/+w3/4D//hP/yH//DfFVMvdG38oBa6Dobgf/yP/++XAVZQOCA4AgAAcEEAnQEqFQIVAj5RKJJHI6KhoSAIAHAKCWlu4XdhG0AJ7APfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk4UAAD+//E/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt="HAz Logo">
                <h1 data-translate="appTitle">HAz Construction PM System</h1>
                <p data-translate="authWelcome">Secure Project Management Platform</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')" data-translate="login">Login</button>
                <button class="auth-tab" onclick="showAuthTab('register')" data-translate="register">Register</button>
            </div>
            
            <div class="auth-form-container">
                <!-- Login Form -->
                <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                    <div id="loginError" class="auth-error"></div>
                    <div id="loginSuccess" class="auth-success"></div>
                    
                    <div class="auth-input-group">
                        <label data-translate="email">Email Address</label>
                        <div class="input-icon">
                            <span>ð§</span>
                            <input type="email" id="loginEmail" required placeholder="your@email.com">
                        </div>
                    </div>
                    
                    <div class="auth-input-group">
                        <label data-translate="password">Password</label>
                        <div class="input-icon">
                            <span>ð</span>
                            <input type="password" id="loginPassword" required placeholder="â¢â¢â¢â¢â¢â¢â¢â¢" minlength="6">
                        </div>
                    </div>
                    
                    <button type="submit" class="auth-btn auth-btn-primary" id="loginBtn">
                        <span data-translate="login">Login</span> â
                    </button>
                    
                    <div class="auth-footer">
                        <a href="#" onclick="showForgotPassword()" data-translate="forgotPassword">Forgot Password?</a>
                    </div>
                </form>
                
                <!-- Register Form -->
                <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                    <div id="registerError" class="auth-error"></div>
                    <div id="registerSuccess" class="auth-success"></div>
                    
                    <div class="auth-input-group">
                        <label data-translate="fullName">Full Name</label>
                        <div class="input-icon">
                            <span>ð¤</span>
                            <input type="text" id="registerName" required placeholder="Mohamed Ahmed">
                        </div>
                    </div>
                    
                    <div class="auth-input-group">
                        <label data-translate="companyName">Company Name</label>
                        <div class="input-icon">
                            <span>ð¢</span>
                            <input type="text" id="registerCompany" required placeholder="Al Rajhi Construction">
                        </div>
                    </div>
                    
                    <div class="auth-input-group">
                        <label data-translate="email">Email Address</label>
                        <div class="input-icon">
                            <span>ð§</span>
                            <input type="email" id="registerEmail" required placeholder="your@email.com">
                        </div>
                    </div>
                    
                    <div class="auth-input-group">
                        <label data-translate="phone">Phone Number</label>
                        <div class="input-icon">
                            <span>ð±</span>
                            <input type="tel" id="registerPhone" placeholder="+966 5X XXX XXXX">
                        </div>
                    </div>
                    
                    <div class="auth-input-group">
                        <label data-translate="password">Password</label>
                        <div class="input-icon">
                            <span>ð</span>
                            <input type="password" id="registerPassword" required placeholder="Min 6 characters" minlength="6" oninput="checkPasswordStrength(this.value)">
                        </div>
                        <div class="password-strength">
                            <div id="passwordStrengthBar" class="password-strength-bar"></div>
                        </div>
                    </div>
                    
                    <div class="auth-input-group">
                        <label data-translate="confirmPassword">Confirm Password</label>
                        <div class="input-icon">
                            <span>ð</span>
                            <input type="password" id="registerPasswordConfirm" required placeholder="Repeat password" minlength="6">
                        </div>
                    </div>
                    
                    <button type="submit" class="auth-btn auth-btn-primary" id="registerBtn">
                        <span data-translate="createAccount">Create Account</span> â
                    </button>
                    
                    <div class="auth-footer">
                        <p data-translate="registerNote">Account requires admin approval</p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Pending Approval Screen -->
    <div id="pendingScreen" class="pending-approval-screen hidden">
        <div class="pending-card">
            <div class="pending-icon">â³</div>
            <h2 data-translate="pendingTitle">Account Pending Approval</h2>
            <p data-translate="pendingMessage">Your account is awaiting admin approval. You will receive an email once your account is activated. This usually takes 1-2 business days.</p>
            <button class="logout-btn" onclick="handleLogout()" data-translate="logout">Logout</button>
        </div>
    </div>

    <!-- Blocked Screen -->
    <div id="blockedScreen" class="blocked-screen hidden">
        <div class="blocked-card">
            <div class="blocked-icon">ð«</div>
            <h2 data-translate="blockedTitle">Account Blocked</h2>
            <p data-translate="blockedMessage">Your account has been blocked. Please contact the administrator for more information.</p>
            <button class="logout-btn" onclick="handleLogout()" data-translate="logout">Logout</button>
        </div>
    </div>

    <!-- User Menu -->
    <div id="userMenu" class="user-menu" style="display: none;">
        <div class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()">U</div>
        <div class="user-dropdown" id="userDropdown">
            <div class="user-dropdown-header">
                <div class="user-name" id="dropdownUserName">User Name</div>
                <div class="user-email" id="dropdownUserEmail">user@email.com</div>
                <span class="user-role user" id="dropdownUserRole">User</span>
            </div>
            <button class="user-dropdown-item" onclick="showTab('config')">
                <span>âï¸</span> <span data-translate="tabSettings">Settings</span>
            </button>
            <button class="user-dropdown-item" id="adminPanelBtn" onclick="showTab('admin')" style="display: none;">
                <span>ð</span> <span data-translate="adminPanel">Admin Panel</span>
            </button>
            <button class="user-dropdown-item danger" onclick="handleLogout()">
                <span>ðª</span> <span data-translate="logout">Logout</span>
            </button>
        </div>
    </div>

    <!-- Language Toggle -->
    <div class="lang-toggle" onclick="toggleLanguage()" title="Switch Language / ØªØºÙÙØ± Ø§ÙÙØºØ©">
        <span class="lang-icon">ð</span>
        <div class="lang-switch"></div>
        <span class="lang-text">EN</span>
    </div>

    <div class="container">
        <!-- Main Page Content (hidden in crew mode) -->
        <div id="mainPage">
            <header class="header">
                <img src="data:image/webp;base64,UklGRugEAABXRUJQVlA4WAoAAAAwAAAAFAIAFAIASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIugAAAAF/oKCNJDV4d8/MrOUjIiAoWftn+2UbvGxwUmvbFBEBh8XvDcDiaACWBFgsDvsrKEACZmswCYgwZyL8eldwnoj+T0CA//E//r/F7oXVZxWTsPpgyCKt/lXxkVZf8R/+w3/4D//hP7TxP43cVWynkT9P6AIvbPEf/sN/+A//4T80FI4OjbynlA6t8B/+w3+XdPHh0MR73I3/8B/+w3/4D//hP/yH//DfFVMvdG38oBa6Dobgf/yP/++XAVZQOCA4AgAAcEEAnQEqFQIVAj5RKJJHI6KhoSAIAHAKCWlu4XdhG0AJ7APfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk4UAAD+//E/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt="HAz Logo" class="logo">
                <h1 data-translate="appTitle">HAz Construction PM System</h1>
                <p data-translate="appSubtitle">Saudi Arabia - Cost Management & Progress Tracking</p>
            </header>

            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('daily')">
                    ð <span data-translate="tabDaily">Daily Report</span>
                </button>
                <button class="tab-btn" onclick="showTab('weekly')">
                    ð <span data-translate="tabWeekly">Weekly Report</span>
                </button>
                <button class="tab-btn" onclick="showTab('monthly')">
                    ð <span data-translate="tabMonthly">Monthly Report (EVM)</span>
                </button>
                <button class="tab-btn" onclick="showTab('config')">
                    âï¸ <span data-translate="tabSettings">Settings</span>
                </button>
                <button class="tab-btn" id="adminTabBtn" onclick="showTab('admin')" style="display: none;">
                    ð <span data-translate="adminPanel">Admin Panel</span>
                </button>
            </div>

            <!-- Daily Report Form -->
            <div id="daily" class="tab-content active">
                <div class="form-card">
                    <h2 class="form-title">
                        ð <span data-translate="dailyFormTitle">Daily Labor & Equipment Report</span>
                    </h2>
                    <form id="dailyForm" class="form-grid">
                        <div class="form-group">
                            <label data-translate="projectCode">Project Code <span>*</span></label>
                            <input type="text" name="projectCode" required placeholder="PRJ001">
                        </div>
                        <div class="form-group">
                            <label>Project Name <span>*</span></label>
                            <input type="text" name="projectName" required placeholder="King Abdullah Road Development">
                        </div>
                        <div class="form-group">
                            <label>Report Date <span>*</span></label>
                            <input type="date" name="reportDate" required>
                        </div>

                        <!-- Crew Link Generation Section -->
                        <div class="crew-link-section" style="grid-column: 1 / -1;">
                            <h4>ð <span data-translate="crewLinkSection">Generate Crew Data Entry Link</span></h4>
                            <p style="margin-bottom: 15px; color: var(--text-light);" data-translate="crewLinkDesc">Generate a link to send to crew supervisors for entering their location, manpower, and equipment data.</p>
                            
                            <div class="link-options">
                                <div class="link-option-group">
                                    <label>â±ï¸ <span data-translate="linkValidFor">Link Valid For</span></label>
                                    <select id="linkValidityHours">
                                        <option value="24" selected>24 Hours (1 Day)</option>
                                        <option value="12">12 Hours</option>
                                        <option value="8">8 Hours</option>
                                        <option value="48">48 Hours (2 Days)</option>
                                        <option value="72">72 Hours (3 Days)</option>
                                    </select>
                                </div>
                                <div class="link-option-group">
                                    <label>ð¥ <span data-translate="maxUsers">Max Users</span></label>
                                    <select id="linkMaxUsers">
                                        <option value="1">1 User</option>
                                        <option value="3">3 Users</option>
                                        <option value="5" selected>5 Users</option>
                                        <option value="10">10 Users</option>
                                        <option value="20">20 Users</option>
                                        <option value="unlimited">Unlimited</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button type="button" class="generate-link-btn" onclick="generateCrewLink()">
                                ð <span data-translate="generateCrewLink">Generate Link</span>
                            </button>
                            <div id="generatedLink" class="generated-link">
                                <p style="margin-bottom: 10px; font-weight: 600;">Share this link with crew supervisors:</p>
                                <div class="link-input-group">
                                    <input type="text" id="crewLinkInput" readonly>
                                    <button type="button" class="copy-btn" onclick="copyCrewLink()">ð <span data-translate="copyLink">Copy</span></button>
                                </div>
                                <div class="link-info" id="linkInfoDisplay">
                                    <span class="link-info-item">â±ï¸ <strong data-translate="linkExpiry">Expires:</strong> <span id="linkExpiryTime">--</span></span>
                                    <span class="link-info-item">ð¥ <strong data-translate="maxUsers">Max Users:</strong> <span id="linkMaxUsersDisplay">--</span></span>
                                    <span class="link-info-item">â <strong data-translate="linkUsed">Used:</strong> <span id="linkUsedCount">0</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Crew Submissions List -->
                        <div class="form-section" style="grid-column: 1 / -1;">
                            <h3>ð¥ <span data-translate="crewSubmissions">Crew Submissions</span></h3>
                            <p style="color: var(--text-light); margin-bottom: 15px;">Data submitted by crews will appear here after they use the generated link.</p>
                            <div id="crewSubmissionsList" class="crew-submissions-list">
                                <p class="no-submissions" data-translate="noSubmissions">No crew submissions yet. Generate and share the link above.</p>
                            </div>
                        </div>

                        <!-- Estimated Daily Cost -->
                        <div class="total-display" id="dailyTotalDisplay" style="grid-column: 1 / -1;">
                            <div class="total-label" data-translate="dailyTotal">Estimated Daily Cost (from all crews)</div>
                            <div class="total-value" id="dailyTotalValue">0 SAR</div>
                        </div>

                        <!-- Cost Summary & Location Preview -->
                        <div class="form-section summary-section" style="grid-column: 1 / -1;">
                            <h3>ð Cost Summary & Location Preview</h3>
                            <button type="button" class="preview-btn" onclick="generatePreview()">
                                ðï¸ Generate Preview
                            </button>
                            
                            <div id="previewContent" class="preview-content" style="display: none;">
                                <div class="preview-grid">
                                    <div class="preview-card manpower-card">
                                        <h4>ð· Manpower Cost</h4>
                                        <div class="preview-table" id="manpowerPreviewTable"></div>
                                        <div class="preview-total">
                                            <span>Total:</span>
                                            <strong id="manpowerTotalPreview">0 SAR</strong>
                                        </div>
                                    </div>
                                    
                                    <div class="preview-card equipment-card">
                                        <h4>ð Equipment Cost</h4>
                                        <div class="preview-table" id="equipmentPreviewTable"></div>
                                        <div class="preview-total">
                                            <span>Total:</span>
                                            <strong id="equipmentTotalPreview">0 SAR</strong>
                                        </div>
                                    </div>
                                    
                                    <div class="preview-card location-card">
                                        <h4>ð Locations</h4>
                                        <div id="locationPreviewContent">
                                            <p>No location data from crews yet</p>
                                        </div>
                                    </div>
                                    
                                    <div class="preview-card grand-total-card">
                                        <h4>ð° Grand Total</h4>
                                        <div class="grand-total-value" id="grandTotalPreview">0 SAR</div>
                                    </div>
                                </div>
                                
                                <div class="export-buttons">
                                    <button type="button" class="export-btn" onclick="exportToKMZ()">
                                        ð¥ Export Locations as KMZ
                                    </button>
                                    <button type="button" class="export-btn" onclick="printPreview()">
                                        ð¨ï¸ Print Preview
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Notes</label>
                            <textarea name="notes" placeholder="Any additional notes..."></textarea>
                        </div>

                        <button type="submit" class="submit-btn">
                            <span>ð¤</span>
                            <span>Submit Daily Report</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Weekly Report Form -->
            <div id="weekly" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">
                        ð <span data-translate="weeklyFormTitle">Weekly Progress Report</span>
                    </h2>
                    <form id="weeklyForm" class="form-grid">
                        <div class="form-group">
                            <label data-translate="projectCode">Project Code <span>*</span></label>
                            <input type="text" name="projectCode" required placeholder="PRJ001">
                        </div>
                        <div class="form-group">
                            <label data-translate="projectName">Project Name <span>*</span></label>
                            <input type="text" name="projectName" required placeholder="King Abdullah Road Development">
                        </div>
                        <div class="form-group">
                            <label data-translate="weekStartDate">Week Starting Date <span>*</span></label>
                            <input type="date" name="weekStartDate" required onchange="updateWeekEndDate()">
                        </div>
                        <div class="form-group">
                            <label data-translate="weekEndDate">Week Ending Date <span>*</span></label>
                            <input type="date" name="weekEndDate" required>
                        </div>

                        <!-- Progress Items Section -->
                        <div class="form-section progress-items-section" style="grid-column: 1 / -1;">
                            <div class="section-header-row">
                                <h3>ð <span data-translate="progressItems">Progress Items</span></h3>
                                <button type="button" class="import-daily-btn" onclick="importFromDailyReports()">
                                    ð¥ <span data-translate="importFromDaily">Import from Daily Reports</span>
                                </button>
                            </div>
                            <p class="section-hint">Add progress items to track planned vs completed quantities, costs and earned value</p>
                            
                            <div id="progressItemsContainer">
                                <div class="progress-item-card" data-progress-index="0">
                                    <div class="progress-item-header">
                                        <span class="progress-item-title">ð¦ <span data-translate="workItem">Progress Item</span> #1</span>
                                        <button type="button" class="remove-progress-item-btn" onclick="removeProgressItem(this)" style="display: none;">â <span data-translate="remove">Remove</span></button>
                                    </div>
                                    
                                    <div class="progress-item-info">
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label data-translate="itemNo">Item Code <span>*</span></label>
                                                <input type="text" name="progressItems[0].itemCode" required placeholder="ITEM-001">
                                            </div>
                                            <div class="form-group" style="grid-column: span 2;">
                                                <label>Item Description <span>*</span></label>
                                                <input type="text" name="progressItems[0].itemDescription" required placeholder="Reinforced concrete slab">
                                            </div>
                                        </div>
                                        
                                        <!-- Subcontractor Toggle -->
                                        <div class="progress-subcontractor-toggle">
                                            <label class="toggle-switch">
                                                <input type="checkbox" onchange="toggleProgressSubcontractor(0, this.checked)">
                                                <span class="toggle-slider"></span>
                                            </label>
                                            <span>Include Subcontractor</span>
                                        </div>
                                        <div class="progress-subcontractor-fields" data-progress="0" style="display: none;">
                                            <div class="form-grid">
                                                <div class="form-group">
                                                    <label>Subcontractor Name</label>
                                                    <input type="text" name="progressItems[0].subcontractorName" placeholder="Al Rajhi Construction">
                                                </div>
                                                <div class="form-group">
                                                    <label>Subcontractor Code</label>
                                                    <input type="text" name="progressItems[0].subcontractorCode" placeholder="SUB-001">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="progress-quantities">
                                        <h4>ð Quantities & Pricing</h4>
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label>Planned Qty <span>*</span></label>
                                                <input type="number" name="progressItems[0].plannedQty" required min="0" step="0.01" placeholder="1000" oninput="calculateProgressItem(0)">
                                            </div>
                                            <div class="form-group">
                                                <label>Completed Qty (Daily) <span>*</span></label>
                                                <input type="number" name="progressItems[0].completedQtyDaily" min="0" step="0.01" placeholder="850" oninput="calculateProgressItem(0)" class="daily-qty-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Adjust Qty (+/-)</label>
                                                <input type="number" name="progressItems[0].adjustQty" step="0.01" placeholder="0" oninput="calculateProgressItem(0)" class="adjust-qty-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Final Completed Qty</label>
                                                <input type="number" name="progressItems[0].completedQty" readonly class="final-qty-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Unit <span>*</span></label>
                                                <input type="text" name="progressItems[0].unit" required placeholder="mÂ³, mÂ², L.m, ton, etc.">
                                            </div>
                                            <div class="form-group">
                                                <label>Unit Price (SAR) <span>*</span></label>
                                                <input type="number" name="progressItems[0].unitPrice" required min="0" step="0.01" placeholder="250" oninput="calculateProgressItem(0)">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="progress-costs">
                                        <h4>ð° Cost Analysis</h4>
                                        <div class="form-grid">
                                            <div class="form-group">
                                                <label>Earned Value (EV)</label>
                                                <input type="number" name="progressItems[0].earnedValue" readonly class="ev-input" placeholder="Calculated">
                                            </div>
                                            <div class="form-group">
                                                <label>AC (Daily Reports)</label>
                                                <input type="number" name="progressItems[0].actualCostDaily" readonly class="ac-daily-input" placeholder="From Daily">
                                            </div>
                                            <div class="form-group">
                                                <label>AC Adjust (+/-)</label>
                                                <input type="number" name="progressItems[0].actualCostAdjust" step="0.01" placeholder="0" oninput="calculateProgressItem(0)" class="ac-adjust-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Final Actual Cost (AC)</label>
                                                <input type="number" name="progressItems[0].actualCost" readonly class="ac-final-input" placeholder="Calculated">
                                            </div>
                                            <div class="form-group">
                                                <label>Cost Variance (CV)</label>
                                                <input type="number" name="progressItems[0].costVariance" readonly class="cv-input" placeholder="Calculated">
                                            </div>
                                            <div class="form-group">
                                                <label>Completion %</label>
                                                <input type="text" name="progressItems[0].completionPct" readonly class="completion-pct-input" placeholder="0%">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="progress-item-summary">
                                        <div class="summary-item">
                                            <span class="summary-label">Earned Value</span>
                                            <span class="summary-value ev-value" data-progress="0">0 SAR</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">Cost Variance</span>
                                            <span class="summary-value cv-value" data-progress="0">0 SAR</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="add-btn add-progress-item-btn" onclick="addProgressItem()">
                                â Add Progress Item
                            </button>
                        </div>

                        <!-- Weekly Totals Summary -->
                        <div class="form-section weekly-totals-section" style="grid-column: 1 / -1;">
                            <h3>ð Weekly Summary</h3>
                            <div class="weekly-summary-grid">
                                <div class="summary-card">
                                    <div class="summary-icon">ð</div>
                                    <div class="summary-content">
                                        <span class="summary-title">Total Earned Value</span>
                                        <span class="summary-amount" id="weeklyTotalEV">0 SAR</span>
                                    </div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-icon">ðµ</div>
                                    <div class="summary-content">
                                        <span class="summary-title">Total Actual Cost</span>
                                        <span class="summary-amount" id="weeklyTotalAC">0 SAR</span>
                                    </div>
                                </div>
                                <div class="summary-card variance-card">
                                    <div class="summary-icon">ð</div>
                                    <div class="summary-content">
                                        <span class="summary-title">Total Cost Variance</span>
                                        <span class="summary-amount" id="weeklyTotalCV">0 SAR</span>
                                    </div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-icon">â</div>
                                    <div class="summary-content">
                                        <span class="summary-title">Avg. Completion</span>
                                        <span class="summary-amount" id="weeklyAvgCompletion">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Histogram Section -->
                        <div class="form-section histogram-section" style="grid-column: 1 / -1;">
                            <div class="section-header-row">
                                <h3>ð Cost Variance Histogram</h3>
                                <button type="button" class="refresh-chart-btn" onclick="updateWeeklyHistogram()">
                                    ð Refresh Chart
                                </button>
                            </div>
                            <div class="histogram-container" id="weeklyHistogramContainer">
                                <div class="histogram-placeholder">
                                    <span>ð</span>
                                    <p>Add progress items to see the cost variance histogram</p>
                                </div>
                            </div>
                            <div class="histogram-legend">
                                <div class="legend-item">
                                    <span class="legend-color positive"></span>
                                    <span>Positive Variance (Under Budget)</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-color negative"></span>
                                    <span>Negative Variance (Over Budget)</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Notes</label>
                            <textarea name="notes" placeholder="Delay reasons, issues, achievements, or other notes..."></textarea>
                        </div>

                        <button type="submit" class="submit-btn">
                            <span>ð¤</span>
                            <span>Submit Weekly Report</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Monthly Report Form (EVM) -->
            <div id="monthly" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">
                        ð Monthly Report - Earned Value Management
                    </h2>
                    
                    <div class="evm-info">
                        <h4>EVM Information</h4>
                        <ul>
                            <li><strong>BAC</strong> = Budget at Completion</li>
                            <li><strong>AC</strong> = Actual Cost</li>
                            <li><strong>EV</strong> = Earned Value</li>
                            <li><strong>PV</strong> = Planned Value</li>
                            <li><strong>CPI</strong> = Cost Performance Index</li>
                            <li><strong>SPI</strong> = Schedule Performance Index</li>
                        </ul>
                    </div>

                    <form id="monthlyForm" class="form-grid" style="margin-top: 30px;">
                        <div class="form-group">
                            <label>Project Code <span>*</span></label>
                            <input type="text" name="projectCode" required placeholder="PRJ001">
                        </div>
                        <div class="form-group">
                            <label>Project Name <span>*</span></label>
                            <input type="text" name="projectName" required placeholder="King Abdullah Road Development">
                        </div>
                        <div class="form-group">
                            <label>Month <span>*</span></label>
                            <select name="month" required>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Year <span>*</span></label>
                            <input type="number" name="year" required value="2025">
                        </div>
                        <div class="form-group">
                            <label>Item Code <span>*</span></label>
                            <input type="text" name="itemCode" required placeholder="ITEM-001">
                        </div>
                        <div class="form-group">
                            <label>Item Description <span>*</span></label>
                            <input type="text" name="itemDescription" required placeholder="Concrete foundation works">
                        </div>

                        <div class="form-section">
                            <h3>ð° EVM Values (SAR)</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>BAC (Budget at Completion) <span>*</span></label>
                                    <input type="number" name="BAC" required min="0" step="0.01" placeholder="1,000,000" oninput="calculateEVM()">
                                </div>
                                <div class="form-group">
                                    <label>PV (Planned Value) <span>*</span></label>
                                    <input type="number" name="PV" required min="0" step="0.01" placeholder="500,000" oninput="calculateEVM()">
                                </div>
                                <div class="form-group">
                                    <label>EV (Earned Value) <span>*</span></label>
                                    <input type="number" name="EV" required min="0" step="0.01" placeholder="450,000" oninput="calculateEVM()">
                                </div>
                                <div class="form-group">
                                    <label>AC (Actual Cost) <span>*</span></label>
                                    <input type="number" name="AC" required min="0" step="0.01" placeholder="480,000" oninput="calculateEVM()">
                                </div>
                            </div>
                        </div>

                        <div class="calculated-fields" id="evmCalculations">
                            <h4>ð Calculated EVM Metrics</h4>
                            <div class="calc-grid">
                                <div class="calc-item" id="cpiCalc">
                                    <div class="value">-</div>
                                    <div class="label">CPI</div>
                                </div>
                                <div class="calc-item" id="spiCalc">
                                    <div class="value">-</div>
                                    <div class="label">SPI</div>
                                </div>
                                <div class="calc-item" id="cvCalc">
                                    <div class="value">-</div>
                                    <div class="label">CV (SAR)</div>
                                </div>
                                <div class="calc-item" id="svCalc">
                                    <div class="value">-</div>
                                    <div class="label">SV (SAR)</div>
                                </div>
                                <div class="calc-item" id="eacCalc">
                                    <div class="value">-</div>
                                    <div class="label">EAC (SAR)</div>
                                </div>
                                <div class="calc-item" id="etcCalc">
                                    <div class="value">-</div>
                                    <div class="label">ETC (SAR)</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>ð¦ Materials Used</h3>
                            <div id="materialsContainer">
                                <div class="dynamic-item" data-index="0">
                                    <div class="item-header">
                                        <span class="item-number">Material #1</span>
                                    </div>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Item Number <span>*</span></label>
                                            <input type="text" name="materials[0].itemNumber" required placeholder="1.1">
                                        </div>
                                        <div class="form-group">
                                            <label>Material Code <span>*</span></label>
                                            <input type="text" name="materials[0].code" required placeholder="MAT-001">
                                        </div>
                                        <div class="form-group">
                                            <label>Material Name</label>
                                            <input type="text" name="materials[0].name" placeholder="Concrete Grade 40">
                                        </div>
                                        <div class="form-group">
                                            <label>Quantity <span>*</span></label>
                                            <input type="number" name="materials[0].quantity" required min="0" step="0.01" placeholder="100">
                                        </div>
                                        <div class="form-group">
                                            <label>Unit <span>*</span></label>
                                            <select name="materials[0].unit" required>
                                                <option value="ton">Ton</option>
                                                <option value="m3">mÂ³</option>
                                                <option value="m2">mÂ²</option>
                                                <option value="kg">Kg</option>
                                                <option value="no">Number</option>
                                                <option value="bag">Bag</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Unit Cost (SAR) <span>*</span></label>
                                            <input type="number" name="materials[0].unitCost" required min="0" step="0.01" placeholder="500">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="add-btn" onclick="addMaterial()">
                                â Add Material
                            </button>
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Notes</label>
                            <textarea name="notes" placeholder="Any additional notes..."></textarea>
                        </div>

                        <button type="submit" class="submit-btn">
                            <span>ð¤</span>
                            <span>Submit Monthly Report</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="config" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">
                        âï¸ System Settings
                    </h2>
                    <div class="config-group">
                        <label>Webhook URL (n8n) <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="webhookUrl" placeholder="https://your-n8n.com/webhook/construction-pm">
                        <p style="margin-top: 8px; font-size: 0.85rem; color: var(--text-light);">Enter your n8n webhook URL endpoint</p>
                    </div>
                    <div class="config-group">
                        <label>Telegram Chat ID</label>
                        <input type="text" id="telegramChatId" placeholder="-1001234567890">
                        <p style="margin-top: 8px; font-size: 0.85rem; color: var(--text-light);">Your Telegram group or channel ID for notifications</p>
                    </div>
                    <div class="config-group">
                        <label>API Key</label>
                        <input type="password" id="apiKey" placeholder="Your API key for authentication">
                        <p style="margin-top: 8px; font-size: 0.85rem; color: var(--text-light);">Optional: API key for webhook authentication</p>
                    </div>
                    
                    <!-- Supabase Configuration -->
                    <div class="form-section" style="margin-top: 30px; border-top: 2px solid #e0e0e0; padding-top: 25px;">
                        <h3>ð Supabase Authentication Settings</h3>
                        <p style="color: var(--text-light); margin-bottom: 20px;">Configure your Supabase project for user authentication</p>
                        
                        <div class="config-group">
                            <label>Supabase URL <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                            <p style="margin-top: 8px; font-size: 0.85rem; color: var(--text-light);">Your Supabase project URL</p>
                        </div>
                        <div class="config-group">
                            <label>Supabase Anon Key <span style="color: var(--danger);">*</span></label>
                            <input type="password" id="supabaseAnonKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                            <p style="margin-top: 8px; font-size: 0.85rem; color: var(--text-light);">Your Supabase anonymous/public key (safe to use in browser)</p>
                        </div>
                    </div>
                    
                    <button class="submit-btn" onclick="saveConfig()" style="max-width: 300px;">
                        <span>ð¾</span>
                        <span>Save Settings</span>
                    </button>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="admin" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">
                        ð <span data-translate="adminPanel">Admin Panel - User Management</span>
                    </h2>
                    <p style="color: var(--text-light); margin-bottom: 30px;" data-translate="adminDescription">Manage user access without viewing their project data. Approve, block, or remove users.</p>
                    
                    <!-- Admin Stats -->
                    <div class="admin-stats">
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon users">ð¥</div>
                            <div class="admin-stat-info">
                                <h3 id="statTotalUsers">0</h3>
                                <p data-translate="totalUsers">Total Users</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon active">â</div>
                            <div class="admin-stat-info">
                                <h3 id="statActiveUsers">0</h3>
                                <p data-translate="activeUsers">Active Users</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon pending">â³</div>
                            <div class="admin-stat-info">
                                <h3 id="statPendingUsers">0</h3>
                                <p data-translate="pendingApproval">Pending Approval</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon blocked">ð«</div>
                            <div class="admin-stat-info">
                                <h3 id="statBlockedUsers">0</h3>
                                <p data-translate="blockedUsers">Blocked Users</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="admin-users-table">
                        <div class="admin-table-header">
                            <h3>ð¥ <span data-translate="registeredUsers">Registered Users</span></h3>
                            <div class="admin-search">
                                <input type="text" id="userSearchInput" placeholder="Search users..." oninput="filterUsers(this.value)">
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th data-translate="fullName">Name</th>
                                        <th data-translate="companyName">Company</th>
                                        <th data-translate="email">Email</th>
                                        <th data-translate="status">Status</th>
                                        <th data-translate="registeredDate">Registered</th>
                                        <th data-translate="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                            <span data-translate="loadingUsers">Loading users...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <img src="data:image/webp;base64,UklGRugEAABXRUJQVlA4WAoAAAAwAAAAFAIAFAIASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIugAAAAF/oKCNJDV4d8/MrOUjIiAoWftn+2UbvGxwUmvbFBEBh8XvDcDiaACWBFgsDvsrKEACZmswCYgwZyL8eldwnoj+T0CA//E//r/F7oXVZxWTsPpgyCKt/lXxkVZf8R/+w3/4D//hP7TxP43cVWynkT9P6AIvbPEf/sN/+A//4T80FI4OjbynlA6t8B/+w3+XdPHh0MR73I3/8B/+w3/4D//hP/yH//DfFVMvdG38oBa6Dobgf/yP/++XAVZQOCA4AgAAcEEAnQEqFQIVAj5RKJJHI6KhoSAIAHAKCWlu4XdhG0AJ7APfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk4UAAD+//E/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt="HAz Logo">
                <p>Â© 2025 HAz Project Management Solutions LLC</p>
                <p>Saudi Arabia - Construction Project Management</p>
            </footer>
        </div>

        <!-- Crew Data Entry Page (hidden by default) -->
        <div id="crewPage" style="display: none;">
            <header class="header">
                <img src="data:image/webp;base64,UklGRugEAABXRUJQVlA4WAoAAAAwAAAAFAIAFAIASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBIugAAAAF/oKCNJDV4d8/MrOUjIiAoWftn+2UbvGxwUmvbFBEBh8XvDcDiaACWBFgsDvsrKEACZmswCYgwZyL8eldwnoj+T0CA//E//r/F7oXVZxWTsPpgyCKt/lXxkVZf8R/+w3/4D//hP7TxP43cVWynkT9P6AIvbPEf/sN/+A//4T80FI4OjbynlA6t8B/+w3+XdPHh0MR73I3/8B/+w3/4D//hP/yH//DfFVMvdG38oBa6Dobgf/yP/++XAVZQOCA4AgAAcEEAnQEqFQIVAj5RKJJHI6KhoSAIAHAKCWlu4XdhG0AJ7APfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk4UAAD+//E/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" alt="HAz Logo" class="logo">
                <h1>Crew Data Entry</h1>
                <p>Submit your daily work data</p>
            </header>

            <div class="form-card">
                <div class="crew-info-banner" id="crewInfoBanner">
                    <h3>ð Project Information</h3>
                    <p>You are submitting data for the following project:</p>
                    <div class="project-details">
                        <div class="detail-item">
                            <span class="detail-label">Project Code</span>
                            <span class="detail-value" id="crewProjectCode">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Project Name</span>
                            <span class="detail-value" id="crewProjectName">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Report Date</span>
                            <span class="detail-value" id="crewReportDate">-</span>
                        </div>
                    </div>
                </div>

                <h2 class="form-title">
                    ð· Enter Your Work Data
                </h2>
                
                <form id="crewForm" class="form-grid">
                    <input type="hidden" name="projectCode" id="crewFormProjectCode">
                    <input type="hidden" name="projectName" id="crewFormProjectName">
                    <input type="hidden" name="reportDate" id="crewFormReportDate">
                    <input type="hidden" name="submissionType" value="crew">

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Line Name <span>*</span></label>
                        <input type="text" name="lineName" id="crewFormLineName" required placeholder="e.g., Main Sewer Line A, Water Pipeline Section 3">
                    </div>

                    <div class="form-group">
                        <label>Crew Supervisor Name <span>*</span></label>
                        <input type="text" name="crewSupervisor" required placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label>Crew Number <span>*</span></label>
                        <input type="text" name="crewNumber" required placeholder="Crew #1">
                    </div>

                    <!-- Location Section for Crew -->
                    <div class="form-section">
                        <h3>ð Work Location</h3>
                        
                        <div class="location-toggle">
                            <label>
                                <input type="radio" name="crewLocationType" value="station" checked onchange="toggleCrewLocationType()">
                                Station (St. to St.)
                            </label>
                            <label>
                                <input type="radio" name="crewLocationType" value="mh" onchange="toggleCrewLocationType()">
                                Manhole (MH to MH)
                            </label>
                        </div>

                        <div id="crewStationFields" class="station-fields active">
                            <div class="form-group">
                                <label>From Station</label>
                                <input type="text" name="crewFromStation" placeholder="St. 0+000">
                            </div>
                            <div class="form-group">
                                <label>To Station</label>
                                <input type="text" name="crewToStation" placeholder="St. 0+500">
                            </div>
                        </div>

                        <div id="crewMhFields" class="mh-fields">
                            <div class="form-group">
                                <label>From MH</label>
                                <input type="text" name="crewFromMH" placeholder="MH-001">
                            </div>
                            <div class="form-group">
                                <label>To MH</label>
                                <input type="text" name="crewToMH" placeholder="MH-005">
                            </div>
                        </div>

                        <div class="form-grid" style="margin-top: 15px;">
                            <div class="form-group">
                                <label>Length Completed (L.m)</label>
                                <input type="number" name="crewLengthLm" min="0" step="0.01" placeholder="100">
                            </div>
                        </div>

                        <!-- GPS Location Section for Crew -->
                        <div class="gps-section">
                            <h4>ð GPS Location (Google Maps)</h4>
                            <div class="gps-options">
                                <button type="button" class="gps-option-btn" onclick="getCrewCurrentLocation()">
                                    <span class="gps-icon">ð</span>
                                    <span class="gps-label">Get My Location</span>
                                    <span class="gps-desc">Use device GPS</span>
                                </button>
                                <button type="button" class="gps-option-btn" onclick="openMapPicker()">
                                    <span class="gps-icon">ðºï¸</span>
                                    <span class="gps-label">Choose from Map</span>
                                    <span class="gps-desc">Pick on Google Maps</span>
                                </button>
                            </div>
                            <span class="location-status" id="crewLocationStatus"></span>
                            <div class="form-grid" style="margin-top: 15px;">
                                <div class="form-group">
                                    <label>Latitude</label>
                                    <input type="text" name="crewLatitude" id="crewLatitude" placeholder="24.7136" oninput="updateCrewMapLinks()">
                                </div>
                                <div class="form-group">
                                    <label>Longitude</label>
                                    <input type="text" name="crewLongitude" id="crewLongitude" placeholder="46.6753" oninput="updateCrewMapLinks()">
                                </div>
                                <div class="form-group">
                                    <label>Location Description</label>
                                    <input type="text" name="crewLocationName" id="crewLocationName" placeholder="Work site area">
                                </div>
                            </div>
                            <div class="map-buttons" id="crewMapButtons" style="display: none;">
                                <a href="#" id="crewGoogleMapsLink" target="_blank" class="map-link-btn google">
                                    ðºï¸ View on Google Maps
                                </a>
                            </div>
                        </div>

                        <!-- Map Picker Modal -->
                        <div id="mapPickerModal" class="map-modal">
                            <div class="map-modal-content">
                                <div class="map-modal-header">
                                    <h3>ð Choose Location on Map</h3>
                                    <button type="button" class="map-modal-close" onclick="closeMapPicker()">â</button>
                                </div>
                                <div class="map-modal-body">
                                    <div class="map-search-box">
                                        <input type="text" id="mapSearchInput" placeholder="Search for a location..." onkeypress="if(event.key==='Enter'){event.preventDefault(); searchMapLocation();}">
                                        <button type="button" onclick="searchMapLocation()">ð</button>
                                    </div>
                                    <div id="mapContainer" class="map-container">
                                        <iframe 
                                            id="mapFrame"
                                            width="100%" 
                                            height="100%" 
                                            style="border:0;" 
                                            loading="lazy" 
                                            allowfullscreen 
                                            referrerpolicy="no-referrer-when-downgrade"
                                            src="">
                                        </iframe>
                                        <div class="map-crosshair">+</div>
                                        <div class="map-instructions">
                                            <p>ð¯ Navigate to your location, then click "Set This Location"</p>
                                        </div>
                                    </div>
                                    <div class="map-coordinates">
                                        <div class="coord-input">
                                            <label>Lat:</label>
                                            <input type="text" id="pickerLat" placeholder="24.7136" oninput="updateMapFromCoords()">
                                        </div>
                                        <div class="coord-input">
                                            <label>Lng:</label>
                                            <input type="text" id="pickerLng" placeholder="46.6753" oninput="updateMapFromCoords()">
                                        </div>
                                        <button type="button" class="coord-go-btn" onclick="goToCoordinates()">Go</button>
                                    </div>
                                </div>
                                <div class="map-modal-footer">
                                    <button type="button" class="map-cancel-btn" onclick="closeMapPicker()">Cancel</button>
                                    <button type="button" class="map-confirm-btn" onclick="confirmMapLocation()">â Set This Location</button>
                                </div>
                            </div>
                        </div>

                        <!-- KMZ Location Section for Crew -->
                        <div class="kmz-section">
                            <h4>ðºï¸ KMZ Location File</h4>
                            <div class="kmz-input-group">
                                <div class="form-group" style="flex: 1;">
                                    <label>KMZ File URL or Upload</label>
                                    <input type="text" name="crewKmzUrl" id="crewKmzUrl" placeholder="https://drive.google.com/... or paste KMZ link">
                                </div>
                                <div class="kmz-buttons">
                                    <label class="upload-kmz-btn">
                                        <input type="file" name="crewKmzFile" id="crewKmzFileInput" accept=".kmz,.kml" onchange="handleCrewKmzUpload(this)">
                                        ð Upload
                                    </label>
                                    <button type="button" class="open-kmz-btn" onclick="openCrewKmzFile()">
                                        ð Open in Maps
                                    </button>
                                </div>
                            </div>
                            <p class="kmz-hint">Upload a KMZ/KML file or paste a link to mark your work location</p>
                        </div>
                    </div>

                    <!-- Work Items Section for Crew -->
                    <div class="form-section work-items-section">
                        <h3>ð Work Items</h3>
                        <p class="section-hint">Add work items with their associated manpower and equipment</p>
                        <div id="workItemsContainer">
                            <div class="work-item-card" data-item-index="0">
                                <div class="work-item-header">
                                    <span class="work-item-title">ð¦ Work Item #1</span>
                                    <button type="button" class="remove-work-item-btn" onclick="removeWorkItem(this)" style="display: none;">â Remove Item</button>
                                </div>
                                
                                <div class="work-item-info">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Item No. <span>*</span></label>
                                            <input type="text" name="workItems[0].itemNo" required placeholder="ITEM-001">
                                        </div>
                                        <div class="form-group" style="grid-column: span 2;">
                                            <label>Item Description <span>*</span></label>
                                            <input type="text" name="workItems[0].itemDescription" required placeholder="Concrete foundation works">
                                        </div>
                                    </div>
                                </div>

                                <!-- Manpower for this item -->
                                <div class="work-item-manpower">
                                    <h4>ð· Manpower for this Item</h4>
                                    <div class="item-manpower-container" data-item="0">
                                        <div class="dynamic-item" data-index="0">
                                            <div class="item-header">
                                                <span class="item-number">Manpower #1</span>
                                                <button type="button" class="remove-btn" onclick="removeItemResource(this, 'manpower')" style="display: none;">â</button>
                                            </div>
                                            <div class="form-grid">
                                                <div class="form-group">
                                                    <label>Profession <span>*</span></label>
                                                    <select name="workItems[0].manpower[0].profession" required onchange="handleCrewProfessionChange(this)">
                                                        <option value="">Select Profession</option>
                                                        <option value="Labor">Labor</option>
                                                        <option value="Foreman">Foreman</option>
                                                        <option value="Mason">Mason</option>
                                                        <option value="Carpenter">Carpenter</option>
                                                        <option value="Welder">Welder</option>
                                                        <option value="Electrician">Electrician</option>
                                                        <option value="Plumber">Plumber</option>
                                                        <option value="Heavy Equipment Operator">Heavy Equipment Operator</option>
                                                        <option value="Surveyor">Surveyor</option>
                                                        <option value="other">Other (specify)</option>
                                                    </select>
                                                </div>
                                                <div class="form-group custom-profession" style="display: none;">
                                                    <label>Specify Profession <span>*</span></label>
                                                    <input type="text" name="workItems[0].manpower[0].customProfession" placeholder="Enter profession">
                                                </div>
                                                <div class="form-group">
                                                    <label>No. of Workers <span>*</span></label>
                                                    <input type="number" name="workItems[0].manpower[0].count" required min="1" placeholder="5" oninput="calculateCrewTotal()">
                                                </div>
                                                <div class="form-group">
                                                    <label>Hours <span>*</span></label>
                                                    <input type="number" name="workItems[0].manpower[0].hours" required min="0" step="0.5" placeholder="8" oninput="calculateCrewTotal()">
                                                </div>
                                                <div class="form-group">
                                                    <label>Cost/Hour (SAR) <span>*</span></label>
                                                    <input type="number" name="workItems[0].manpower[0].costPerHour" required min="0" step="0.01" placeholder="25" oninput="calculateCrewTotal()">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="add-btn add-resource-btn" onclick="addItemManpower(0)">
                                        â Add Manpower
                                    </button>
                                </div>

                                <!-- Equipment for this item -->
                                <div class="work-item-equipment">
                                    <h4>ð Equipment for this Item</h4>
                                    <div class="item-equipment-container" data-item="0">
                                        <div class="dynamic-item" data-index="0">
                                            <div class="item-header">
                                                <span class="item-number">Equipment #1</span>
                                                <button type="button" class="remove-btn" onclick="removeItemResource(this, 'equipment')" style="display: none;">â</button>
                                            </div>
                                            <div class="form-grid">
                                                <div class="form-group">
                                                    <label>Equipment Name <span>*</span></label>
                                                    <input type="text" name="workItems[0].equipment[0].name" required placeholder="Excavator CAT 320">
                                                </div>
                                                <div class="form-group">
                                                    <label>No. of Equipment <span>*</span></label>
                                                    <input type="number" name="workItems[0].equipment[0].quantity" required min="1" placeholder="1" oninput="calculateCrewTotal()">
                                                </div>
                                                <div class="form-group">
                                                    <label>Hours <span>*</span></label>
                                                    <input type="number" name="workItems[0].equipment[0].hours" required min="0" step="0.5" placeholder="8" oninput="calculateCrewTotal()">
                                                </div>
                                                <div class="form-group">
                                                    <label>Cost/Hour (SAR) <span>*</span></label>
                                                    <input type="number" name="workItems[0].equipment[0].costPerHour" required min="0" step="0.01" placeholder="150" oninput="calculateCrewTotal()">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="add-btn add-resource-btn" onclick="addItemEquipment(0)">
                                        â Add Equipment
                                    </button>
                                </div>

                                <!-- Subcontractor for this item -->
                                <div class="work-item-subcontractor">
                                    <h4>ðï¸ Subcontractor for this Item <span class="optional-badge">(Optional)</span></h4>
                                    <div class="subcontractor-toggle">
                                        <label class="toggle-switch">
                                            <input type="checkbox" onchange="toggleItemSubcontractor(0, this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span>Include Subcontractor</span>
                                    </div>
                                    <div class="item-subcontractor-container" data-item="0" style="display: none;">
                                        <div class="dynamic-item" data-index="0">
                                            <div class="item-header">
                                                <span class="item-number">Subcontractor #1</span>
                                                <button type="button" class="remove-btn" onclick="removeItemResource(this, 'subcontractor')" style="display: none;">â</button>
                                            </div>
                                            <div class="form-grid">
                                                <div class="form-group">
                                                    <label>Company Name <span>*</span></label>
                                                    <input type="text" name="workItems[0].subcontractor[0].companyName" placeholder="ABC Contracting Co.">
                                                </div>
                                                <div class="form-group">
                                                    <label>Contact Person</label>
                                                    <input type="text" name="workItems[0].subcontractor[0].contactPerson" placeholder="Mohammed Ali">
                                                </div>
                                                <div class="form-group">
                                                    <label>Quantity</label>
                                                    <input type="number" name="workItems[0].subcontractor[0].quantity" min="0" step="0.01" placeholder="100" oninput="calculateSubcontractorAmount(this)">
                                                </div>
                                                <div class="form-group">
                                                    <label>Rate (SAR)</label>
                                                    <input type="number" name="workItems[0].subcontractor[0].rate" min="0" step="0.01" placeholder="50" oninput="calculateSubcontractorAmount(this)">
                                                </div>
                                                <div class="form-group">
                                                    <label>Expenses (+)</label>
                                                    <input type="number" name="workItems[0].subcontractor[0].expenses" min="0" step="0.01" placeholder="0" oninput="calculateSubcontractorAmount(this)" class="subcontractor-expenses">
                                                </div>
                                                <div class="form-group">
                                                    <label>Deductions (-)</label>
                                                    <input type="number" name="workItems[0].subcontractor[0].deductions" min="0" step="0.01" placeholder="0" oninput="calculateSubcontractorAmount(this)" class="subcontractor-deductions">
                                                </div>
                                                <div class="form-group" style="grid-column: span 2;">
                                                    <label>Net Amount (SAR)</label>
                                                    <input type="number" name="workItems[0].subcontractor[0].amount" readonly class="subcontractor-amount" placeholder="Calculated">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="add-btn add-resource-btn" onclick="addItemSubcontractor(0)" style="display: none;" data-item="0">
                                        â Add Subcontractor
                                    </button>
                                </div>

                                <div class="work-item-subtotal">
                                    <span>Item Subtotal:</span>
                                    <span class="item-subtotal-value" data-item="0">0 SAR</span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-btn add-work-item-btn" onclick="addWorkItem()">
                            â Add Another Work Item
                        </button>
                    </div>

                    <!-- Crew Cost Total -->
                    <div class="total-display" style="grid-column: 1 / -1;">
                        <div class="total-label">Estimated Crew Cost</div>
                        <div class="total-value" id="crewTotalValue">0 SAR</div>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Work Notes</label>
                        <textarea name="crewNotes" placeholder="Describe work completed, issues encountered, etc..."></textarea>
                    </div>

                    <button type="submit" class="submit-btn">
                        <span>ð¤</span>
                        <span>Submit Crew Data</span>
                    </button>
                </form>
            </div>

            <footer class="footer">
                <p>Â© 2025 HAz Project Management Solutions LLC</p>
            </footer>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Language System
        let currentLang = localStorage.getItem('hazLang') || 'en';
        
        const translations = {
            en: {
                // App Header
                appTitle: 'HAz Construction PM System',
                appSubtitle: 'Saudi Arabia - Cost Management & Progress Tracking',
                
                // Tabs
                tabDaily: 'Daily Report',
                tabWeekly: 'Weekly Report',
                tabMonthly: 'Monthly Report (EVM)',
                tabSettings: 'Settings',
                
                // Authentication
                login: 'Login',
                register: 'Register',
                logout: 'Logout',
                email: 'Email Address',
                password: 'Password',
                confirmPassword: 'Confirm Password',
                fullName: 'Full Name',
                companyName: 'Company Name',
                phone: 'Phone Number',
                forgotPassword: 'Forgot Password?',
                createAccount: 'Create Account',
                authWelcome: 'Secure Project Management Platform',
                registerNote: 'Account requires admin approval',
                pendingTitle: 'Account Pending Approval',
                pendingMessage: 'Your account is awaiting admin approval. You will receive an email once your account is activated. This usually takes 1-2 business days.',
                blockedTitle: 'Account Blocked',
                blockedMessage: 'Your account has been blocked. Please contact the administrator for more information.',
                
                // Admin Panel
                adminPanel: 'Admin Panel',
                adminDescription: 'Manage user access without viewing their project data. Approve, block, or remove users.',
                totalUsers: 'Total Users',
                activeUsers: 'Active Users',
                pendingApproval: 'Pending Approval',
                blockedUsers: 'Blocked Users',
                registeredUsers: 'Registered Users',
                status: 'Status',
                registeredDate: 'Registered',
                actions: 'Actions',
                approve: 'Approve',
                block: 'Block',
                unblock: 'Unblock',
                loadingUsers: 'Loading users...',
                noUsersFound: 'No users found',
                
                // Common Labels
                projectCode: 'Project Code',
                projectName: 'Project Name',
                reportDate: 'Report Date',
                notes: 'Notes',
                submit: 'Submit',
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                edit: 'Edit',
                add: 'Add',
                remove: 'Remove',
                required: 'Required',
                optional: 'Optional',
                calculated: 'Calculated',
                total: 'Total',
                subtotal: 'Subtotal',
                
                // Daily Report
                dailyFormTitle: 'Daily Labor & Equipment Report',
                crewLinkSection: 'Crew Data Entry Link',
                crewLinkDesc: 'Generate a link to send to crew supervisors for entering their location, manpower, and equipment data.',
                generateCrewLink: 'Generate Crew Link',
                linkValidFor: 'Link Valid For',
                maxUsers: 'Max Users',
                unlimited: 'Unlimited',
                copyLink: 'Copy Link',
                linkCopied: 'Link copied!',
                linkExpiry: 'Expires',
                linkUsed: 'Used',
                
                // Work Items
                workItems: 'Work Items',
                workItem: 'Work Item',
                addWorkItem: 'Add Another Work Item',
                itemNo: 'Item No.',
                itemDescription: 'Item Description',
                itemSubtotal: 'Item Subtotal',
                
                // Manpower
                manpower: 'Manpower',
                laborCategory: 'Labor Category',
                count: 'Count',
                hours: 'Hours',
                costPerHour: 'Cost/Hour (SAR)',
                addManpower: 'Add Manpower',
                
                // Equipment
                equipment: 'Equipment',
                equipmentType: 'Equipment Type',
                quantity: 'Quantity',
                addEquipment: 'Add Equipment',
                
                // Subcontractor
                subcontractor: 'Subcontractor',
                subcontractorForItem: 'Subcontractor for this Item',
                includeSubcontractor: 'Include Subcontractor',
                companyName: 'Company Name',
                contactPerson: 'Contact Person',
                rate: 'Rate (SAR)',
                expenses: 'Expenses (+)',
                deductions: 'Deductions (-)',
                netAmount: 'Net Amount (SAR)',
                addSubcontractor: 'Add Subcontractor',
                
                // Location
                location: 'Location',
                useDeviceGPS: 'Use Device GPS',
                pickFromMap: 'Pick from Map',
                getLocation: 'Get Current Location',
                latitude: 'Latitude',
                longitude: 'Longitude',
                
                // Photos
                photos: 'Photos',
                attachPhotos: 'Attach Photos',
                
                // Crew Submissions
                crewSubmissions: 'Crew Submissions',
                noSubmissions: 'No submissions yet',
                dailyTotal: 'Daily Total',
                viewSubmission: 'View',
                
                // Weekly Report
                weeklyFormTitle: 'Weekly Progress Report',
                weekStartDate: 'Week Starting Date',
                weekEndDate: 'Week Ending Date',
                progressItems: 'Progress Items',
                importFromDaily: 'Import from Daily Reports',
                plannedQty: 'Planned Qty',
                completedQtyDaily: 'Completed Qty (Daily)',
                adjustQty: 'Adjust Qty (+/-)',
                finalCompletedQty: 'Final Completed Qty',
                unit: 'Unit',
                unitPrice: 'Unit Price (SAR)',
                earnedValue: 'Earned Value (EV)',
                acDaily: 'AC (Daily Reports)',
                acAdjust: 'AC Adjust (+/-)',
                finalActualCost: 'Final Actual Cost (AC)',
                costVariance: 'Cost Variance (CV)',
                completionPct: 'Completion %',
                addProgressItem: 'Add Progress Item',
                weeklySummary: 'Weekly Summary',
                totalEV: 'Total Earned Value',
                totalAC: 'Total Actual Cost',
                totalCV: 'Total Cost Variance',
                avgCompletion: 'Avg. Completion',
                costVarianceHistogram: 'Cost Variance Histogram',
                refreshChart: 'Refresh Chart',
                positiveVariance: 'Positive Variance (Under Budget)',
                negativeVariance: 'Negative Variance (Over Budget)',
                submitWeekly: 'Submit Weekly Report',
                
                // Monthly Report (EVM)
                monthlyFormTitle: 'Monthly Report - Earned Value Management',
                evmInfo: 'EVM Metrics',
                bac: 'Budget at Completion (BAC)',
                pv: 'Planned Value (PV)',
                ev: 'Earned Value (EV)',
                ac: 'Actual Cost (AC)',
                cv: 'Cost Variance (CV)',
                sv: 'Schedule Variance (SV)',
                cpi: 'Cost Performance Index (CPI)',
                spi: 'Schedule Performance Index (SPI)',
                eac: 'Estimate at Completion (EAC)',
                etc: 'Estimate to Complete (ETC)',
                vac: 'Variance at Completion (VAC)',
                tcpi: 'To-Complete Performance Index (TCPI)',
                calculateEVM: 'Calculate EVM',
                submitMonthly: 'Submit Monthly Report',
                
                // Settings
                settingsTitle: 'System Configuration',
                webhookUrl: 'Webhook URL',
                webhookPlaceholder: 'Enter n8n/Make webhook URL',
                enableWebhook: 'Enable Webhook',
                saveConfig: 'Save Configuration',
                testConnection: 'Test Connection',
                
                // Notifications
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                linkGenerated: 'Link generated!',
                configSaved: 'Configuration saved!',
                reportSubmitted: 'Report submitted successfully!',
                
                // Errors
                linkExpired: 'This link has expired',
                linkLimitReached: 'This link has reached its user limit',
                fillRequired: 'Please fill all required fields',
                noDataFound: 'No data found',
                
                // Misc
                quantitiesPricing: 'Quantities & Pricing',
                costAnalysis: 'Cost Analysis'
            },
            ar: {
                // App Header
                appTitle: 'ÙØ¸Ø§Ù Ø¥Ø¯Ø§Ø±Ø© ÙØ´Ø§Ø±ÙØ¹ HAz ÙÙØ¨ÙØ§Ø¡',
                appSubtitle: 'Ø§ÙÙÙÙÙØ© Ø§ÙØ¹Ø±Ø¨ÙØ© Ø§ÙØ³Ø¹ÙØ¯ÙØ© - Ø¥Ø¯Ø§Ø±Ø© Ø§ÙØªÙØ§ÙÙÙ ÙØªØªØ¨Ø¹ Ø§ÙØªÙØ¯Ù',
                
                // Tabs
                tabDaily: 'Ø§ÙØªÙØ±ÙØ± Ø§ÙÙÙÙÙ',
                tabWeekly: 'Ø§ÙØªÙØ±ÙØ± Ø§ÙØ£Ø³Ø¨ÙØ¹Ù',
                tabMonthly: 'Ø§ÙØªÙØ±ÙØ± Ø§ÙØ´ÙØ±Ù (EVM)',
                tabSettings: 'Ø§ÙØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                
                // Authentication
                login: 'ØªØ³Ø¬ÙÙ Ø§ÙØ¯Ø®ÙÙ',
                register: 'ØªØ³Ø¬ÙÙ Ø­Ø³Ø§Ø¨',
                logout: 'ØªØ³Ø¬ÙÙ Ø§ÙØ®Ø±ÙØ¬',
                email: 'Ø§ÙØ¨Ø±ÙØ¯ Ø§ÙØ¥ÙÙØªØ±ÙÙÙ',
                password: 'ÙÙÙØ© Ø§ÙÙØ±ÙØ±',
                confirmPassword: 'ØªØ£ÙÙØ¯ ÙÙÙØ© Ø§ÙÙØ±ÙØ±',
                fullName: 'Ø§ÙØ§Ø³Ù Ø§ÙÙØ§ÙÙ',
                companyName: 'Ø§Ø³Ù Ø§ÙØ´Ø±ÙØ©',
                phone: 'Ø±ÙÙ Ø§ÙÙØ§ØªÙ',
                forgotPassword: 'ÙØ³ÙØª ÙÙÙØ© Ø§ÙÙØ±ÙØ±Ø',
                createAccount: 'Ø¥ÙØ´Ø§Ø¡ Ø­Ø³Ø§Ø¨',
                authWelcome: 'ÙÙØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§ÙÙØ´Ø§Ø±ÙØ¹ Ø§ÙØ¢ÙÙØ©',
                registerNote: 'Ø§ÙØ­Ø³Ø§Ø¨ ÙØªØ·ÙØ¨ ÙÙØ§ÙÙØ© Ø§ÙÙØ³Ø¤ÙÙ',
                pendingTitle: 'Ø§ÙØ­Ø³Ø§Ø¨ ÙÙ Ø§ÙØªØ¸Ø§Ø± Ø§ÙÙÙØ§ÙÙØ©',
                pendingMessage: 'Ø­Ø³Ø§Ø¨Ù ÙÙ Ø§ÙØªØ¸Ø§Ø± ÙÙØ§ÙÙØ© Ø§ÙÙØ³Ø¤ÙÙ. Ø³ÙØªÙ Ø¥Ø±Ø³Ø§Ù Ø¨Ø±ÙØ¯ Ø¥ÙÙØªØ±ÙÙÙ Ø¥ÙÙÙ Ø¨ÙØ¬Ø±Ø¯ ØªÙØ¹ÙÙ Ø­Ø³Ø§Ø¨Ù. Ø¹Ø§Ø¯Ø© ÙØ§ ÙØ³ØªØºØ±Ù Ø°ÙÙ 1-2 ÙÙÙ Ø¹ÙÙ.',
                blockedTitle: 'Ø§ÙØ­Ø³Ø§Ø¨ ÙØ­Ø¸ÙØ±',
                blockedMessage: 'ØªÙ Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ù. ÙØ±Ø¬Ù Ø§ÙØ§ØªØµØ§Ù Ø¨Ø§ÙÙØ³Ø¤ÙÙ ÙÙØ­ØµÙÙ Ø¹ÙÙ ÙØ²ÙØ¯ ÙÙ Ø§ÙÙØ¹ÙÙÙØ§Øª.',
                
                // Admin Panel
                adminPanel: 'ÙÙØ­Ø© Ø§ÙØ¥Ø¯Ø§Ø±Ø©',
                adminDescription: 'Ø¥Ø¯Ø§Ø±Ø© ÙØµÙÙ Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ Ø¯ÙÙ Ø¹Ø±Ø¶ Ø¨ÙØ§ÙØ§Øª ÙØ´Ø§Ø±ÙØ¹ÙÙ. ÙÙØ§ÙÙØ© Ø£Ù Ø­Ø¸Ø± Ø£Ù Ø¥Ø²Ø§ÙØ© Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ.',
                totalUsers: 'Ø¥Ø¬ÙØ§ÙÙ Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ',
                activeUsers: 'Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ Ø§ÙÙØ´Ø·ÙÙ',
                pendingApproval: 'ÙÙ Ø§ÙØªØ¸Ø§Ø± Ø§ÙÙÙØ§ÙÙØ©',
                blockedUsers: 'Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ Ø§ÙÙØ­Ø¸ÙØ±ÙÙ',
                registeredUsers: 'Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ Ø§ÙÙØ³Ø¬ÙÙÙ',
                status: 'Ø§ÙØ­Ø§ÙØ©',
                registeredDate: 'ØªØ§Ø±ÙØ® Ø§ÙØªØ³Ø¬ÙÙ',
                actions: 'Ø§ÙØ¥Ø¬Ø±Ø§Ø¡Ø§Øª',
                approve: 'ÙÙØ§ÙÙØ©',
                block: 'Ø­Ø¸Ø±',
                unblock: 'Ø¥ÙØºØ§Ø¡ Ø§ÙØ­Ø¸Ø±',
                loadingUsers: 'Ø¬Ø§Ø±Ù ØªØ­ÙÙÙ Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ...',
                noUsersFound: 'ÙÙ ÙØªÙ Ø§ÙØ¹Ø«ÙØ± Ø¹ÙÙ ÙØ³ØªØ®Ø¯ÙÙÙ',
                
                // Common Labels
                projectCode: 'Ø±ÙØ² Ø§ÙÙØ´Ø±ÙØ¹',
                projectName: 'Ø§Ø³Ù Ø§ÙÙØ´Ø±ÙØ¹',
                reportDate: 'ØªØ§Ø±ÙØ® Ø§ÙØªÙØ±ÙØ±',
                notes: 'ÙÙØ§Ø­Ø¸Ø§Øª',
                submit: 'Ø¥Ø±Ø³Ø§Ù',
                save: 'Ø­ÙØ¸',
                cancel: 'Ø¥ÙØºØ§Ø¡',
                delete: 'Ø­Ø°Ù',
                edit: 'ØªØ¹Ø¯ÙÙ',
                add: 'Ø¥Ø¶Ø§ÙØ©',
                remove: 'Ø¥Ø²Ø§ÙØ©',
                required: 'ÙØ·ÙÙØ¨',
                optional: 'Ø§Ø®ØªÙØ§Ø±Ù',
                calculated: 'ÙØ­Ø³ÙØ¨',
                total: 'Ø§ÙØ¥Ø¬ÙØ§ÙÙ',
                subtotal: 'Ø§ÙÙØ¬ÙÙØ¹ Ø§ÙÙØ±Ø¹Ù',
                
                // Daily Report
                dailyFormTitle: 'ØªÙØ±ÙØ± Ø§ÙØ¹ÙØ§ÙØ© ÙØ§ÙÙØ¹Ø¯Ø§Øª Ø§ÙÙÙÙÙ',
                crewLinkSection: 'Ø±Ø§Ø¨Ø· Ø¥Ø¯Ø®Ø§Ù Ø¨ÙØ§ÙØ§Øª Ø§ÙØ·Ø§ÙÙ',
                crewLinkDesc: 'Ø¥ÙØ´Ø§Ø¡ Ø±Ø§Ø¨Ø· ÙØ¥Ø±Ø³Ø§ÙÙ Ø¥ÙÙ ÙØ´Ø±ÙÙ Ø§ÙØ·Ø§ÙÙ ÙØ¥Ø¯Ø®Ø§Ù Ø¨ÙØ§ÙØ§Øª Ø§ÙÙÙÙØ¹ ÙØ§ÙØ¹ÙØ§ÙØ© ÙØ§ÙÙØ¹Ø¯Ø§Øª.',
                generateCrewLink: 'Ø¥ÙØ´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§ÙØ·Ø§ÙÙ',
                linkValidFor: 'ØµÙØ§Ø­ÙØ© Ø§ÙØ±Ø§Ø¨Ø·',
                maxUsers: 'Ø§ÙØ­Ø¯ Ø§ÙØ£ÙØµÙ ÙÙÙØ³ØªØ®Ø¯ÙÙÙ',
                unlimited: 'ØºÙØ± ÙØ­Ø¯ÙØ¯',
                copyLink: 'ÙØ³Ø® Ø§ÙØ±Ø§Ø¨Ø·',
                linkCopied: 'ØªÙ ÙØ³Ø® Ø§ÙØ±Ø§Ø¨Ø·!',
                linkExpiry: 'ÙÙØªÙÙ ÙÙ',
                linkUsed: 'ÙØ³ØªØ®Ø¯Ù',
                
                // Work Items
                workItems: 'Ø¨ÙÙØ¯ Ø§ÙØ¹ÙÙ',
                workItem: 'Ø¨ÙØ¯ Ø§ÙØ¹ÙÙ',
                addWorkItem: 'Ø¥Ø¶Ø§ÙØ© Ø¨ÙØ¯ Ø¹ÙÙ Ø¢Ø®Ø±',
                itemNo: 'Ø±ÙÙ Ø§ÙØ¨ÙØ¯',
                itemDescription: 'ÙØµÙ Ø§ÙØ¨ÙØ¯',
                itemSubtotal: 'Ø§ÙÙØ¬ÙÙØ¹ Ø§ÙÙØ±Ø¹Ù ÙÙØ¨ÙØ¯',
                
                // Manpower
                manpower: 'Ø§ÙÙÙÙ Ø§ÙØ¹Ø§ÙÙØ©',
                laborCategory: 'ÙØ¦Ø© Ø§ÙØ¹ÙØ§ÙØ©',
                count: 'Ø§ÙØ¹Ø¯Ø¯',
                hours: 'Ø§ÙØ³Ø§Ø¹Ø§Øª',
                costPerHour: 'Ø§ÙØªÙÙÙØ©/Ø§ÙØ³Ø§Ø¹Ø© (Ø±ÙØ§Ù)',
                addManpower: 'Ø¥Ø¶Ø§ÙØ© Ø¹ÙØ§ÙØ©',
                
                // Equipment
                equipment: 'Ø§ÙÙØ¹Ø¯Ø§Øª',
                equipmentType: 'ÙÙØ¹ Ø§ÙÙØ¹Ø¯Ø§Øª',
                quantity: 'Ø§ÙÙÙÙØ©',
                addEquipment: 'Ø¥Ø¶Ø§ÙØ© ÙØ¹Ø¯Ø§Øª',
                
                // Subcontractor
                subcontractor: 'ÙÙØ§ÙÙ ÙÙ Ø§ÙØ¨Ø§Ø·Ù',
                subcontractorForItem: 'ÙÙØ§ÙÙ Ø§ÙØ¨Ø§Ø·Ù ÙÙØ°Ø§ Ø§ÙØ¨ÙØ¯',
                includeSubcontractor: 'ØªØ¶ÙÙÙ ÙÙØ§ÙÙ Ø¨Ø§Ø·Ù',
                companyName: 'Ø§Ø³Ù Ø§ÙØ´Ø±ÙØ©',
                contactPerson: 'Ø¬ÙØ© Ø§ÙØ§ØªØµØ§Ù',
                rate: 'Ø§ÙØ³Ø¹Ø± (Ø±ÙØ§Ù)',
                expenses: 'Ø§ÙÙØµØ±ÙÙØ§Øª (+)',
                deductions: 'Ø§ÙØ®ØµÙÙØ§Øª (-)',
                netAmount: 'Ø§ÙÙØ¨ÙØº Ø§ÙØµØ§ÙÙ (Ø±ÙØ§Ù)',
                addSubcontractor: 'Ø¥Ø¶Ø§ÙØ© ÙÙØ§ÙÙ Ø¨Ø§Ø·Ù',
                
                // Location
                location: 'Ø§ÙÙÙÙØ¹',
                useDeviceGPS: 'Ø§Ø³ØªØ®Ø¯Ø§Ù GPS Ø§ÙØ¬ÙØ§Ø²',
                pickFromMap: 'Ø§Ø®ØªÙØ§Ø± ÙÙ Ø§ÙØ®Ø±ÙØ·Ø©',
                getLocation: 'Ø§ÙØ­ØµÙÙ Ø¹ÙÙ Ø§ÙÙÙÙØ¹ Ø§ÙØ­Ø§ÙÙ',
                latitude: 'Ø®Ø· Ø§ÙØ¹Ø±Ø¶',
                longitude: 'Ø®Ø· Ø§ÙØ·ÙÙ',
                
                // Photos
                photos: 'Ø§ÙØµÙØ±',
                attachPhotos: 'Ø¥Ø±ÙØ§Ù ØµÙØ±',
                
                // Crew Submissions
                crewSubmissions: 'ØªÙØ§Ø±ÙØ± Ø§ÙØ·Ø§ÙÙ',
                noSubmissions: 'ÙØ§ ØªÙØ¬Ø¯ ØªÙØ§Ø±ÙØ± Ø¨Ø¹Ø¯',
                dailyTotal: 'Ø§ÙØ¥Ø¬ÙØ§ÙÙ Ø§ÙÙÙÙÙ',
                viewSubmission: 'Ø¹Ø±Ø¶',
                
                // Weekly Report
                weeklyFormTitle: 'ØªÙØ±ÙØ± Ø§ÙØªÙØ¯Ù Ø§ÙØ£Ø³Ø¨ÙØ¹Ù',
                weekStartDate: 'ØªØ§Ø±ÙØ® Ø¨Ø¯Ø§ÙØ© Ø§ÙØ£Ø³Ø¨ÙØ¹',
                weekEndDate: 'ØªØ§Ø±ÙØ® ÙÙØ§ÙØ© Ø§ÙØ£Ø³Ø¨ÙØ¹',
                progressItems: 'Ø¨ÙÙØ¯ Ø§ÙØªÙØ¯Ù',
                importFromDaily: 'Ø§Ø³ØªÙØ±Ø§Ø¯ ÙÙ Ø§ÙØªÙØ§Ø±ÙØ± Ø§ÙÙÙÙÙØ©',
                plannedQty: 'Ø§ÙÙÙÙØ© Ø§ÙÙØ®Ø·Ø·Ø©',
                completedQtyDaily: 'Ø§ÙÙÙÙØ© Ø§ÙÙÙØ¬Ø²Ø© (ÙÙÙÙ)',
                adjustQty: 'ØªØ¹Ø¯ÙÙ Ø§ÙÙÙÙØ© (+/-)',
                finalCompletedQty: 'Ø§ÙÙÙÙØ© Ø§ÙÙÙØ§Ø¦ÙØ© Ø§ÙÙÙØ¬Ø²Ø©',
                unit: 'Ø§ÙÙØ­Ø¯Ø©',
                unitPrice: 'Ø³Ø¹Ø± Ø§ÙÙØ­Ø¯Ø© (Ø±ÙØ§Ù)',
                earnedValue: 'Ø§ÙÙÙÙØ© Ø§ÙÙÙØªØ³Ø¨Ø© (EV)',
                acDaily: 'Ø§ÙØªÙÙÙØ© Ø§ÙÙØ¹ÙÙØ© (ÙÙÙÙ)',
                acAdjust: 'ØªØ¹Ø¯ÙÙ Ø§ÙØªÙÙÙØ© (+/-)',
                finalActualCost: 'Ø§ÙØªÙÙÙØ© Ø§ÙÙØ¹ÙÙØ© Ø§ÙÙÙØ§Ø¦ÙØ© (AC)',
                costVariance: 'Ø§ÙØ­Ø±Ø§Ù Ø§ÙØªÙÙÙØ© (CV)',
                completionPct: 'ÙØ³Ø¨Ø© Ø§ÙØ¥ÙØ¬Ø§Ø² %',
                addProgressItem: 'Ø¥Ø¶Ø§ÙØ© Ø¨ÙØ¯ ØªÙØ¯Ù',
                weeklySummary: 'ÙÙØ®Øµ Ø§ÙØ£Ø³Ø¨ÙØ¹',
                totalEV: 'Ø¥Ø¬ÙØ§ÙÙ Ø§ÙÙÙÙØ© Ø§ÙÙÙØªØ³Ø¨Ø©',
                totalAC: 'Ø¥Ø¬ÙØ§ÙÙ Ø§ÙØªÙÙÙØ© Ø§ÙÙØ¹ÙÙØ©',
                totalCV: 'Ø¥Ø¬ÙØ§ÙÙ Ø§ÙØ­Ø±Ø§Ù Ø§ÙØªÙÙÙØ©',
                avgCompletion: 'ÙØªÙØ³Ø· Ø§ÙØ¥ÙØ¬Ø§Ø²',
                costVarianceHistogram: 'ÙØ®Ø·Ø· Ø§ÙØ­Ø±Ø§Ù Ø§ÙØªÙÙÙØ©',
                refreshChart: 'ØªØ­Ø¯ÙØ« Ø§ÙÙØ®Ø·Ø·',
                positiveVariance: 'Ø§ÙØ­Ø±Ø§Ù Ø¥ÙØ¬Ø§Ø¨Ù (ØªØ­Øª Ø§ÙÙÙØ²Ø§ÙÙØ©)',
                negativeVariance: 'Ø§ÙØ­Ø±Ø§Ù Ø³ÙØ¨Ù (ÙÙÙ Ø§ÙÙÙØ²Ø§ÙÙØ©)',
                submitWeekly: 'Ø¥Ø±Ø³Ø§Ù Ø§ÙØªÙØ±ÙØ± Ø§ÙØ£Ø³Ø¨ÙØ¹Ù',
                
                // Monthly Report (EVM)
                monthlyFormTitle: 'Ø§ÙØªÙØ±ÙØ± Ø§ÙØ´ÙØ±Ù - Ø¥Ø¯Ø§Ø±Ø© Ø§ÙÙÙÙØ© Ø§ÙÙÙØªØ³Ø¨Ø©',
                evmInfo: 'ÙÙØ§ÙÙØ³ EVM',
                bac: 'Ø§ÙÙÙØ²Ø§ÙÙØ© Ø¹ÙØ¯ Ø§ÙØ§ÙØªÙØ§Ù (BAC)',
                pv: 'Ø§ÙÙÙÙØ© Ø§ÙÙØ®Ø·Ø·Ø© (PV)',
                ev: 'Ø§ÙÙÙÙØ© Ø§ÙÙÙØªØ³Ø¨Ø© (EV)',
                ac: 'Ø§ÙØªÙÙÙØ© Ø§ÙÙØ¹ÙÙØ© (AC)',
                cv: 'Ø§ÙØ­Ø±Ø§Ù Ø§ÙØªÙÙÙØ© (CV)',
                sv: 'Ø§ÙØ­Ø±Ø§Ù Ø§ÙØ¬Ø¯ÙÙ Ø§ÙØ²ÙÙÙ (SV)',
                cpi: 'ÙØ¤Ø´Ø± Ø£Ø¯Ø§Ø¡ Ø§ÙØªÙÙÙØ© (CPI)',
                spi: 'ÙØ¤Ø´Ø± Ø£Ø¯Ø§Ø¡ Ø§ÙØ¬Ø¯ÙÙ (SPI)',
                eac: 'Ø§ÙØªÙØ¯ÙØ± Ø¹ÙØ¯ Ø§ÙØ§ÙØªÙØ§Ù (EAC)',
                etc: 'Ø§ÙØªÙØ¯ÙØ± ÙÙØ¥ÙÙØ§Ù (ETC)',
                vac: 'Ø§ÙØ§ÙØ­Ø±Ø§Ù Ø¹ÙØ¯ Ø§ÙØ§ÙØªÙØ§Ù (VAC)',
                tcpi: 'ÙØ¤Ø´Ø± Ø§ÙØ£Ø¯Ø§Ø¡ ÙÙØ¥ÙÙØ§Ù (TCPI)',
                calculateEVM: 'Ø­Ø³Ø§Ø¨ EVM',
                submitMonthly: 'Ø¥Ø±Ø³Ø§Ù Ø§ÙØªÙØ±ÙØ± Ø§ÙØ´ÙØ±Ù',
                
                // Settings
                settingsTitle: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙÙØ¸Ø§Ù',
                webhookUrl: 'Ø±Ø§Ø¨Ø· Webhook',
                webhookPlaceholder: 'Ø£Ø¯Ø®Ù Ø±Ø§Ø¨Ø· n8n/Make webhook',
                enableWebhook: 'ØªÙØ¹ÙÙ Webhook',
                saveConfig: 'Ø­ÙØ¸ Ø§ÙØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
                testConnection: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§ÙØ§ØªØµØ§Ù',
                
                // Notifications
                success: 'ÙØ¬Ø§Ø­',
                error: 'Ø®Ø·Ø£',
                warning: 'ØªØ­Ø°ÙØ±',
                linkGenerated: 'ØªÙ Ø¥ÙØ´Ø§Ø¡ Ø§ÙØ±Ø§Ø¨Ø·!',
                configSaved: 'ØªÙ Ø­ÙØ¸ Ø§ÙØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª!',
                reportSubmitted: 'ØªÙ Ø¥Ø±Ø³Ø§Ù Ø§ÙØªÙØ±ÙØ± Ø¨ÙØ¬Ø§Ø­!',
                
                // Errors
                linkExpired: 'Ø§ÙØªÙØª ØµÙØ§Ø­ÙØ© ÙØ°Ø§ Ø§ÙØ±Ø§Ø¨Ø·',
                linkLimitReached: 'ÙØµÙ ÙØ°Ø§ Ø§ÙØ±Ø§Ø¨Ø· ÙÙØ­Ø¯ Ø§ÙØ£ÙØµÙ ÙÙ Ø§ÙÙØ³ØªØ®Ø¯ÙÙÙ',
                fillRequired: 'ÙØ±Ø¬Ù ÙÙØ¡ Ø¬ÙÙØ¹ Ø§ÙØ­ÙÙÙ Ø§ÙÙØ·ÙÙØ¨Ø©',
                noDataFound: 'ÙÙ ÙØªÙ Ø§ÙØ¹Ø«ÙØ± Ø¹ÙÙ Ø¨ÙØ§ÙØ§Øª',
                
                // Misc
                quantitiesPricing: 'Ø§ÙÙÙÙØ§Øª ÙØ§ÙØªØ³Ø¹ÙØ±',
                costAnalysis: 'ØªØ­ÙÙÙ Ø§ÙØªÙØ§ÙÙÙ'
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('hazLang', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            const html = document.documentElement;
            const langToggle = document.querySelector('.lang-toggle');
            const langText = document.querySelector('.lang-text');
            
            // Set direction and lang attribute
            if (currentLang === 'ar') {
                html.setAttribute('dir', 'rtl');
                html.setAttribute('lang', 'ar');
                langToggle.classList.add('arabic');
                langText.textContent = 'Ø¹Ø±Ø¨Ù';
            } else {
                html.setAttribute('dir', 'ltr');
                html.setAttribute('lang', 'en');
                langToggle.classList.remove('arabic');
                langText.textContent = 'EN';
            }
            
            // Apply translations to elements with data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLang][key]) {
                    // Check if it has HTML content (like required asterisk)
                    if (el.querySelector('span')) {
                        const span = el.querySelector('span');
                        el.childNodes[0].textContent = translations[currentLang][key] + ' ';
                    } else {
                        el.textContent = translations[currentLang][key];
                    }
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-placeholder-en]').forEach(el => {
                const key = currentLang === 'en' ? 'data-placeholder-en' : 'data-placeholder-ar';
                el.placeholder = el.getAttribute(key) || el.placeholder;
            });
        }

        function t(key) {
            return translations[currentLang][key] || key;
        }

        // =============================================
        // AUTHENTICATION SYSTEM
        // =============================================
        
        let supabase = null;
        let currentUser = null;
        let userProfile = null;

        // Initialize Supabase client
        function initSupabase() {
            const supabaseUrl = localStorage.getItem('supabaseUrl');
            const supabaseKey = localStorage.getItem('supabaseAnonKey');
            
            if (supabaseUrl && supabaseKey) {
                try {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    return true;
                } catch (e) {
                    console.error('Failed to initialize Supabase:', e);
                    return false;
                }
            }
            return false;
        }

        // Check authentication state on page load
        async function checkAuthState() {
            // Skip auth check for crew links
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('crew')) {
                document.getElementById('authOverlay').classList.add('hidden');
                return;
            }

            if (!initSupabase()) {
                // No Supabase configured - show auth overlay with setup message
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('userMenu').style.display = 'none';
                return;
            }

            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                    handleAuthenticatedUser();
                } else {
                    showAuthOverlay();
                }
            } catch (e) {
                console.error('Auth check failed:', e);
                showAuthOverlay();
            }
        }

        // Load user profile from database
        async function loadUserProfile() {
            if (!currentUser || !supabase) return;

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                userProfile = data;
            } catch (e) {
                console.error('Failed to load user profile:', e);
                userProfile = null;
            }
        }

        // Handle authenticated user
        function handleAuthenticatedUser() {
            if (!userProfile) {
                showAuthOverlay();
                return;
            }

            // Check user status
            if (userProfile.status === 'pending') {
                showPendingScreen();
                return;
            }

            if (userProfile.status === 'blocked') {
                showBlockedScreen();
                return;
            }

            // User is active - show main app
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('pendingScreen').classList.add('hidden');
            document.getElementById('blockedScreen').classList.add('hidden');
            
            // Show user menu
            document.getElementById('userMenu').style.display = 'flex';
            updateUserMenu();

            // Show admin panel for admins
            if (userProfile.role === 'admin') {
                document.getElementById('adminTabBtn').style.display = 'flex';
                document.getElementById('adminPanelBtn').style.display = 'flex';
                document.querySelector('.user-avatar').classList.add('admin');
                loadAdminData();
            }
        }

        // Update user menu with current user info
        function updateUserMenu() {
            if (!userProfile) return;

            const initials = userProfile.full_name
                ? userProfile.full_name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                : 'U';
            
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('dropdownUserName').textContent = userProfile.full_name || 'User';
            document.getElementById('dropdownUserEmail').textContent = currentUser.email;
            
            const roleEl = document.getElementById('dropdownUserRole');
            roleEl.textContent = userProfile.role === 'admin' ? 'Admin' : 'User';
            roleEl.className = `user-role ${userProfile.role}`;
        }

        // Show auth overlay
        function showAuthOverlay() {
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('pendingScreen').classList.add('hidden');
            document.getElementById('blockedScreen').classList.add('hidden');
            document.getElementById('userMenu').style.display = 'none';
        }

        // Show pending approval screen
        function showPendingScreen() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('pendingScreen').classList.remove('hidden');
            document.getElementById('blockedScreen').classList.add('hidden');
            document.getElementById('userMenu').style.display = 'none';
        }

        // Show blocked screen
        function showBlockedScreen() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('pendingScreen').classList.add('hidden');
            document.getElementById('blockedScreen').classList.remove('hidden');
            document.getElementById('userMenu').style.display = 'none';
        }

        // Show auth tab
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            document.querySelector(`.auth-tab[onclick="showAuthTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
            
            // Clear errors
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('registerError').classList.remove('show');
            document.getElementById('loginSuccess').classList.remove('show');
            document.getElementById('registerSuccess').classList.remove('show');
        }

        // Handle login
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            const successEl = document.getElementById('loginSuccess');
            const btn = document.getElementById('loginBtn');
            
            errorEl.classList.remove('show');
            successEl.classList.remove('show');
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span> Logging in...';

            if (!supabase) {
                if (!initSupabase()) {
                    errorEl.textContent = 'Please configure Supabase in Settings first';
                    errorEl.classList.add('show');
                    btn.disabled = false;
                    btn.innerHTML = '<span data-translate="login">Login</span> â';
                    return;
                }
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                await loadUserProfile();
                
                successEl.textContent = 'Login successful!';
                successEl.classList.add('show');
                
                setTimeout(() => {
                    handleAuthenticatedUser();
                }, 1000);

            } catch (e) {
                errorEl.textContent = e.message || 'Login failed. Please check your credentials.';
                errorEl.classList.add('show');
                btn.disabled = false;
                btn.innerHTML = '<span data-translate="login">Login</span> â';
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const company = document.getElementById('registerCompany').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            const errorEl = document.getElementById('registerError');
            const successEl = document.getElementById('registerSuccess');
            const btn = document.getElementById('registerBtn');
            
            errorEl.classList.remove('show');
            successEl.classList.remove('show');

            // Validate passwords match
            if (password !== passwordConfirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.add('show');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span>â³</span> Creating account...';

            if (!supabase) {
                if (!initSupabase()) {
                    errorEl.textContent = 'Please configure Supabase in Settings first';
                    errorEl.classList.add('show');
                    btn.disabled = false;
                    btn.innerHTML = '<span data-translate="createAccount">Create Account</span> â';
                    return;
                }
            }

            try {
                // Create auth user
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            company: company,
                            phone: phone
                        }
                    }
                });

                if (authError) throw authError;

                // Create profile record
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert([{
                        id: authData.user.id,
                        email: email,
                        full_name: name,
                        company: company,
                        phone: phone,
                        role: 'user',
                        status: 'pending'
                    }]);

                if (profileError) throw profileError;

                successEl.textContent = 'Account created! Awaiting admin approval.';
                successEl.classList.add('show');
                
                // Clear form
                document.getElementById('registerForm').reset();
                document.getElementById('passwordStrengthBar').className = 'password-strength-bar';
                
                // Switch to login after delay
                setTimeout(() => {
                    showAuthTab('login');
                    document.getElementById('loginSuccess').textContent = 'Account created! Please wait for admin approval before logging in.';
                    document.getElementById('loginSuccess').classList.add('show');
                }, 2000);

            } catch (e) {
                errorEl.textContent = e.message || 'Registration failed. Please try again.';
                errorEl.classList.add('show');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span data-translate="createAccount">Create Account</span> â';
        }

        // Handle logout
        async function handleLogout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            userProfile = null;
            
            // Hide user menu and admin buttons
            document.getElementById('userMenu').style.display = 'none';
            document.getElementById('adminTabBtn').style.display = 'none';
            document.getElementById('adminPanelBtn').style.display = 'none';
            document.querySelector('.user-avatar').classList.remove('admin');
            
            showAuthOverlay();
            
            // Clear form
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        // Toggle user dropdown
        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userDropdown');
            if (userMenu && !userMenu.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Check password strength
        function checkPasswordStrength(password) {
            const bar = document.getElementById('passwordStrengthBar');
            
            if (password.length < 6) {
                bar.className = 'password-strength-bar weak';
            } else if (password.length < 10 || !/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
                bar.className = 'password-strength-bar medium';
            } else {
                bar.className = 'password-strength-bar strong';
            }
        }

        // Forgot password
        async function showForgotPassword() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                document.getElementById('loginError').textContent = 'Please enter your email address first';
                document.getElementById('loginError').classList.add('show');
                return;
            }

            if (!supabase) {
                document.getElementById('loginError').textContent = 'Please configure Supabase in Settings first';
                document.getElementById('loginError').classList.add('show');
                return;
            }

            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email);
                if (error) throw error;
                
                document.getElementById('loginSuccess').textContent = 'Password reset email sent! Check your inbox.';
                document.getElementById('loginSuccess').classList.add('show');
            } catch (e) {
                document.getElementById('loginError').textContent = e.message || 'Failed to send reset email';
                document.getElementById('loginError').classList.add('show');
            }
        }

        // =============================================
        // ADMIN PANEL FUNCTIONS
        // =============================================

        let allUsers = [];

        // Load admin data
        async function loadAdminData() {
            if (!supabase || !userProfile || userProfile.role !== 'admin') return;

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allUsers = data || [];
                updateAdminStats();
                renderUsersTable(allUsers);
            } catch (e) {
                console.error('Failed to load admin data:', e);
            }
        }

        // Update admin stats
        function updateAdminStats() {
            const total = allUsers.length;
            const active = allUsers.filter(u => u.status === 'active').length;
            const pending = allUsers.filter(u => u.status === 'pending').length;
            const blocked = allUsers.filter(u => u.status === 'blocked').length;

            document.getElementById('statTotalUsers').textContent = total;
            document.getElementById('statActiveUsers').textContent = active;
            document.getElementById('statPendingUsers').textContent = pending;
            document.getElementById('statBlockedUsers').textContent = blocked;
        }

        // Render users table
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            ${t('noUsersFound')}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => {
                const statusClass = user.status;
                const statusText = user.status.charAt(0).toUpperCase() + user.status.slice(1);
                const date = new Date(user.created_at).toLocaleDateString();
                
                let actions = '';
                if (user.status === 'pending') {
                    actions = `
                        <button class="user-action-btn approve" onclick="approveUser('${user.id}')">
                            â ${t('approve')}
                        </button>
                        <button class="user-action-btn block" onclick="blockUser('${user.id}')">
                            â ${t('block')}
                        </button>
                    `;
                } else if (user.status === 'active') {
                    actions = `
                        <button class="user-action-btn block" onclick="blockUser('${user.id}')">
                            ð« ${t('block')}
                        </button>
                    `;
                } else if (user.status === 'blocked') {
                    actions = `
                        <button class="user-action-btn unblock" onclick="unblockUser('${user.id}')">
                            â ${t('unblock')}
                        </button>
                    `;
                }

                // Don't show actions for the current admin
                if (user.id === currentUser?.id) {
                    actions = '<span style="color: #666; font-size: 0.85rem;">You</span>';
                }

                return `
                    <tr>
                        <td><strong>${user.full_name || '-'}</strong></td>
                        <td>${user.company || '-'}</td>
                        <td>${user.email}</td>
                        <td><span class="user-status ${statusClass}">${statusText}</span></td>
                        <td>${date}</td>
                        <td>
                            <div class="user-actions">${actions}</div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter users
        function filterUsers(query) {
            const filtered = allUsers.filter(user => {
                const searchStr = `${user.full_name} ${user.company} ${user.email}`.toLowerCase();
                return searchStr.includes(query.toLowerCase());
            });
            renderUsersTable(filtered);
        }

        // Approve user
        async function approveUser(userId) {
            await updateUserStatus(userId, 'active');
        }

        // Block user
        async function blockUser(userId) {
            if (confirm('Are you sure you want to block this user?')) {
                await updateUserStatus(userId, 'blocked');
            }
        }

        // Unblock user
        async function unblockUser(userId) {
            await updateUserStatus(userId, 'active');
        }

        // Update user status
        async function updateUserStatus(userId, status) {
            if (!supabase) return;

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ status })
                    .eq('id', userId);

                if (error) throw error;

                showNotification(`User ${status === 'active' ? 'approved' : status}!`, 'success');
                await loadAdminData();
            } catch (e) {
                showNotification('Failed to update user: ' + e.message, 'error');
            }
        }

        let equipmentCount = 1;
        let subcontractorCount = 1;
        let materialCount = 1;
        let manpowerCount = 1;
        let crewManpowerCount = 1;
        let crewEquipmentCount = 1;
        let workItemCount = 1;
        let itemManpowerCounts = {0: 1};
        let itemEquipmentCounts = {0: 1};
        let itemSubcontractorCounts = {0: 1};
        let progressItemCount = 1;

        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved language
            applyLanguage();
            
            // Check authentication state
            checkAuthState();
            
            // Check if this is a crew link
            checkCrewMode();
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = today;
            });
            loadConfig();
            
            // Update crew submissions list and daily total (for main page)
            updateCrewSubmissionsList();
            calculateDailyTotal();
        });

        function checkCrewMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const crewData = urlParams.get('crew');
            
            if (crewData) {
                try {
                    // Decode data (handle both old and new encoding)
                    let jsonString;
                    try {
                        jsonString = decodeURIComponent(escape(atob(crewData)));
                    } catch (e) {
                        // Fallback for old encoding
                        jsonString = atob(crewData);
                    }
                    
                    const data = JSON.parse(jsonString);
                    
                    // Check link expiry
                    if (data.expiresAt) {
                        const expiryTime = new Date(data.expiresAt);
                        const now = new Date();
                        
                        if (now > expiryTime) {
                            showNotification('â This link has expired. Please request a new link from your supervisor.', 'error');
                            document.body.innerHTML = `
                                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white;">
                                    <div style="font-size: 4rem; margin-bottom: 20px;">â°</div>
                                    <h1 style="font-size: 2rem; margin-bottom: 15px;">Link Expired</h1>
                                    <p style="font-size: 1.1rem; opacity: 0.8; max-width: 400px;">This crew data entry link has expired. Please contact your project manager for a new link.</p>
                                    <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.6;">Expired: ${expiryTime.toLocaleString()}</p>
                                </div>
                            `;
                            return;
                        }
                    }
                    
                    // Check max users (if linkId exists, use localStorage to track usage)
                    if (data.linkId && data.maxUsers && data.maxUsers !== 'unlimited') {
                        const linkMetaKey = `crewLink_${data.linkId}`;
                        let linkMeta = localStorage.getItem(linkMetaKey);
                        
                        if (linkMeta) {
                            linkMeta = JSON.parse(linkMeta);
                            const maxUsers = parseInt(data.maxUsers);
                            
                            // Check if this is a new user or existing
                            const userKey = `crewUser_${data.linkId}`;
                            const existingUser = sessionStorage.getItem(userKey);
                            
                            if (!existingUser && linkMeta.usedCount >= maxUsers) {
                                showNotification('â This link has reached its maximum usage limit.', 'error');
                                document.body.innerHTML = `
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white;">
                                        <div style="font-size: 4rem; margin-bottom: 20px;">ð¥</div>
                                        <h1 style="font-size: 2rem; margin-bottom: 15px;">Link Usage Limit Reached</h1>
                                        <p style="font-size: 1.1rem; opacity: 0.8; max-width: 400px;">This crew data entry link has been used by the maximum number of users (${maxUsers}). Please contact your project manager for a new link.</p>
                                    </div>
                                `;
                                return;
                            }
                            
                            // Mark this user as having used the link
                            if (!existingUser) {
                                linkMeta.usedCount = (linkMeta.usedCount || 0) + 1;
                                localStorage.setItem(linkMetaKey, JSON.stringify(linkMeta));
                                sessionStorage.setItem(userKey, 'true');
                            }
                        }
                    }
                    
                    document.body.classList.add('crew-mode');
                    document.getElementById('mainPage').style.display = 'none';
                    document.getElementById('crewPage').style.display = 'block';
                    
                    // Populate crew form with project data (banner)
                    document.getElementById('crewProjectCode').textContent = data.projectCode || '-';
                    document.getElementById('crewProjectName').textContent = data.projectName || '-';
                    document.getElementById('crewReportDate').textContent = data.reportDate || '-';
                    
                    // Populate hidden form fields
                    document.getElementById('crewFormProjectCode').value = data.projectCode || '';
                    document.getElementById('crewFormProjectName').value = data.projectName || '';
                    document.getElementById('crewFormReportDate').value = data.reportDate || '';
                    
                    // Show validity info if available
                    if (data.expiresAt) {
                        const expiryTime = new Date(data.expiresAt);
                        const timeLeft = expiryTime - new Date();
                        const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                        const minsLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        
                        if (hoursLeft < 2) {
                            showNotification(`â ï¸ This link expires in ${hoursLeft}h ${minsLeft}m`, 'error');
                        }
                    }
                } catch (e) {
                    console.error('Invalid crew data:', e);
                    showNotification('Invalid crew link. Please request a new link.', 'error');
                }
            }
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.closest('.tab-btn').classList.add('active');
        }

        function toggleLocationType() {
            const locationType = document.querySelector('input[name="locationType"]:checked').value;
            document.getElementById('stationFields').classList.toggle('active', locationType === 'station');
            document.getElementById('mhFields').classList.toggle('active', locationType === 'mh');
        }

        function toggleCrewLocationType() {
            const locationType = document.querySelector('input[name="crewLocationType"]:checked').value;
            document.getElementById('crewStationFields').classList.toggle('active', locationType === 'station');
            document.getElementById('crewMhFields').classList.toggle('active', locationType === 'mh');
        }

        // KMZ File Handling
        let uploadedKmzData = null;

        function handleKmzUpload(input) {
            const file = input.files[0];
            if (file) {
                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();
                
                if (fileExt !== 'kmz' && fileExt !== 'kml') {
                    showNotification('Please upload a KMZ or KML file', 'error');
                    input.value = '';
                    return;
                }

                // Store file for later use
                uploadedKmzData = file;
                
                // Show file name
                let fileNameDisplay = document.getElementById('kmzFileName');
                if (!fileNameDisplay) {
                    fileNameDisplay = document.createElement('div');
                    fileNameDisplay.id = 'kmzFileName';
                    fileNameDisplay.className = 'kmz-file-name';
                    input.closest('.kmz-section').appendChild(fileNameDisplay);
                }
                
                fileNameDisplay.innerHTML = `
                    <span>ð ${fileName}</span>
                    <button type="button" class="remove-file" onclick="removeKmzFile()">â</button>
                `;
                fileNameDisplay.classList.add('show');
                
                // Clear URL field since we're using uploaded file
                document.getElementById('kmzUrl').value = '';
                
                showNotification('KMZ file uploaded successfully â', 'success');
            }
        }

        function removeKmzFile() {
            uploadedKmzData = null;
            document.getElementById('kmzFileInput').value = '';
            const fileNameDisplay = document.getElementById('kmzFileName');
            if (fileNameDisplay) {
                fileNameDisplay.classList.remove('show');
            }
        }

        function openKmzFile() {
            const kmzUrl = document.getElementById('kmzUrl').value.trim();
            
            if (uploadedKmzData) {
                // Create a blob URL for the uploaded file and trigger download/open
                const blobUrl = URL.createObjectURL(uploadedKmzData);
                
                // Try to open with Google Earth Web first
                // For KMZ files, we need to download them to open in Google Earth
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = uploadedKmzData.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('KMZ file downloaded. Open it with Google Earth to view the location.', 'success');
                
                // Clean up the blob URL after a short delay
                setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
                
            } else if (kmzUrl) {
                // Handle URL-based KMZ files
                let openUrl;
                
                // Check if it's a Google Drive link
                if (kmzUrl.includes('drive.google.com')) {
                    // Extract file ID from Google Drive link
                    let fileId = '';
                    
                    if (kmzUrl.includes('/file/d/')) {
                        fileId = kmzUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/)?.[1];
                    } else if (kmzUrl.includes('id=')) {
                        fileId = kmzUrl.match(/id=([a-zA-Z0-9_-]+)/)?.[1];
                    }
                    
                    if (fileId) {
                        // Open in Google Earth Web
                        openUrl = `https://earth.google.com/web/@0,0,0a,22251752.77375655d,35y,0h,0t,0r/data=MkEKPwo9CiExWDJfVXlOUXNUUXlLVGNmUXlNVXNXUXlOUXNUUXlLEhZnb29nbGUuY29tL2RyaXZlL2ZpbGVzLw`;
                        // Alternative: Direct download link
                        const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                        window.open(downloadUrl, '_blank');
                        showNotification('Opening Google Drive file. You may need Google Earth installed.', 'success');
                    } else {
                        window.open(kmzUrl, '_blank');
                    }
                } else if (kmzUrl.endsWith('.kmz') || kmzUrl.endsWith('.kml')) {
                    // Direct KMZ/KML file URL - try to open in Google Earth Web
                    const encodedUrl = encodeURIComponent(kmzUrl);
                    openUrl = `https://earth.google.com/web/@0,0,0a,22251752.77375655d,35y,0h,0t,0r/data=KML:${encodedUrl}`;
                    window.open(openUrl, '_blank');
                    showNotification('Opening in Google Earth Web...', 'success');
                } else {
                    // Try opening directly
                    window.open(kmzUrl, '_blank');
                    showNotification('Opening location file...', 'success');
                }
            } else {
                showNotification('Please upload a KMZ file or enter a URL first', 'error');
            }
        }

        // Crew KMZ File Handling
        let uploadedCrewKmzData = null;

        function handleCrewKmzUpload(input) {
            const file = input.files[0];
            if (file) {
                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();
                
                if (fileExt !== 'kmz' && fileExt !== 'kml') {
                    showNotification('Please upload a KMZ or KML file', 'error');
                    input.value = '';
                    return;
                }

                uploadedCrewKmzData = file;
                
                let fileNameDisplay = document.getElementById('crewKmzFileName');
                if (!fileNameDisplay) {
                    fileNameDisplay = document.createElement('div');
                    fileNameDisplay.id = 'crewKmzFileName';
                    fileNameDisplay.className = 'kmz-file-name';
                    input.closest('.kmz-section').appendChild(fileNameDisplay);
                }
                
                fileNameDisplay.innerHTML = `
                    <span>ð ${fileName}</span>
                    <button type="button" class="remove-file" onclick="removeCrewKmzFile()">â</button>
                `;
                fileNameDisplay.classList.add('show');
                
                document.getElementById('crewKmzUrl').value = '';
                showNotification('KMZ file uploaded successfully â', 'success');
            }
        }

        function removeCrewKmzFile() {
            uploadedCrewKmzData = null;
            document.getElementById('crewKmzFileInput').value = '';
            const fileNameDisplay = document.getElementById('crewKmzFileName');
            if (fileNameDisplay) {
                fileNameDisplay.classList.remove('show');
            }
        }

        function openCrewKmzFile() {
            const kmzUrl = document.getElementById('crewKmzUrl').value.trim();
            
            if (uploadedCrewKmzData) {
                const blobUrl = URL.createObjectURL(uploadedCrewKmzData);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = uploadedCrewKmzData.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification('KMZ file downloaded. Open it with Google Earth to view the location.', 'success');
                setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
            } else if (kmzUrl) {
                if (kmzUrl.includes('drive.google.com')) {
                    let fileId = '';
                    if (kmzUrl.includes('/file/d/')) {
                        fileId = kmzUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/)?.[1];
                    } else if (kmzUrl.includes('id=')) {
                        fileId = kmzUrl.match(/id=([a-zA-Z0-9_-]+)/)?.[1];
                    }
                    if (fileId) {
                        const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                        window.open(downloadUrl, '_blank');
                        showNotification('Opening Google Drive file...', 'success');
                    } else {
                        window.open(kmzUrl, '_blank');
                    }
                } else {
                    window.open(kmzUrl, '_blank');
                    showNotification('Opening location file...', 'success');
                }
            } else {
                showNotification('Please upload a KMZ file or enter a URL first', 'error');
            }
        }

        // Crew GPS Location Functions
        function getCrewCurrentLocation() {
            const statusEl = document.getElementById('crewLocationStatus');
            const btn = document.querySelector('#crewPage .gps-option-btn');
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'â Geolocation not supported';
                statusEl.className = 'location-status error';
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.querySelector('.gps-label').textContent = 'Getting location...';
            }
            statusEl.textContent = 'Accessing GPS...';
            statusEl.className = 'location-status';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    
                    document.getElementById('crewLatitude').value = lat;
                    document.getElementById('crewLongitude').value = lng;
                    
                    statusEl.textContent = `â Location: ${lat}, ${lng}`;
                    statusEl.className = 'location-status success';
                    
                    if (btn) {
                        btn.disabled = false;
                        btn.querySelector('.gps-label').textContent = 'Get My Location';
                    }
                    
                    updateCrewMapLinks();
                    showNotification('Location captured! â', 'success');
                },
                (error) => {
                    let errorMsg = 'Unable to get location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location permission denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out';
                            break;
                    }
                    statusEl.textContent = `â ${errorMsg}`;
                    statusEl.className = 'location-status error';
                    if (btn) {
                        btn.disabled = false;
                        btn.querySelector('.gps-label').textContent = 'Get My Location';
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Map Picker Functions
        let currentMapLat = 24.7136; // Default: Riyadh
        let currentMapLng = 46.6753;

        function openMapPicker() {
            const modal = document.getElementById('mapPickerModal');
            modal.classList.add('show');
            
            // Check if we already have coordinates
            const existingLat = document.getElementById('crewLatitude').value;
            const existingLng = document.getElementById('crewLongitude').value;
            
            if (existingLat && existingLng) {
                currentMapLat = parseFloat(existingLat);
                currentMapLng = parseFloat(existingLng);
            } else {
                // Try to get user's current location for initial map center
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            currentMapLat = position.coords.latitude;
                            currentMapLng = position.coords.longitude;
                            updateMapFrame();
                            document.getElementById('pickerLat').value = currentMapLat.toFixed(6);
                            document.getElementById('pickerLng').value = currentMapLng.toFixed(6);
                        },
                        () => {
                            // Use default if geolocation fails
                            updateMapFrame();
                        }
                    );
                }
            }
            
            document.getElementById('pickerLat').value = currentMapLat.toFixed(6);
            document.getElementById('pickerLng').value = currentMapLng.toFixed(6);
            updateMapFrame();
        }

        function closeMapPicker() {
            const modal = document.getElementById('mapPickerModal');
            modal.classList.remove('show');
        }

        function updateMapFrame() {
            const mapFrame = document.getElementById('mapFrame');
            // Use Google Maps embed with satellite view
            mapFrame.src = `https://maps.google.com/maps?q=${currentMapLat},${currentMapLng}&z=18&output=embed&t=k`;
        }

        function searchMapLocation() {
            const searchInput = document.getElementById('mapSearchInput').value.trim();
            if (!searchInput) {
                showNotification('Please enter a location to search', 'error');
                return;
            }
            
            // Open Google Maps search in the iframe
            const mapFrame = document.getElementById('mapFrame');
            mapFrame.src = `https://maps.google.com/maps?q=${encodeURIComponent(searchInput)}&z=15&output=embed&t=k`;
            
            showNotification('Map updated. Navigate to exact location and click "Set This Location"', 'success');
        }

        function goToCoordinates() {
            const lat = parseFloat(document.getElementById('pickerLat').value);
            const lng = parseFloat(document.getElementById('pickerLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showNotification('Please enter valid coordinates', 'error');
                return;
            }
            
            if (lat < -90 || lat > 90) {
                showNotification('Latitude must be between -90 and 90', 'error');
                return;
            }
            
            if (lng < -180 || lng > 180) {
                showNotification('Longitude must be between -180 and 180', 'error');
                return;
            }
            
            currentMapLat = lat;
            currentMapLng = lng;
            updateMapFrame();
            showNotification('Map centered on coordinates', 'success');
        }

        function updateMapFromCoords() {
            // This function is called on input, but we don't auto-update to avoid too many requests
            // User should click "Go" to update the map
        }

        function confirmMapLocation() {
            const lat = document.getElementById('pickerLat').value;
            const lng = document.getElementById('pickerLng').value;
            
            if (!lat || !lng) {
                showNotification('Please enter coordinates or search for a location', 'error');
                return;
            }
            
            // Set the coordinates in the crew form
            document.getElementById('crewLatitude').value = parseFloat(lat).toFixed(6);
            document.getElementById('crewLongitude').value = parseFloat(lng).toFixed(6);
            
            // Update the map links
            updateCrewMapLinks();
            
            // Update status
            const statusEl = document.getElementById('crewLocationStatus');
            statusEl.textContent = `â Location set: ${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}`;
            statusEl.className = 'location-status success';
            
            // Close the modal
            closeMapPicker();
            
            showNotification('Location set successfully! â', 'success');
        }

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('mapPickerModal');
            if (e.target === modal) {
                closeMapPicker();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMapPicker();
            }
        });

        function updateCrewMapLinks() {
            const lat = document.getElementById('crewLatitude').value;
            const lng = document.getElementById('crewLongitude').value;
            const mapButtonsEl = document.getElementById('crewMapButtons');
            
            if (lat && lng) {
                const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lng}&z=18`;
                document.getElementById('crewGoogleMapsLink').href = googleMapsUrl;
                mapButtonsEl.style.display = 'flex';
            } else {
                mapButtonsEl.style.display = 'none';
            }
        }

        function handleProfessionChange(select) {
            const customField = select.closest('.form-grid').querySelector('.custom-profession');
            if (select.value === 'other') {
                customField.style.display = 'block';
                customField.querySelector('input').required = true;
            } else {
                customField.style.display = 'none';
                customField.querySelector('input').required = false;
            }
        }

        // GPS Location Functions
        function getCurrentLocation() {
            const statusEl = document.getElementById('locationStatus');
            const btn = document.querySelector('.get-location-btn');
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'â Geolocation not supported by your browser';
                statusEl.className = 'location-status error';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'â³ Getting location...';
            statusEl.textContent = 'Accessing GPS...';
            statusEl.className = 'location-status';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lng;
                    
                    statusEl.textContent = `â Location captured: ${lat}, ${lng}`;
                    statusEl.className = 'location-status success';
                    
                    btn.disabled = false;
                    btn.innerHTML = 'ð Get My Location';
                    
                    updateMapLinks();
                    showNotification('Location captured successfully! â', 'success');
                },
                (error) => {
                    let errorMsg = 'Unable to get location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location permission denied. Please enable location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out';
                            break;
                    }
                    statusEl.textContent = `â ${errorMsg}`;
                    statusEl.className = 'location-status error';
                    btn.disabled = false;
                    btn.innerHTML = 'ð Get My Location';
                    showNotification(errorMsg, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function updateMapLinks() {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            const mapButtonsEl = document.getElementById('mapButtons');
            
            if (lat && lng) {
                const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lng}&z=18`;
                const googleEarthUrl = `https://earth.google.com/web/@${lat},${lng},0a,500d,35y,0h,0t,0r`;
                
                document.getElementById('googleMapsLink').href = googleMapsUrl;
                document.getElementById('googleEarthLink').href = googleEarthUrl;
                mapButtonsEl.style.display = 'flex';
            } else {
                mapButtonsEl.style.display = 'none';
            }
        }

        function generatePreview() {
            const previewContent = document.getElementById('previewContent');
            const submissions = getCrewSubmissions();
            
            if (submissions.length === 0) {
                showNotification('No crew submissions yet. Share the crew link first.', 'error');
                return;
            }
            
            // Calculate manpower costs from all crew submissions
            let manpowerTotal = 0;
            let manpowerHtml = '';
            submissions.forEach((sub, subIndex) => {
                // Handle workItems structure
                (sub.workItems || []).forEach(item => {
                    (item.manpower || []).forEach(m => {
                        let profession = m.profession;
                        if (profession === 'other') {
                            profession = m.customProfession || 'Other';
                        }
                        const count = parseFloat(m.count) || 0;
                        const hours = parseFloat(m.hours) || 0;
                        const costPerHour = parseFloat(m.costPerHour) || 0;
                        const cost = count * hours * costPerHour;
                        manpowerTotal += cost;
                        
                        if (profession && count > 0) {
                            manpowerHtml += `
                                <div class="preview-row">
                                    <span class="item-name">${profession} <small>(${sub.crewNumber || 'Crew'} - ${item.itemNo || ''})</small></span>
                                    <span class="item-details">${count} Ã ${hours}h Ã ${costPerHour} SAR</span>
                                    <span class="item-cost">${cost.toLocaleString()} SAR</span>
                                </div>
                            `;
                        }
                    });
                });
                
                // Fallback for old format
                if ((sub.workItems || []).length === 0) {
                    (sub.crewManpower || []).forEach(m => {
                        let profession = m.profession;
                        if (profession === 'other') {
                            profession = m.customProfession || 'Other';
                        }
                        const count = parseFloat(m.count) || 0;
                        const hours = parseFloat(m.hours) || 0;
                        const costPerHour = parseFloat(m.costPerHour) || 0;
                        const cost = count * hours * costPerHour;
                        manpowerTotal += cost;
                        
                        if (profession && count > 0) {
                            manpowerHtml += `
                                <div class="preview-row">
                                    <span class="item-name">${profession} <small>(${sub.crewNumber || 'Crew'})</small></span>
                                    <span class="item-details">${count} Ã ${hours}h Ã ${costPerHour} SAR</span>
                                    <span class="item-cost">${cost.toLocaleString()} SAR</span>
                                </div>
                            `;
                        }
                    });
                }
            });
            document.getElementById('manpowerPreviewTable').innerHTML = manpowerHtml || '<p style="color: #999; font-size: 0.9rem;">No manpower data from crews</p>';
            document.getElementById('manpowerTotalPreview').textContent = manpowerTotal.toLocaleString() + ' SAR';

            // Calculate equipment costs from all crew submissions
            let equipmentTotal = 0;
            let equipmentHtml = '';
            submissions.forEach((sub, subIndex) => {
                // Handle workItems structure
                (sub.workItems || []).forEach(item => {
                    (item.equipment || []).forEach(e => {
                        const name = e.name || '';
                        const qty = parseFloat(e.quantity) || 1;
                        const hours = parseFloat(e.hours) || 0;
                        const costPerHour = parseFloat(e.costPerHour) || 0;
                        const cost = qty * hours * costPerHour;
                        equipmentTotal += cost;
                        
                        if (name && hours > 0) {
                            equipmentHtml += `
                                <div class="preview-row">
                                    <span class="item-name">${name} ${qty > 1 ? `(Ã${qty})` : ''} <small>(${sub.crewNumber || 'Crew'} - ${item.itemNo || ''})</small></span>
                                    <span class="item-details">${qty} Ã ${hours}h Ã ${costPerHour} SAR</span>
                                    <span class="item-cost">${cost.toLocaleString()} SAR</span>
                                </div>
                            `;
                        }
                    });
                });
                
                // Fallback for old format
                if ((sub.workItems || []).length === 0) {
                    (sub.crewEquipment || []).forEach(e => {
                        const name = e.name || '';
                        const hours = parseFloat(e.hours) || 0;
                        const costPerHour = parseFloat(e.costPerHour) || 0;
                        const cost = hours * costPerHour;
                        equipmentTotal += cost;
                        
                        if (name && hours > 0) {
                            equipmentHtml += `
                                <div class="preview-row">
                                    <span class="item-name">${name} <small>(${sub.crewNumber || 'Crew'})</small></span>
                                    <span class="item-details">${hours}h Ã ${costPerHour} SAR</span>
                                    <span class="item-cost">${cost.toLocaleString()} SAR</span>
                                </div>
                            `;
                        }
                    });
                }
            });
            document.getElementById('equipmentPreviewTable').innerHTML = equipmentHtml || '<p style="color: #999; font-size: 0.9rem;">No equipment data from crews</p>';
            document.getElementById('equipmentTotalPreview').textContent = equipmentTotal.toLocaleString() + ' SAR';

            // Grand total
            const grandTotal = manpowerTotal + equipmentTotal;
            document.getElementById('grandTotalPreview').textContent = grandTotal.toLocaleString() + ' SAR';

            // Location preview from all crews
            let locationHtml = '';
            let totalLength = 0;
            
            submissions.forEach((sub, index) => {
                let locInfo = '';
                if (sub.crewLocationType === 'station') {
                    locInfo = `${sub.crewFromStation || ''} â ${sub.crewToStation || ''}`;
                } else {
                    locInfo = `${sub.crewFromMH || ''} â ${sub.crewToMH || ''}`;
                }
                
                const length = parseFloat(sub.crewLengthLm) || 0;
                totalLength += length;
                
                // Show work items if available
                let itemsInfo = '';
                if ((sub.workItems || []).length > 0) {
                    const itemNos = sub.workItems.map(i => i.itemNo).filter(Boolean).join(', ');
                    if (itemNos) itemsInfo = ` [Items: ${itemNos}]`;
                }
                
                locationHtml += `<div class="location-preview-item"><span class="icon">ð·</span><span><strong>${sub.crewNumber || 'Crew ' + (index+1)}:</strong> ${sub.lineName ? `[${sub.lineName}] ` : ''}${locInfo} (${length} L.m)${itemsInfo}</span></div>`;
                
                if (sub.crewLatitude && sub.crewLongitude) {
                    locationHtml += `
                        <div class="location-preview-map" style="margin-left: 25px; margin-bottom: 10px;">
                            <a href="https://www.google.com/maps?q=${sub.crewLatitude},${sub.crewLongitude}&z=18" target="_blank">
                                ðºï¸ View on Map
                            </a>
                        </div>
                    `;
                }
            });
            
            if (totalLength > 0) {
                locationHtml += `<div class="location-preview-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;"><span class="icon">ð</span><span><strong>Total Length:</strong> ${totalLength.toLocaleString()} L.m</span></div>`;
            }
            
            document.getElementById('locationPreviewContent').innerHTML = locationHtml || '<p style="color: #999;">No location data from crews</p>';

            previewContent.style.display = 'block';
            previewContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function exportToKMZ() {
            const submissions = getCrewSubmissions();
            
            if (submissions.length === 0) {
                showNotification('No crew submissions to export', 'error');
                return;
            }
            
            const projectCode = document.querySelector('input[name="projectCode"]').value || 'Project';
            const projectName = document.querySelector('input[name="projectName"]').value || '';
            const reportDate = document.querySelector('input[name="reportDate"]').value || new Date().toISOString().split('T')[0];
            
            // Calculate totals
            let manpowerTotal = 0;
            let equipmentTotal = 0;
            let manpowerDetails = [];
            let equipmentDetails = [];
            
            submissions.forEach(sub => {
                (sub.crewManpower || []).forEach(m => {
                    let profession = m.profession === 'other' ? m.customProfession : m.profession;
                    const count = parseFloat(m.count) || 0;
                    const hours = parseFloat(m.hours) || 0;
                    const costPerHour = parseFloat(m.costPerHour) || 0;
                    const cost = count * hours * costPerHour;
                    manpowerTotal += cost;
                    if (profession && count > 0) {
                        manpowerDetails.push(`${profession}: ${count} Ã ${hours}h = ${cost.toLocaleString()} SAR`);
                    }
                });
                
                (sub.crewEquipment || []).forEach(e => {
                    const name = e.name || '';
                    const hours = parseFloat(e.hours) || 0;
                    const costPerHour = parseFloat(e.costPerHour) || 0;
                    const cost = hours * costPerHour;
                    equipmentTotal += cost;
                    if (name && hours > 0) {
                        equipmentDetails.push(`${name}: ${hours}h = ${cost.toLocaleString()} SAR`);
                    }
                });
            });
            
            const grandTotal = manpowerTotal + equipmentTotal;

            // Build placemarks for each crew location
            let placemarks = '';
            submissions.forEach((sub, index) => {
                if (sub.crewLatitude && sub.crewLongitude) {
                    let locInfo = sub.crewLocationType === 'station' ? 
                        `${sub.crewFromStation || ''} â ${sub.crewToStation || ''}` : 
                        `${sub.crewFromMH || ''} â ${sub.crewToMH || ''}`;
                    
                    const crewManpowerCost = (sub.crewManpower || []).reduce((t, m) => 
                        t + ((parseFloat(m.count)||0) * (parseFloat(m.hours)||0) * (parseFloat(m.costPerHour)||0)), 0);
                    const crewEquipmentCost = (sub.crewEquipment || []).reduce((t, e) => 
                        t + ((parseFloat(e.hours)||0) * (parseFloat(e.costPerHour)||0)), 0);
                    const crewTotal = crewManpowerCost + crewEquipmentCost;
                    
                    placemarks += `
        <Placemark>
            <name>${sub.crewNumber || 'Crew ' + (index + 1)}</name>
            <description><![CDATA[
                <p><b>Supervisor:</b> ${sub.crewSupervisor || 'N/A'}</p>
                <p><b>Line:</b> ${sub.lineName || 'N/A'}</p>
                <p><b>Location:</b> ${locInfo}</p>
                <p><b>Length:</b> ${sub.crewLengthLm || 0} L.m</p>
                <hr>
                <p><b>Manpower Cost:</b> ${crewManpowerCost.toLocaleString()} SAR</p>
                <p><b>Equipment Cost:</b> ${crewEquipmentCost.toLocaleString()} SAR</p>
                <p><b>Crew Total:</b> ${crewTotal.toLocaleString()} SAR</p>
            ]]></description>
            <styleUrl>#crewLocation</styleUrl>
            <Point>
                <coordinates>${sub.crewLongitude},${sub.crewLatitude},0</coordinates>
            </Point>
        </Placemark>`;
                }
            });
            
            if (!placemarks) {
                showNotification('No GPS coordinates found in crew submissions', 'error');
                return;
            }

            // Create KML content
            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${projectCode} - ${reportDate}</name>
        <description><![CDATA[
            <h3>${projectName}</h3>
            <p><b>Date:</b> ${reportDate}</p>
            <hr>
            <h4>ð° Cost Summary</h4>
            <p><b>Total Manpower:</b> ${manpowerTotal.toLocaleString()} SAR</p>
            <p><b>Total Equipment:</b> ${equipmentTotal.toLocaleString()} SAR</p>
            <hr>
            <p style="font-size: 1.2em;"><b>Grand Total: ${grandTotal.toLocaleString()} SAR</b></p>
        ]]></description>
        <Style id="crewLocation">
            <IconStyle>
                <color>ff0000ff</color>
                <scale>1.2</scale>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/shapes/man.png</href>
                </Icon>
            </IconStyle>
            <LabelStyle>
                <color>ff0000ff</color>
                <scale>0.8</scale>
            </LabelStyle>
        </Style>
        ${placemarks}
    </Document>
</kml>`;

            // Create and download the KML file
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${projectCode}_${reportDate}_crews.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('KML file exported with all crew locations!', 'success');
        }

        function printPreview() {
            const previewContent = document.getElementById('previewContent');
            if (previewContent.style.display === 'none') {
                showNotification('Please generate preview first', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const projectCode = document.querySelector('input[name="projectCode"]').value || 'Project';
            const projectName = document.querySelector('input[name="projectName"]').value || '';
            const reportDate = document.querySelector('input[name="reportDate"]').value || '';
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cost Summary - ${projectCode}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .header-info { margin-bottom: 20px; }
                        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                        .section h3 { margin-top: 0; color: #333; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
                        th { background: #f5f5f5; }
                        .total-row { font-weight: bold; background: #f0f0f0; }
                        .grand-total { font-size: 1.5em; text-align: center; padding: 20px; background: #333; color: white; border-radius: 8px; margin-top: 20px; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1>ð Daily Report Cost Summary</h1>
                    <div class="header-info">
                        <p><strong>Project:</strong> ${projectCode} - ${projectName}</p>
                        <p><strong>Date:</strong> ${reportDate}</p>
                    </div>
                    ${previewContent.innerHTML}
                    <script>window.print(); window.close();<` + `/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function handleCrewProfessionChange(select) {
            const customField = select.closest('.form-grid').querySelector('.custom-profession');
            if (select.value === 'other') {
                customField.style.display = 'block';
                customField.querySelector('input').required = true;
            } else {
                customField.style.display = 'none';
                customField.querySelector('input').required = false;
            }
        }

        function addManpower() {
            const container = document.getElementById('manpowerContainer');
            const index = manpowerCount++;
            const html = `
                <div class="dynamic-item" data-index="${index}">
                    <div class="item-header">
                        <span class="item-number">Manpower #${index + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeItem(this, 'manpower')">â Remove</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Profession <span>*</span></label>
                            <select name="manpower[${index}].profession" required onchange="handleProfessionChange(this)">
                                <option value="">Select Profession</option>
                                <option value="Labor">Labor</option>
                                <option value="Foreman">Foreman</option>
                                <option value="Mason">Mason</option>
                                <option value="Carpenter">Carpenter</option>
                                <option value="Welder">Welder</option>
                                <option value="Electrician">Electrician</option>
                                <option value="Plumber">Plumber</option>
                                <option value="Heavy Equipment Operator">Heavy Equipment Operator</option>
                                <option value="Surveyor">Surveyor</option>
                                <option value="Safety Officer">Safety Officer</option>
                                <option value="Site Engineer">Site Engineer</option>
                                <option value="other">Other (specify)</option>
                            </select>
                        </div>
                        <div class="form-group custom-profession" style="display: none;">
                            <label>Specify Profession <span>*</span></label>
                            <input type="text" name="manpower[${index}].customProfession" placeholder="Enter profession">
                        </div>
                        <div class="form-group">
                            <label>Number of Workers <span>*</span></label>
                            <input type="number" name="manpower[${index}].count" required min="1" placeholder="5" oninput="calculateDailyTotal()">
                        </div>
                        <div class="form-group">
                            <label>Working Hours <span>*</span></label>
                            <input type="number" name="manpower[${index}].hours" required min="0" step="0.5" placeholder="8" oninput="calculateDailyTotal()">
                        </div>
                        <div class="form-group">
                            <label>Cost per Hour (SAR) <span>*</span></label>
                            <input type="number" name="manpower[${index}].costPerHour" required min="0" step="0.01" placeholder="25" oninput="calculateDailyTotal()">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function addEquipment() {
            const container = document.getElementById('equipmentContainer');
            const index = equipmentCount++;
            const html = `
                <div class="dynamic-item" data-index="${index}">
                    <div class="item-header">
                        <span class="item-number">Equipment #${index + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeItem(this, 'equipment')">â Remove</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Equipment Name <span>*</span></label>
                            <input type="text" name="equipment[${index}].name" required placeholder="Loader CAT 950">
                        </div>
                        <div class="form-group">
                            <label>Working Hours <span>*</span></label>
                            <input type="number" name="equipment[${index}].hours" required min="0" step="0.5" placeholder="8" oninput="calculateDailyTotal()">
                        </div>
                        <div class="form-group">
                            <label>Cost per Hour (SAR) <span>*</span></label>
                            <input type="number" name="equipment[${index}].costPerHour" required min="0" step="0.01" placeholder="150" oninput="calculateDailyTotal()">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function addSubcontractor() {
            const container = document.getElementById('subcontractorContainer');
            const index = subcontractorCount++;
            const html = `
                <div class="dynamic-item" data-index="${index}">
                    <div class="item-header">
                        <span class="item-number">Subcontractor #${index + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeItem(this, 'subcontractor')">â Remove</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Subcontractor Code <span>*</span></label>
                            <input type="text" name="subcontractors[${index}].code" required placeholder="SUB-00${index + 1}">
                        </div>
                        <div class="form-group">
                            <label>Subcontractor Name <span>*</span></label>
                            <input type="text" name="subcontractors[${index}].name" required placeholder="Company Name">
                        </div>
                        <div class="form-group">
                            <label>Work Scope</label>
                            <input type="text" name="subcontractors[${index}].scope" placeholder="Steel works">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function addMaterial() {
            const container = document.getElementById('materialsContainer');
            const index = materialCount++;
            const html = `
                <div class="dynamic-item" data-index="${index}">
                    <div class="item-header">
                        <span class="item-number">Material #${index + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeItem(this, 'material')">â Remove</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Item Number <span>*</span></label>
                            <input type="text" name="materials[${index}].itemNumber" required placeholder="1.${index + 1}">
                        </div>
                        <div class="form-group">
                            <label>Material Code <span>*</span></label>
                            <input type="text" name="materials[${index}].code" required placeholder="MAT-00${index + 1}">
                        </div>
                        <div class="form-group">
                            <label>Material Name</label>
                            <input type="text" name="materials[${index}].name" placeholder="Material description">
                        </div>
                        <div class="form-group">
                            <label>Quantity <span>*</span></label>
                            <input type="number" name="materials[${index}].quantity" required min="0" step="0.01" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label>Unit <span>*</span></label>
                            <select name="materials[${index}].unit" required>
                                <option value="ton">Ton</option>
                                <option value="m3">mÂ³</option>
                                <option value="m2">mÂ²</option>
                                <option value="kg">Kg</option>
                                <option value="no">Number</option>
                                <option value="bag">Bag</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unit Cost (SAR) <span>*</span></label>
                            <input type="number" name="materials[${index}].unitCost" required min="0" step="0.01" placeholder="500">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        // Work Item Functions
        function addWorkItem() {
            const container = document.getElementById('workItemsContainer');
            const index = workItemCount++;
            itemManpowerCounts[index] = 1;
            itemEquipmentCounts[index] = 1;
            itemSubcontractorCounts[index] = 1;
            
            const html = `
                <div class="work-item-card" data-item-index="${index}">
                    <div class="work-item-header">
                        <span class="work-item-title">ð¦ Work Item #${index + 1}</span>
                        <button type="button" class="remove-work-item-btn" onclick="removeWorkItem(this)">â Remove Item</button>
                    </div>
                    
                    <div class="work-item-info">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Item No. <span>*</span></label>
                                <input type="text" name="workItems[${index}].itemNo" required placeholder="ITEM-00${index + 1}">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Item Description <span>*</span></label>
                                <input type="text" name="workItems[${index}].itemDescription" required placeholder="Work description">
                            </div>
                        </div>
                    </div>

                    <div class="work-item-manpower">
                        <h4>ð· Manpower for this Item</h4>
                        <div class="item-manpower-container" data-item="${index}">
                            <div class="dynamic-item" data-index="0">
                                <div class="item-header">
                                    <span class="item-number">Manpower #1</span>
                                    <button type="button" class="remove-btn" onclick="removeItemResource(this, 'manpower')" style="display: none;">â</button>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Profession <span>*</span></label>
                                        <select name="workItems[${index}].manpower[0].profession" required onchange="handleCrewProfessionChange(this)">
                                            <option value="">Select Profession</option>
                                            <option value="Labor">Labor</option>
                                            <option value="Foreman">Foreman</option>
                                            <option value="Mason">Mason</option>
                                            <option value="Carpenter">Carpenter</option>
                                            <option value="Welder">Welder</option>
                                            <option value="Electrician">Electrician</option>
                                            <option value="Plumber">Plumber</option>
                                            <option value="Heavy Equipment Operator">Heavy Equipment Operator</option>
                                            <option value="Surveyor">Surveyor</option>
                                            <option value="other">Other (specify)</option>
                                        </select>
                                    </div>
                                    <div class="form-group custom-profession" style="display: none;">
                                        <label>Specify Profession <span>*</span></label>
                                        <input type="text" name="workItems[${index}].manpower[0].customProfession" placeholder="Enter profession">
                                    </div>
                                    <div class="form-group">
                                        <label>No. of Workers <span>*</span></label>
                                        <input type="number" name="workItems[${index}].manpower[0].count" required min="1" placeholder="5" oninput="calculateCrewTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label>Hours <span>*</span></label>
                                        <input type="number" name="workItems[${index}].manpower[0].hours" required min="0" step="0.5" placeholder="8" oninput="calculateCrewTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label>Cost/Hour (SAR) <span>*</span></label>
                                        <input type="number" name="workItems[${index}].manpower[0].costPerHour" required min="0" step="0.01" placeholder="25" oninput="calculateCrewTotal()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-btn add-resource-btn" onclick="addItemManpower(${index})">
                            â Add Manpower
                        </button>
                    </div>

                    <div class="work-item-equipment">
                        <h4>ð Equipment for this Item</h4>
                        <div class="item-equipment-container" data-item="${index}">
                            <div class="dynamic-item" data-index="0">
                                <div class="item-header">
                                    <span class="item-number">Equipment #1</span>
                                    <button type="button" class="remove-btn" onclick="removeItemResource(this, 'equipment')" style="display: none;">â</button>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Equipment Name <span>*</span></label>
                                        <input type="text" name="workItems[${index}].equipment[0].name" required placeholder="Excavator CAT 320">
                                    </div>
                                    <div class="form-group">
                                        <label>No. of Equipment <span>*</span></label>
                                        <input type="number" name="workItems[${index}].equipment[0].quantity" required min="1" placeholder="1" oninput="calculateCrewTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label>Hours <span>*</span></label>
                                        <input type="number" name="workItems[${index}].equipment[0].hours" required min="0" step="0.5" placeholder="8" oninput="calculateCrewTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label>Cost/Hour (SAR) <span>*</span></label>
                                        <input type="number" name="workItems[${index}].equipment[0].costPerHour" required min="0" step="0.01" placeholder="150" oninput="calculateCrewTotal()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-btn add-resource-btn" onclick="addItemEquipment(${index})">
                            â Add Equipment
                        </button>
                    </div>

                    <div class="work-item-subcontractor">
                        <h4>ðï¸ Subcontractor for this Item <span class="optional-badge">(Optional)</span></h4>
                        <div class="subcontractor-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="toggleItemSubcontractor(${index}, this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Include Subcontractor</span>
                        </div>
                        <div class="item-subcontractor-container" data-item="${index}" style="display: none;">
                            <div class="dynamic-item" data-index="0">
                                <div class="item-header">
                                    <span class="item-number">Subcontractor #1</span>
                                    <button type="button" class="remove-btn" onclick="removeItemResource(this, 'subcontractor')" style="display: none;">â</button>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Company Name <span>*</span></label>
                                        <input type="text" name="workItems[${index}].subcontractor[0].companyName" placeholder="ABC Contracting Co.">
                                    </div>
                                    <div class="form-group">
                                        <label>Contact Person</label>
                                        <input type="text" name="workItems[${index}].subcontractor[0].contactPerson" placeholder="Mohammed Ali">
                                    </div>
                                    <div class="form-group">
                                        <label>Quantity</label>
                                        <input type="number" name="workItems[${index}].subcontractor[0].quantity" min="0" step="0.01" placeholder="100" oninput="calculateSubcontractorAmount(this)">
                                    </div>
                                    <div class="form-group">
                                        <label>Rate (SAR)</label>
                                        <input type="number" name="workItems[${index}].subcontractor[0].rate" min="0" step="0.01" placeholder="50" oninput="calculateSubcontractorAmount(this)">
                                    </div>
                                    <div class="form-group">
                                        <label>Expenses (+)</label>
                                        <input type="number" name="workItems[${index}].subcontractor[0].expenses" min="0" step="0.01" placeholder="0" oninput="calculateSubcontractorAmount(this)" class="subcontractor-expenses">
                                    </div>
                                    <div class="form-group">
                                        <label>Deductions (-)</label>
                                        <input type="number" name="workItems[${index}].subcontractor[0].deductions" min="0" step="0.01" placeholder="0" oninput="calculateSubcontractorAmount(this)" class="subcontractor-deductions">
                                    </div>
                                    <div class="form-group" style="grid-column: span 2;">
                                        <label>Net Amount (SAR)</label>
                                        <input type="number" name="workItems[${index}].subcontractor[0].amount" readonly class="subcontractor-amount" placeholder="Calculated">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="add-btn add-resource-btn" onclick="addItemSubcontractor(${index})" style="display: none;" data-item="${index}">
                            â Add Subcontractor
                        </button>
                    </div>

                    <div class="work-item-subtotal">
                        <span>Item Subtotal:</span>
                        <span class="item-subtotal-value" data-item="${index}">0 SAR</span>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            
            // Show remove buttons for first work item
            updateRemoveButtons();
        }

        function removeWorkItem(button) {
            const workItemCard = button.closest('.work-item-card');
            workItemCard.remove();
            renumberWorkItems();
            calculateCrewTotal();
            updateRemoveButtons();
        }

        function renumberWorkItems() {
            const items = document.querySelectorAll('.work-item-card');
            items.forEach((item, index) => {
                item.querySelector('.work-item-title').textContent = `ð¦ Work Item #${index + 1}`;
            });
        }

        function updateRemoveButtons() {
            const workItems = document.querySelectorAll('.work-item-card');
            workItems.forEach(item => {
                const removeBtn = item.querySelector('.remove-work-item-btn');
                if (removeBtn) {
                    removeBtn.style.display = workItems.length > 1 ? 'block' : 'none';
                }
            });
        }

        function addItemManpower(itemIndex) {
            const container = document.querySelector(`.item-manpower-container[data-item="${itemIndex}"]`);
            if (!container) return;
            
            if (!itemManpowerCounts[itemIndex]) itemManpowerCounts[itemIndex] = 1;
            const mpIndex = itemManpowerCounts[itemIndex]++;
            
            const html = `
                <div class="dynamic-item" data-index="${mpIndex}">
                    <div class="item-header">
                        <span class="item-number">Manpower #${mpIndex + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeItemResource(this, 'manpower')">â</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Profession <span>*</span></label>
                            <select name="workItems[${itemIndex}].manpower[${mpIndex}].profession" required onchange="handleCrewProfessionChange(this)">
                                <option value="">Select Profession</option>
                                <option value="Labor">Labor</option>
                                <option value="Foreman">Foreman</option>
                                <option value="Mason">Mason</option>
                                <option value="Carpenter">Carpenter</option>
                                <option value="Welder">Welder</option>
                                <option value="Electrician">Electrician</option>
                                <option value="Plumber">Plumber</option>
                                <option value="Heavy Equipment Operator">Heavy Equipment Operator</option>
                                <option value="Surveyor">Surveyor</option>
                                <option value="other">Other (specify)</option>
                            </select>
                        </div>
                        <div class="form-group custom-profession" style="display: none;">
                            <label>Specify Profession <span>*</span></label>
                            <input type="text" name="workItems[${itemIndex}].manpower[${mpIndex}].customProfession" placeholder="Enter profession">
                        </div>
                        <div class="form-group">
                            <label>No. of Workers <span>*</span></label>
                            <input type="number" name="workItems[${itemIndex}].manpower[${mpIndex}].count" required min="1" placeholder="5" oninput="calculateCrewTotal()">
                        </div>
                        <div class="form-group">
                            <label>Hours <span>*</span></label>
                            <input type="number" name="workItems[${itemIndex}].manpower[${mpIndex}].hours" required min="0" step="0.5" placeholder="8" oninput="calculateCrewTotal()">
                        </div>
                        <div class="form-group">
                            <label>Cost/Hour (SAR) <span>*</span></label>
                            <input type="number" name="workItems[${itemIndex}].manpower[${mpIndex}].costPerHour" required min="0" step="0.01" placeholder="25" oninput="calculateCrewTotal()">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            updateManpowerRemoveButtons(container);
        }

        function addItemEquipment(itemIndex) {
            const container = document.querySelector(`.item-equipment-container[data-item="${itemIndex}"]`);
            if (!container) return;
            
            if (!itemEquipmentCounts[itemIndex]) itemEquipmentCounts[itemIndex] = 1;
            const eqIndex = itemEquipmentCounts[itemIndex]++;
            
            const html = `
                <div class="dynamic-item" data-index="${eqIndex}">
                    <div class="item-header">
                        <span class="item-number">Equipment #${eqIndex + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeItemResource(this, 'equipment')">â</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Equipment Name <span>*</span></label>
                            <input type="text" name="workItems[${itemIndex}].equipment[${eqIndex}].name" required placeholder="Loader CAT 950">
                        </div>
                        <div class="form-group">
                            <label>No. of Equipment <span>*</span></label>
                            <input type="number" name="workItems[${itemIndex}].equipment[${eqIndex}].quantity" required min="1" placeholder="1" oninput="calculateCrewTotal()">
                        </div>
                        <div class="form-group">
                            <label>Hours <span>*</span></label>
                            <input type="number" name="workItems[${itemIndex}].equipment[${eqIndex}].hours" required min="0" step="0.5" placeholder="8" oninput="calculateCrewTotal()">
                        </div>
                        <div class="form-group">
                            <label>Cost/Hour (SAR) <span>*</span></label>
                            <input type="number" name="workItems[${itemIndex}].equipment[${eqIndex}].costPerHour" required min="0" step="0.01" placeholder="150" oninput="calculateCrewTotal()">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            updateEquipmentRemoveButtons(container);
        }

        function removeItemResource(button, type) {
            let containerClass;
            if (type === 'manpower') containerClass = '.item-manpower-container';
            else if (type === 'equipment') containerClass = '.item-equipment-container';
            else if (type === 'subcontractor') containerClass = '.item-subcontractor-container';
            
            const container = button.closest(containerClass);
            button.closest('.dynamic-item').remove();
            
            // Renumber items
            const items = container.querySelectorAll('.dynamic-item');
            items.forEach((item, index) => {
                let label;
                if (type === 'manpower') label = 'Manpower';
                else if (type === 'equipment') label = 'Equipment';
                else if (type === 'subcontractor') label = 'Subcontractor';
                item.querySelector('.item-number').textContent = `${label} #${index + 1}`;
            });
            
            if (type === 'manpower') {
                updateManpowerRemoveButtons(container);
            } else if (type === 'equipment') {
                updateEquipmentRemoveButtons(container);
            } else if (type === 'subcontractor') {
                updateSubcontractorRemoveButtons(container);
            }
            
            calculateCrewTotal();
        }

        function updateManpowerRemoveButtons(container) {
            const items = container.querySelectorAll('.dynamic-item');
            items.forEach(item => {
                const removeBtn = item.querySelector('.remove-btn');
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'inline-block' : 'none';
                }
            });
        }

        function updateEquipmentRemoveButtons(container) {
            const items = container.querySelectorAll('.dynamic-item');
            items.forEach(item => {
                const removeBtn = item.querySelector('.remove-btn');
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'inline-block' : 'none';
                }
            });
        }

        function updateSubcontractorRemoveButtons(container) {
            const items = container.querySelectorAll('.dynamic-item');
            items.forEach(item => {
                const removeBtn = item.querySelector('.remove-btn');
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'inline-block' : 'none';
                }
            });
        }

        function toggleItemSubcontractor(itemIndex, isChecked) {
            const container = document.querySelector(`.item-subcontractor-container[data-item="${itemIndex}"]`);
            const addBtn = document.querySelector(`.work-item-subcontractor button[data-item="${itemIndex}"]`);
            
            if (container) {
                container.style.display = isChecked ? 'block' : 'none';
            }
            if (addBtn) {
                addBtn.style.display = isChecked ? 'inline-flex' : 'none';
            }
            calculateCrewTotal();
        }

        function addItemSubcontractor(itemIndex) {
            const container = document.querySelector(`.item-subcontractor-container[data-item="${itemIndex}"]`);
            if (!container) return;
            
            if (!itemSubcontractorCounts[itemIndex]) itemSubcontractorCounts[itemIndex] = 1;
            const subIndex = itemSubcontractorCounts[itemIndex]++;
            
            const html = `
                <div class="dynamic-item" data-index="${subIndex}">
                    <div class="item-header">
                        <span class="item-number">Subcontractor #${subIndex + 1}</span>
                        <button type="button" class="remove-btn" onclick="removeItemResource(this, 'subcontractor')">â</button>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Company Name <span>*</span></label>
                            <input type="text" name="workItems[${itemIndex}].subcontractor[${subIndex}].companyName" placeholder="XYZ Company">
                        </div>
                        <div class="form-group">
                            <label>Contact Person</label>
                            <input type="text" name="workItems[${itemIndex}].subcontractor[${subIndex}].contactPerson" placeholder="Contact name">
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" name="workItems[${itemIndex}].subcontractor[${subIndex}].quantity" min="0" step="0.01" placeholder="100" oninput="calculateSubcontractorAmount(this)">
                        </div>
                        <div class="form-group">
                            <label>Rate (SAR)</label>
                            <input type="number" name="workItems[${itemIndex}].subcontractor[${subIndex}].rate" min="0" step="0.01" placeholder="50" oninput="calculateSubcontractorAmount(this)">
                        </div>
                        <div class="form-group">
                            <label>Expenses (+)</label>
                            <input type="number" name="workItems[${itemIndex}].subcontractor[${subIndex}].expenses" min="0" step="0.01" placeholder="0" oninput="calculateSubcontractorAmount(this)" class="subcontractor-expenses">
                        </div>
                        <div class="form-group">
                            <label>Deductions (-)</label>
                            <input type="number" name="workItems[${itemIndex}].subcontractor[${subIndex}].deductions" min="0" step="0.01" placeholder="0" oninput="calculateSubcontractorAmount(this)" class="subcontractor-deductions">
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Net Amount (SAR)</label>
                            <input type="number" name="workItems[${itemIndex}].subcontractor[${subIndex}].amount" readonly class="subcontractor-amount" placeholder="Calculated">
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            updateSubcontractorRemoveButtons(container);
        }

        // Legacy functions for backward compatibility
        function addCrewManpower() {
            addItemManpower(0);
        }

        function addCrewEquipment() {
            addItemEquipment(0);
        }

        function removeItem(button, type) {
            button.closest('.dynamic-item').remove();
            renumberItems(type);
        }

        function removeCrewItem(button, type) {
            button.closest('.dynamic-item').remove();
            renumberCrewItems(type);
            calculateCrewTotal();
        }

        function renumberItems(type) {
            let container;
            if (type === 'equipment') container = document.getElementById('equipmentContainer');
            else if (type === 'subcontractor') container = document.getElementById('subcontractorContainer');
            else if (type === 'material') container = document.getElementById('materialsContainer');
            else if (type === 'manpower') container = document.getElementById('manpowerContainer');
            
            if (!container) return;
            
            const items = container.querySelectorAll('.dynamic-item');
            items.forEach((item, index) => {
                const label = type.charAt(0).toUpperCase() + type.slice(1);
                item.querySelector('.item-number').textContent = `${label} #${index + 1}`;
            });
        }

        function renumberCrewItems(type) {
            let container;
            if (type === 'crewManpower') container = document.getElementById('crewManpowerContainer');
            else if (type === 'crewEquipment') container = document.getElementById('crewEquipmentContainer');
            
            if (!container) return;
            
            const items = container.querySelectorAll('.dynamic-item');
            const label = type === 'crewManpower' ? 'Manpower' : 'Equipment';
            items.forEach((item, index) => {
                item.querySelector('.item-number').textContent = `${label} #${index + 1}`;
            });
        }

        // Crew Data Storage Functions
        function getCrewSubmissions() {
            try {
                const data = localStorage.getItem('crewSubmissions');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                return [];
            }
        }

        function saveCrewSubmission(submission) {
            const submissions = getCrewSubmissions();
            submission.id = Date.now();
            submission.timestamp = new Date().toISOString();
            submissions.push(submission);
            localStorage.setItem('crewSubmissions', JSON.stringify(submissions));
            return submission;
        }

        function clearCrewSubmissions() {
            localStorage.removeItem('crewSubmissions');
            updateCrewSubmissionsList();
            calculateDailyTotal();
        }

        function updateCrewSubmissionsList() {
            const container = document.getElementById('crewSubmissionsList');
            if (!container) return;
            
            const submissions = getCrewSubmissions();
            
            if (submissions.length === 0) {
                container.innerHTML = '<p class="no-submissions">No crew submissions yet. Generate and share the link above.</p>';
                return;
            }
            
            let html = '';
            submissions.forEach((sub, index) => {
                // Calculate costs from workItems
                let manpowerCost = 0;
                let equipmentCost = 0;
                let totalManpower = 0;
                let totalEquipment = 0;
                let itemsList = [];
                
                (sub.workItems || []).forEach(item => {
                    if (item.itemNo) {
                        itemsList.push(`${item.itemNo}: ${item.itemDescription || ''}`);
                    }
                    (item.manpower || []).forEach(m => {
                        totalManpower++;
                        manpowerCost += (parseFloat(m.count) || 0) * (parseFloat(m.hours) || 0) * (parseFloat(m.costPerHour) || 0);
                    });
                    (item.equipment || []).forEach(e => {
                        totalEquipment++;
                        const qty = parseFloat(e.quantity) || 1;
                        equipmentCost += qty * (parseFloat(e.hours) || 0) * (parseFloat(e.costPerHour) || 0);
                    });
                });
                
                // Fallback for old format (crewManpower/crewEquipment)
                if ((sub.workItems || []).length === 0) {
                    (sub.crewManpower || []).forEach(m => {
                        totalManpower++;
                        manpowerCost += (parseFloat(m.count) || 0) * (parseFloat(m.hours) || 0) * (parseFloat(m.costPerHour) || 0);
                    });
                    (sub.crewEquipment || []).forEach(e => {
                        totalEquipment++;
                        equipmentCost += (parseFloat(e.hours) || 0) * (parseFloat(e.costPerHour) || 0);
                    });
                }
                
                const totalCost = manpowerCost + equipmentCost;
                
                html += `
                    <div class="crew-submission-item">
                        <div class="crew-submission-header">
                            <h5>ð· ${sub.crewSupervisor || 'Crew'} - ${sub.crewNumber || ''}</h5>
                            <span class="crew-cost">${totalCost.toLocaleString()} SAR</span>
                        </div>
                        <div class="crew-submission-details">
                            <span>ð <strong>Line:</strong> ${sub.lineName || 'N/A'}</span>
                            ${itemsList.length > 0 ? `<span>ð <strong>Items:</strong> ${itemsList.length}</span>` : ''}
                            <span>ð ${sub.crewLocationType === 'station' ? 
                                `${sub.crewFromStation || ''} â ${sub.crewToStation || ''}` : 
                                `${sub.crewFromMH || ''} â ${sub.crewToMH || ''}`}</span>
                            <span>ð ${sub.crewLengthLm || 0} L.m</span>
                            <span>ð· ${totalManpower} manpower entries</span>
                            <span>ð ${totalEquipment} equipment entries</span>
                        </div>
                        ${itemsList.length > 0 ? `
                        <div class="crew-submission-items" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.85rem;">
                            <strong>Work Items:</strong><br>
                            ${itemsList.map(i => `â¢ ${i}`).join('<br>')}
                        </div>
                        ` : ''}
                        ${sub.crewLatitude && sub.crewLongitude ? `
                        <div class="crew-submission-location">
                            <a href="https://www.google.com/maps?q=${sub.crewLatitude},${sub.crewLongitude}&z=18" target="_blank">
                                ðºï¸ View on Map (${sub.crewLatitude}, ${sub.crewLongitude})
                            </a>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `<button type="button" class="add-btn" style="margin-top: 15px; background: #dc3545;" onclick="if(confirm('Clear all crew submissions?')) clearCrewSubmissions()">ðï¸ Clear All Submissions</button>`;
            
            container.innerHTML = html;
        }

        function calculateDailyTotal() {
            const submissions = getCrewSubmissions();
            let totalCost = 0;
            
            submissions.forEach(sub => {
                // Calculate from workItems
                (sub.workItems || []).forEach(item => {
                    (item.manpower || []).forEach(m => {
                        const count = parseFloat(m.count) || 0;
                        const hours = parseFloat(m.hours) || 0;
                        const costPerHour = parseFloat(m.costPerHour) || 0;
                        totalCost += count * hours * costPerHour;
                    });
                    
                    (item.equipment || []).forEach(e => {
                        const qty = parseFloat(e.quantity) || 1;
                        const hours = parseFloat(e.hours) || 0;
                        const costPerHour = parseFloat(e.costPerHour) || 0;
                        totalCost += qty * hours * costPerHour;
                    });
                });
                
                // Fallback for old format
                if ((sub.workItems || []).length === 0) {
                    (sub.crewManpower || []).forEach(m => {
                        const count = parseFloat(m.count) || 0;
                        const hours = parseFloat(m.hours) || 0;
                        const costPerHour = parseFloat(m.costPerHour) || 0;
                        totalCost += count * hours * costPerHour;
                    });
                    
                    (sub.crewEquipment || []).forEach(e => {
                        const hours = parseFloat(e.hours) || 0;
                        const costPerHour = parseFloat(e.costPerHour) || 0;
                        totalCost += hours * costPerHour;
                    });
                }
            });
            
            const totalEl = document.getElementById('dailyTotalValue');
            if (totalEl) {
                totalEl.textContent = totalCost.toLocaleString() + ' SAR';
            }
        }

        function calculateCrewTotal() {
            let grandTotal = 0;
            
            // Calculate for each work item
            document.querySelectorAll('.work-item-card').forEach(workItem => {
                const itemIndex = workItem.dataset.itemIndex;
                let itemTotal = 0;
                
                // Manpower cost for this item
                workItem.querySelectorAll('.item-manpower-container .dynamic-item').forEach(item => {
                    const count = parseFloat(item.querySelector('input[name$=".count"]')?.value) || 0;
                    const hours = parseFloat(item.querySelector('input[name$=".hours"]')?.value) || 0;
                    const costPerHour = parseFloat(item.querySelector('input[name$=".costPerHour"]')?.value) || 0;
                    itemTotal += count * hours * costPerHour;
                });
                
                // Equipment cost for this item
                workItem.querySelectorAll('.item-equipment-container .dynamic-item').forEach(item => {
                    const quantity = parseFloat(item.querySelector('input[name$=".quantity"]')?.value) || 1;
                    const hours = parseFloat(item.querySelector('input[name$=".hours"]')?.value) || 0;
                    const costPerHour = parseFloat(item.querySelector('input[name$=".costPerHour"]')?.value) || 0;
                    itemTotal += quantity * hours * costPerHour;
                });
                
                // Subcontractor cost for this item (use calculated amount field)
                workItem.querySelectorAll('.item-subcontractor-container .dynamic-item').forEach(item => {
                    const amount = parseFloat(item.querySelector('input[name$=".amount"]')?.value) || 0;
                    itemTotal += amount;
                });
                
                // Update item subtotal
                const subtotalEl = workItem.querySelector('.item-subtotal-value');
                if (subtotalEl) {
                    subtotalEl.textContent = itemTotal.toLocaleString() + ' SAR';
                }
                
                grandTotal += itemTotal;
            });
            
            // Update grand total
            const totalEl = document.getElementById('crewTotalValue');
            if (totalEl) {
                totalEl.textContent = grandTotal.toLocaleString() + ' SAR';
            }
        }

        function calculateSubcontractorAmount(input) {
            // Find the parent dynamic-item
            const dynamicItem = input.closest('.dynamic-item');
            if (!dynamicItem) return;
            
            // Get all values
            const quantity = parseFloat(dynamicItem.querySelector('input[name$=".quantity"]')?.value) || 0;
            const rate = parseFloat(dynamicItem.querySelector('input[name$=".rate"]')?.value) || 0;
            const expenses = parseFloat(dynamicItem.querySelector('input[name$=".expenses"]')?.value) || 0;
            const deductions = parseFloat(dynamicItem.querySelector('input[name$=".deductions"]')?.value) || 0;
            
            // Calculate: (Quantity Ã Rate) + Expenses - Deductions
            const baseAmount = quantity * rate;
            const netAmount = baseAmount + expenses - deductions;
            
            // Update the amount field
            const amountInput = dynamicItem.querySelector('input[name$=".amount"]');
            if (amountInput) {
                amountInput.value = netAmount.toFixed(2);
            }
            
            // Update crew total
            calculateCrewTotal();
        }

        // Weekly Report Functions
        function updateWeekEndDate() {
            const startDate = document.querySelector('input[name="weekStartDate"]').value;
            if (startDate) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setDate(end.getDate() + 6);
                document.querySelector('input[name="weekEndDate"]').value = end.toISOString().split('T')[0];
            }
        }

        function toggleProgressSubcontractor(index, isChecked) {
            const fields = document.querySelector(`.progress-subcontractor-fields[data-progress="${index}"]`);
            if (fields) {
                fields.style.display = isChecked ? 'block' : 'none';
            }
        }

        function addProgressItem() {
            const container = document.getElementById('progressItemsContainer');
            const index = progressItemCount++;
            
            const html = `
                <div class="progress-item-card" data-progress-index="${index}">
                    <div class="progress-item-header">
                        <span class="progress-item-title">ð¦ Progress Item #${index + 1}</span>
                        <button type="button" class="remove-progress-item-btn" onclick="removeProgressItem(this)">â Remove</button>
                    </div>
                    
                    <div class="progress-item-info">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Item Code <span>*</span></label>
                                <input type="text" name="progressItems[${index}].itemCode" required placeholder="ITEM-00${index + 1}">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Item Description <span>*</span></label>
                                <input type="text" name="progressItems[${index}].itemDescription" required placeholder="Work description">
                            </div>
                        </div>
                        
                        <div class="progress-subcontractor-toggle">
                            <label class="toggle-switch">
                                <input type="checkbox" onchange="toggleProgressSubcontractor(${index}, this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Include Subcontractor</span>
                        </div>
                        <div class="progress-subcontractor-fields" data-progress="${index}" style="display: none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Subcontractor Name</label>
                                    <input type="text" name="progressItems[${index}].subcontractorName" placeholder="Company name">
                                </div>
                                <div class="form-group">
                                    <label>Subcontractor Code</label>
                                    <input type="text" name="progressItems[${index}].subcontractorCode" placeholder="SUB-00${index + 1}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="progress-quantities">
                        <h4>ð Quantities & Pricing</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Planned Qty <span>*</span></label>
                                <input type="number" name="progressItems[${index}].plannedQty" required min="0" step="0.01" placeholder="1000" oninput="calculateProgressItem(${index})">
                            </div>
                            <div class="form-group">
                                <label>Completed Qty (Daily) <span>*</span></label>
                                <input type="number" name="progressItems[${index}].completedQtyDaily" min="0" step="0.01" placeholder="850" oninput="calculateProgressItem(${index})" class="daily-qty-input">
                            </div>
                            <div class="form-group">
                                <label>Adjust Qty (+/-)</label>
                                <input type="number" name="progressItems[${index}].adjustQty" step="0.01" placeholder="0" oninput="calculateProgressItem(${index})" class="adjust-qty-input">
                            </div>
                            <div class="form-group">
                                <label>Final Completed Qty</label>
                                <input type="number" name="progressItems[${index}].completedQty" readonly class="final-qty-input">
                            </div>
                            <div class="form-group">
                                <label>Unit <span>*</span></label>
                                <input type="text" name="progressItems[${index}].unit" required placeholder="mÂ³, mÂ², L.m, ton, etc.">
                            </div>
                            <div class="form-group">
                                <label>Unit Price (SAR) <span>*</span></label>
                                <input type="number" name="progressItems[${index}].unitPrice" required min="0" step="0.01" placeholder="250" oninput="calculateProgressItem(${index})">
                            </div>
                        </div>
                    </div>

                    <div class="progress-costs">
                        <h4>ð° Cost Analysis</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Earned Value (EV)</label>
                                <input type="number" name="progressItems[${index}].earnedValue" readonly class="ev-input" placeholder="Calculated">
                            </div>
                            <div class="form-group">
                                <label>AC (Daily Reports)</label>
                                <input type="number" name="progressItems[${index}].actualCostDaily" readonly class="ac-daily-input" placeholder="From Daily">
                            </div>
                            <div class="form-group">
                                <label>AC Adjust (+/-)</label>
                                <input type="number" name="progressItems[${index}].actualCostAdjust" step="0.01" placeholder="0" oninput="calculateProgressItem(${index})" class="ac-adjust-input">
                            </div>
                            <div class="form-group">
                                <label>Final Actual Cost (AC)</label>
                                <input type="number" name="progressItems[${index}].actualCost" readonly class="ac-final-input" placeholder="Calculated">
                            </div>
                            <div class="form-group">
                                <label>Cost Variance (CV)</label>
                                <input type="number" name="progressItems[${index}].costVariance" readonly class="cv-input" placeholder="Calculated">
                            </div>
                            <div class="form-group">
                                <label>Completion %</label>
                                <input type="text" name="progressItems[${index}].completionPct" readonly class="completion-pct-input" placeholder="0%">
                            </div>
                        </div>
                    </div>

                    <div class="progress-item-summary">
                        <div class="summary-item">
                            <span class="summary-label">Earned Value</span>
                            <span class="summary-value ev-value" data-progress="${index}">0 SAR</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Cost Variance</span>
                            <span class="summary-value cv-value" data-progress="${index}">0 SAR</span>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
            updateProgressRemoveButtons();
            updateWeeklyHistogram();
        }

        function removeProgressItem(button) {
            button.closest('.progress-item-card').remove();
            renumberProgressItems();
            updateWeeklySummary();
            updateWeeklyHistogram();
            updateProgressRemoveButtons();
        }

        function renumberProgressItems() {
            const items = document.querySelectorAll('.progress-item-card');
            items.forEach((item, index) => {
                item.querySelector('.progress-item-title').textContent = `ð¦ Progress Item #${index + 1}`;
            });
        }

        function updateProgressRemoveButtons() {
            const items = document.querySelectorAll('.progress-item-card');
            items.forEach(item => {
                const removeBtn = item.querySelector('.remove-progress-item-btn');
                if (removeBtn) {
                    removeBtn.style.display = items.length > 1 ? 'block' : 'none';
                }
            });
        }

        function calculateProgressItem(index) {
            const card = document.querySelector(`.progress-item-card[data-progress-index="${index}"]`);
            if (!card) return;
            
            // Get values
            const plannedQty = parseFloat(card.querySelector(`input[name="progressItems[${index}].plannedQty"]`)?.value) || 0;
            const completedDaily = parseFloat(card.querySelector(`input[name="progressItems[${index}].completedQtyDaily"]`)?.value) || 0;
            const adjustQty = parseFloat(card.querySelector(`input[name="progressItems[${index}].adjustQty"]`)?.value) || 0;
            const unitPrice = parseFloat(card.querySelector(`input[name="progressItems[${index}].unitPrice"]`)?.value) || 0;
            
            // Get AC values
            const acDaily = parseFloat(card.querySelector(`input[name="progressItems[${index}].actualCostDaily"]`)?.value) || 0;
            const acAdjust = parseFloat(card.querySelector(`input[name="progressItems[${index}].actualCostAdjust"]`)?.value) || 0;
            
            // Calculate final completed quantity
            const finalCompleted = completedDaily + adjustQty;
            card.querySelector(`input[name="progressItems[${index}].completedQty"]`).value = finalCompleted.toFixed(2);
            
            // Calculate Final Actual Cost (AC Daily + AC Adjust)
            const actualCost = acDaily + acAdjust;
            card.querySelector(`input[name="progressItems[${index}].actualCost"]`).value = actualCost.toFixed(2);
            
            // Calculate Earned Value (EV = Completed Qty Ã Unit Price)
            const earnedValue = finalCompleted * unitPrice;
            card.querySelector(`input[name="progressItems[${index}].earnedValue"]`).value = earnedValue.toFixed(2);
            
            // Calculate Cost Variance (CV = EV - AC)
            const costVariance = earnedValue - actualCost;
            const cvInput = card.querySelector(`input[name="progressItems[${index}].costVariance"]`);
            cvInput.value = costVariance.toFixed(2);
            cvInput.classList.remove('positive', 'negative');
            cvInput.classList.add(costVariance >= 0 ? 'positive' : 'negative');
            
            // Calculate Completion %
            const completionPct = plannedQty > 0 ? ((finalCompleted / plannedQty) * 100).toFixed(1) : 0;
            card.querySelector(`input[name="progressItems[${index}].completionPct"]`).value = completionPct + '%';
            
            // Update summary display
            const evDisplay = card.querySelector(`.ev-value[data-progress="${index}"]`);
            const cvDisplay = card.querySelector(`.cv-value[data-progress="${index}"]`);
            
            if (evDisplay) evDisplay.textContent = earnedValue.toLocaleString() + ' SAR';
            if (cvDisplay) {
                cvDisplay.textContent = (costVariance >= 0 ? '+' : '') + costVariance.toLocaleString() + ' SAR';
                cvDisplay.classList.remove('positive', 'negative');
                cvDisplay.classList.add(costVariance >= 0 ? 'positive' : 'negative');
            }
            
            // Update weekly totals
            updateWeeklySummary();
            updateWeeklyHistogram();
        }

        function updateWeeklySummary() {
            let totalEV = 0;
            let totalAC = 0;
            let totalCV = 0;
            let totalCompletionPct = 0;
            let itemCount = 0;
            
            document.querySelectorAll('.progress-item-card').forEach(card => {
                const index = card.dataset.progressIndex;
                const ev = parseFloat(card.querySelector(`input[name="progressItems[${index}].earnedValue"]`)?.value) || 0;
                const ac = parseFloat(card.querySelector(`input[name="progressItems[${index}].actualCost"]`)?.value) || 0;
                const cv = parseFloat(card.querySelector(`input[name="progressItems[${index}].costVariance"]`)?.value) || 0;
                const pct = parseFloat(card.querySelector(`input[name="progressItems[${index}].completionPct"]`)?.value) || 0;
                
                totalEV += ev;
                totalAC += ac;
                totalCV += cv;
                totalCompletionPct += pct;
                itemCount++;
            });
            
            // Update summary cards
            document.getElementById('weeklyTotalEV').textContent = totalEV.toLocaleString() + ' SAR';
            document.getElementById('weeklyTotalAC').textContent = totalAC.toLocaleString() + ' SAR';
            
            const cvDisplay = document.getElementById('weeklyTotalCV');
            cvDisplay.textContent = (totalCV >= 0 ? '+' : '') + totalCV.toLocaleString() + ' SAR';
            cvDisplay.classList.remove('positive', 'negative');
            cvDisplay.classList.add(totalCV >= 0 ? 'positive' : 'negative');
            
            const avgCompletion = itemCount > 0 ? (totalCompletionPct / itemCount).toFixed(1) : 0;
            document.getElementById('weeklyAvgCompletion').textContent = avgCompletion + '%';
        }

        function updateWeeklyHistogram() {
            const container = document.getElementById('weeklyHistogramContainer');
            const items = document.querySelectorAll('.progress-item-card');
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="histogram-placeholder">
                        <span>ð</span>
                        <p>Add progress items to see the cost variance histogram</p>
                    </div>
                `;
                return;
            }
            
            // Collect data
            const data = [];
            let maxValue = 0;
            
            items.forEach(card => {
                const index = card.dataset.progressIndex;
                const itemCode = card.querySelector(`input[name="progressItems[${index}].itemCode"]`)?.value || `Item ${index}`;
                const cv = parseFloat(card.querySelector(`input[name="progressItems[${index}].costVariance"]`)?.value) || 0;
                
                data.push({ itemCode, cv });
                if (Math.abs(cv) > maxValue) maxValue = Math.abs(cv);
            });
            
            if (maxValue === 0) maxValue = 1; // Prevent division by zero
            
            // Build histogram HTML
            let barsHtml = '';
            data.forEach(item => {
                const heightPercent = Math.min((Math.abs(item.cv) / maxValue) * 100, 100);
                const barHeight = Math.max(heightPercent * 2, 20); // Min 20px height
                const isPositive = item.cv >= 0;
                const displayValue = (item.cv >= 0 ? '+' : '') + (item.cv / 1000).toFixed(1) + 'K';
                
                barsHtml += `
                    <div class="histogram-bar-container">
                        <div class="histogram-bar-value" style="color: ${isPositive ? '#16a34a' : '#dc2626'};">
                            ${displayValue}
                        </div>
                        <div class="histogram-bar ${isPositive ? 'positive' : 'negative'}" style="height: ${barHeight}px;" title="${item.itemCode}: ${item.cv.toLocaleString()} SAR"></div>
                        <div class="histogram-bar-label" title="${item.itemCode}">${item.itemCode}</div>
                    </div>
                `;
            });
            
            container.innerHTML = `<div class="histogram-chart">${barsHtml}</div>`;
        }

        function importFromDailyReports() {
            // Get week date range
            const weekStart = document.querySelector('input[name="weekStartDate"]').value;
            const weekEnd = document.querySelector('input[name="weekEndDate"]').value;
            
            if (!weekStart || !weekEnd) {
                showNotification('Please select Week Starting Date and Week Ending Date first.', 'error');
                return;
            }
            
            const startDate = new Date(weekStart);
            const endDate = new Date(weekEnd);
            endDate.setHours(23, 59, 59, 999); // Include entire end day
            
            // Get crew submissions from localStorage
            const submissions = getCrewSubmissions();
            
            if (submissions.length === 0) {
                showNotification('No daily report data found. Submit crew data from daily reports first.', 'error');
                return;
            }
            
            // Filter submissions by date range
            const filteredSubmissions = submissions.filter(sub => {
                const subDate = new Date(sub.reportDate);
                return subDate >= startDate && subDate <= endDate;
            });
            
            if (filteredSubmissions.length === 0) {
                showNotification(`No daily reports found for period ${weekStart} to ${weekEnd}.`, 'error');
                return;
            }
            
            // Aggregate work items from filtered submissions
            const itemsMap = new Map();
            
            filteredSubmissions.forEach(sub => {
                (sub.workItems || []).forEach(item => {
                    if (!item.itemNo) return;
                    
                    const key = item.itemNo;
                    if (!itemsMap.has(key)) {
                        itemsMap.set(key, {
                            itemCode: item.itemNo,
                            itemDescription: item.itemDescription || '',
                            completedQty: 0,
                            actualCost: 0,
                            subcontractors: []
                        });
                    }
                    
                    const existing = itemsMap.get(key);
                    
                    // Calculate manpower cost
                    (item.manpower || []).forEach(m => {
                        const cost = (parseFloat(m.count) || 0) * (parseFloat(m.hours) || 0) * (parseFloat(m.costPerHour) || 0);
                        existing.actualCost += cost;
                    });
                    
                    // Calculate equipment cost
                    (item.equipment || []).forEach(e => {
                        const qty = parseFloat(e.quantity) || 1;
                        const cost = qty * (parseFloat(e.hours) || 0) * (parseFloat(e.costPerHour) || 0);
                        existing.actualCost += cost;
                    });
                    
                    // Calculate subcontractor cost (uses net amount which includes expenses/deductions)
                    (item.subcontractor || []).forEach(s => {
                        if (s.companyName) {
                            existing.subcontractors.push(s.companyName);
                        }
                        // Use net amount (already calculated: qty Ã rate + expenses - deductions)
                        const amount = parseFloat(s.amount) || 0;
                        existing.actualCost += amount;
                    });
                });
            });
            
            if (itemsMap.size === 0) {
                showNotification('No work items found in daily reports for this period.', 'error');
                return;
            }
            
            // Clear existing progress items and add imported ones
            const container = document.getElementById('progressItemsContainer');
            container.innerHTML = '';
            progressItemCount = 0;
            
            itemsMap.forEach((item, key) => {
                addProgressItem();
                const index = progressItemCount - 1;
                const card = document.querySelector(`.progress-item-card[data-progress-index="${index}"]`);
                
                if (card) {
                    card.querySelector(`input[name="progressItems[${index}].itemCode"]`).value = item.itemCode;
                    card.querySelector(`input[name="progressItems[${index}].itemDescription"]`).value = item.itemDescription;
                    card.querySelector(`input[name="progressItems[${index}].completedQtyDaily"]`).value = item.completedQty || '';
                    // Populate AC (Daily Reports) field - read-only auto-imported value
                    card.querySelector(`input[name="progressItems[${index}].actualCostDaily"]`).value = item.actualCost.toFixed(2);
                    
                    // Set subcontractor if exists
                    if (item.subcontractors.length > 0) {
                        const toggle = card.querySelector('.toggle-switch input');
                        if (toggle) {
                            toggle.checked = true;
                            toggleProgressSubcontractor(index, true);
                            card.querySelector(`input[name="progressItems[${index}].subcontractorName"]`).value = item.subcontractors.join(', ');
                        }
                    }
                    
                    calculateProgressItem(index);
                }
            });
            
            showNotification(`Imported ${itemsMap.size} items from ${filteredSubmissions.length} daily reports (${weekStart} to ${weekEnd}) â`, 'success');
        }

        function calculateWeeklyProgress() {
            // Legacy function - redirect to new calculation
            updateWeeklySummary();
        }

        function calculateEVM() {
            const BAC = parseFloat(document.querySelector('input[name="BAC"]').value) || 0;
            const AC = parseFloat(document.querySelector('input[name="AC"]').value) || 0;
            const EV = parseFloat(document.querySelector('input[name="EV"]').value) || 0;
            const PV = parseFloat(document.querySelector('input[name="PV"]').value) || 0;

            if (BAC === 0 || AC === 0 || EV === 0 || PV === 0) {
                document.getElementById('evmCalculations').classList.remove('show');
                return;
            }

            const CV = EV - AC;
            const SV = EV - PV;
            const CPI = EV / AC;
            const SPI = EV / PV;
            const EAC = BAC / CPI;
            const ETC = EAC - AC;

            document.getElementById('evmCalculations').classList.add('show');
            updateCalcItem('cpiCalc', CPI.toFixed(2), CPI >= 1 ? 'good' : CPI >= 0.9 ? 'warning' : 'bad');
            updateCalcItem('spiCalc', SPI.toFixed(2), SPI >= 1 ? 'good' : SPI >= 0.9 ? 'warning' : 'bad');
            updateCalcItem('cvCalc', formatNumber(CV), CV >= 0 ? 'good' : 'bad');
            updateCalcItem('svCalc', formatNumber(SV), SV >= 0 ? 'good' : 'bad');
            updateCalcItem('eacCalc', formatNumber(EAC), EAC <= BAC ? 'good' : 'bad');
            updateCalcItem('etcCalc', formatNumber(ETC), 'good');
        }

        function updateCalcItem(id, value, status) {
            const el = document.getElementById(id);
            el.querySelector('.value').textContent = value;
            el.className = 'calc-item ' + status;
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function generateCrewLink() {
            try {
                const form = document.getElementById('dailyForm');
                if (!form) {
                    showNotification('Form not found', 'error');
                    return;
                }
                
                const projectCode = form.querySelector('input[name="projectCode"]').value.trim();
                const projectName = form.querySelector('input[name="projectName"]').value.trim();
                const reportDate = form.querySelector('input[name="reportDate"]').value;

                if (!projectCode || !projectName || !reportDate) {
                    showNotification('Please fill in Project Code, Project Name, and Report Date first', 'error');
                    return;
                }

                // Get link options
                const validityHours = parseInt(document.getElementById('linkValidityHours').value) || 24;
                const maxUsers = document.getElementById('linkMaxUsers').value;
                
                // Calculate expiry time
                const now = new Date();
                const expiryTime = new Date(now.getTime() + (validityHours * 60 * 60 * 1000));
                
                // Generate unique link ID
                const linkId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
                
                const crewData = {
                    projectCode: projectCode,
                    projectName: projectName,
                    reportDate: reportDate,
                    linkId: linkId,
                    expiresAt: expiryTime.toISOString(),
                    maxUsers: maxUsers,
                    usedCount: 0,
                    createdAt: now.toISOString()
                };
                
                // Store link metadata in localStorage
                const linkMetaKey = `crewLink_${linkId}`;
                localStorage.setItem(linkMetaKey, JSON.stringify({
                    expiresAt: expiryTime.toISOString(),
                    maxUsers: maxUsers,
                    usedCount: 0,
                    createdAt: now.toISOString()
                }));

                // Encode data safely
                const jsonString = JSON.stringify(crewData);
                const encodedData = btoa(unescape(encodeURIComponent(jsonString)));
                
                // Get current URL base
                let currentUrl = window.location.href.split('?')[0].split('#')[0];
                
                // Check for invalid URL schemes (iframe, srcdoc, blob, etc.)
                if (currentUrl.startsWith('about:') || currentUrl.startsWith('blob:') || currentUrl.startsWith('data:')) {
                    // Show the crew parameter separately for manual use
                    document.getElementById('crewLinkInput').value = `?crew=${encodedData}`;
                    document.getElementById('generatedLink').classList.add('show');
                    showNotification('â ï¸ Download the HTML file first, then open it directly in browser to generate shareable links.', 'error');
                    return;
                }
                
                // Update link info display
                const expiryStr = expiryTime.toLocaleString('en-US', { 
                    dateStyle: 'medium', 
                    timeStyle: 'short' 
                });
                document.getElementById('linkExpiryTime').textContent = expiryStr;
                document.getElementById('linkMaxUsersDisplay').textContent = maxUsers === 'unlimited' ? 'Unlimited' : maxUsers;
                document.getElementById('linkUsedCount').textContent = '0';
                
                // If it's a file:// URL, inform the user
                if (currentUrl.startsWith('file://')) {
                    // Still generate the link but with a note
                    const crewLink = `${currentUrl}?crew=${encodedData}`;
                    document.getElementById('crewLinkInput').value = crewLink;
                    document.getElementById('generatedLink').classList.add('show');
                    showNotification('Link generated! Valid for ' + validityHours + ' hours. Note: For remote sharing, host this file on a web server.', 'success');
                } else {
                    const crewLink = `${currentUrl}?crew=${encodedData}`;
                    document.getElementById('crewLinkInput').value = crewLink;
                    document.getElementById('generatedLink').classList.add('show');
                    showNotification('Link generated! â Valid for ' + validityHours + ' hours, max ' + (maxUsers === 'unlimited' ? 'unlimited' : maxUsers) + ' users', 'success');
                }
            } catch (error) {
                console.error('Error generating crew link:', error);
                showNotification('Error generating link: ' + error.message, 'error');
            }
        }

        function copyCrewLink() {
            const linkInput = document.getElementById('crewLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile
            
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(linkInput.value).then(() => {
                        showNotification('Link copied to clipboard! â', 'success');
                    }).catch(() => {
                        // Fallback to execCommand
                        document.execCommand('copy');
                        showNotification('Link copied to clipboard! â', 'success');
                    });
                } else {
                    document.execCommand('copy');
                    showNotification('Link copied to clipboard! â', 'success');
                }
            } catch (err) {
                showNotification('Failed to copy. Please select and copy manually.', 'error');
            }
        }

        document.getElementById('dailyForm').addEventListener('submit', (e) => submitForm(e, 'daily-report'));
        document.getElementById('weeklyForm').addEventListener('submit', (e) => submitForm(e, 'weekly-report'));
        document.getElementById('monthlyForm').addEventListener('submit', (e) => submitForm(e, 'monthly-report'));
        document.getElementById('crewForm').addEventListener('submit', (e) => submitForm(e, 'crew-report'));

        async function submitForm(e, endpoint) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (key.includes('[')) {
                    const matches = key.match(/(\w+)\[(\d+)\]\.(\w+)/);
                    if (matches) {
                        const [, arrayName, index, field] = matches;
                        if (!data[arrayName]) data[arrayName] = [];
                        if (!data[arrayName][index]) data[arrayName][index] = {};
                        data[arrayName][index][field] = value;
                    }
                } else {
                    data[key] = value;
                }
            }
            
            // Clean up arrays
            if (data.equipment) data.equipment = data.equipment.filter(Boolean);
            if (data.subcontractors) data.subcontractors = data.subcontractors.filter(Boolean);
            if (data.materials) data.materials = data.materials.filter(Boolean);
            if (data.manpower) data.manpower = data.manpower.filter(Boolean);
            if (data.crewManpower) data.crewManpower = data.crewManpower.filter(Boolean);
            if (data.crewEquipment) data.crewEquipment = data.crewEquipment.filter(Boolean);
            
            // Add location data based on type
            const locationType = form.querySelector('input[name="locationType"]:checked') || 
                                form.querySelector('input[name="crewLocationType"]:checked');
            if (locationType) {
                data.locationType = locationType.value;
            }
            
            // Special handling for crew reports - save to localStorage
            if (endpoint === 'crew-report') {
                const submitBtn = form.querySelector('.submit-btn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span>â³</span> Submitting...';
                
                try {
                    // Save crew submission to localStorage
                    saveCrewSubmission(data);
                    showNotification('Crew data submitted successfully! â The project manager will see your data.', 'success');
                    form.reset();
                    
                    // Reset the form to default state
                    const today = new Date().toISOString().split('T')[0];
                    form.querySelectorAll('input[type="date"]').forEach(input => input.value = today);
                    document.getElementById('crewTotalValue').textContent = '0 SAR';
                    
                } catch (error) {
                    console.error('Error saving crew data:', error);
                    showNotification('Error saving data: ' + error.message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>ð¤</span> Submit Crew Data';
                }
                return;
            }
            
            const webhookUrl = localStorage.getItem('webhookUrl') || '';
            const apiKey = localStorage.getItem('apiKey') || '';
            
            if (!webhookUrl) {
                showNotification('Please configure Webhook URL in Settings', 'error');
                return;
            }

            const submitBtn = form.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>â³</span> Submitting...';

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (apiKey) headers['X-API-Key'] = apiKey;
                
                let finalUrl = webhookUrl;
                
                if (webhookUrl.includes('construction-pm/' + endpoint)) {
                    finalUrl = webhookUrl;
                }
                else if (webhookUrl.endsWith('/webhook/')) {
                    finalUrl = `${webhookUrl}construction-pm/${endpoint}`;
                }
                else if (webhookUrl.endsWith('/webhook')) {
                    finalUrl = `${webhookUrl}/construction-pm/${endpoint}`;
                }
                else if (webhookUrl.includes('/webhook/')) {
                    const baseUrl = webhookUrl.substring(0, webhookUrl.indexOf('/webhook/') + 9);
                    finalUrl = `${baseUrl}construction-pm/${endpoint}`;
                }
                else {
                    finalUrl = `${webhookUrl}${webhookUrl.endsWith('/') ? '' : '/'}construction-pm/${endpoint}`;
                }
                
                console.log('Submitting to:', finalUrl);
                
                const response = await fetch(finalUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    showNotification(`Report submitted successfully â ${result.reportId ? '(ID: ' + result.reportId + ')' : ''}`, 'success');
                    form.reset();
                    const today = new Date().toISOString().split('T')[0];
                    form.querySelectorAll('input[type="date"]').forEach(input => input.value = today);
                    
                    // Reset generated link
                    document.getElementById('generatedLink')?.classList.remove('show');
                } else {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('Server response:', response.status, errorText);
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('Submission error:', error);
                let errorMsg = 'Failed to submit report â';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = 'Network error - Check your webhook URL and make sure n8n workflow is active â';
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMsg = 'Authentication failed - Check your API Key â';
                } else if (error.message.includes('404')) {
                    errorMsg = 'Webhook not found - Verify your n8n webhook URL â';
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'CORS error - n8n workflow may need CORS headers configured â';
                }
                showNotification(errorMsg, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>ð¤</span> Submit Report';
            }
        }

        function saveConfig() {
            localStorage.setItem('webhookUrl', document.getElementById('webhookUrl').value);
            localStorage.setItem('telegramChatId', document.getElementById('telegramChatId').value);
            localStorage.setItem('apiKey', document.getElementById('apiKey').value);
            
            // Save Supabase settings
            const supabaseUrl = document.getElementById('supabaseUrl');
            const supabaseAnonKey = document.getElementById('supabaseAnonKey');
            if (supabaseUrl) localStorage.setItem('supabaseUrl', supabaseUrl.value);
            if (supabaseAnonKey) localStorage.setItem('supabaseAnonKey', supabaseAnonKey.value);
            
            // Reinitialize Supabase if settings changed
            if (supabaseUrl?.value && supabaseAnonKey?.value) {
                initSupabase();
            }
            
            showNotification('Settings saved successfully â', 'success');
        }

        function loadConfig() {
            const webhookUrlEl = document.getElementById('webhookUrl');
            const telegramChatIdEl = document.getElementById('telegramChatId');
            const apiKeyEl = document.getElementById('apiKey');
            const supabaseUrlEl = document.getElementById('supabaseUrl');
            const supabaseAnonKeyEl = document.getElementById('supabaseAnonKey');
            
            if (webhookUrlEl) webhookUrlEl.value = localStorage.getItem('webhookUrl') || '';
            if (telegramChatIdEl) telegramChatIdEl.value = localStorage.getItem('telegramChatId') || '';
            if (apiKeyEl) apiKeyEl.value = localStorage.getItem('apiKey') || '';
            if (supabaseUrlEl) supabaseUrlEl.value = localStorage.getItem('supabaseUrl') || '';
            if (supabaseAnonKeyEl) supabaseAnonKeyEl.value = localStorage.getItem('supabaseAnonKey') || '';
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, 4000);
        }
    </script>
</body>
</html>
